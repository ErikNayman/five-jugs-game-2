<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовая Гонка: Кризис и Сложность</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; overflow-x: hidden; }

        /* Jar Styles */
        .jar-container {
            position: relative;
            height: 280px;
            background-color: #E2E8F0;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            border: 1px solid #CBD5E1;
            border-top: none;
            cursor: ns-resize;
            touch-action: none;
            transition: border-color 0.2s;
        }
        .jar-container:hover { border-color: #94A3B8; }
        .jar-liquid {
            position: absolute; bottom: 0; left: 0; right: 0;
            transition: height 0.1s linear; pointer-events: none;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }
        .jar-surface {
            position: absolute; top: 0; left: 0; right: 0; height: 0;
            border-top: 2px solid rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center;
        }
        .jar-handle {
            width: 24px; height: 24px; background-color: white; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); transform: translateY(-50%);
            display: flex; align-items: center; justify-content: center;
            color: #64748B; font-size: 10px; transition: transform 0.1s;
        }
        .jar-container:hover .jar-handle { transform: translateY(-50%) scale(1.15); }
        
        /* Sidebar */
        .report-panel {
            position: fixed;
            z-index: 40;
            background: white;
            box-shadow: -5px 0 25px rgba(0,0,0,0.1);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @media (min-width: 768px) {
            .report-panel { top: 80px; right: 0; bottom: 0; width: 350px; border-left: 1px solid #E2E8F0; transform: translateX(100%); }
            .report-panel.open { transform: translateX(0); }
        }
        @media (max-width: 767px) {
            .report-panel { left: 0; right: 0; bottom: 0; height: auto; max-height: 85vh; border-radius: 20px 20px 0 0; transform: translateY(100%); padding-bottom: 20px; }
            .report-panel.open { transform: translateY(0); }
        }

        .jars-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        @media (min-width: 768px) { .jars-grid { grid-template-columns: repeat(5, 1fr); gap: 1rem; } }

        .game-over-overlay { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 100; }
        .btn-pulse { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(244, 63, 94, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0); } }
        
        .critical-pulse { animation: critical-pulse 1.5s infinite; }
        @keyframes critical-pulse { 0%, 100% { color: #f43f5e; transform: scale(1); } 50% { color: #e11d48; transform: scale(1.2); } }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 select-none pb-24 md:pb-0">

    <!-- HEADER -->
    <header class="bg-slate-900 text-white sticky top-0 z-50 shadow-xl border-b border-slate-700 transition-colors duration-500" id="mainHeader">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                
                <!-- Left: Rival Status -->
                <div class="flex items-center gap-6 w-full md:w-auto">
                    <div>
                        <div class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Гонка</div>
                        <div id="rivalStatusText" class="text-xs font-bold text-slate-300 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Вы лидируете
                        </div>
                    </div>
                    <div class="pl-6 border-l border-slate-700">
                        <div class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Время</div>
                        <div class="text-sm font-bold">Месяц <span id="monthCount">1</span></div>
                    </div>
                    <div class="pl-6 border-l border-slate-700 hidden sm:block">
                        <div class="text-[9px] uppercase font-bold text-slate-400 tracking-wider">Пассив</div>
                        <div class="text-sm font-bold text-emerald-300 flex items-center gap-1">
                            <span id="passiveIncomeVal">$0</span>
                            <span class="text-[10px] text-slate-400 font-normal">/мес</span>
                        </div>
                    </div>
                </div>

                <!-- Center: Vitals -->
                <div class="flex gap-4 w-full md:w-auto bg-slate-800/50 px-4 py-2 rounded-xl border border-slate-700 relative overflow-hidden justify-center">
                    <div class="flex flex-col w-24 relative z-10">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] uppercase font-bold text-slate-400">Здоровье</span>
                            <span id="hudHealthVal" class="text-[10px] font-bold text-white">100%</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                            <div id="hudHealthBar" class="bg-rose-500 h-full rounded-full transition-all duration-300" style="width: 100%"></div>
                        </div>
                        <div id="healthPrediction" class="text-[9px] h-3 mt-0.5 font-medium transition-colors duration-300 flex items-center gap-1 justify-end">Стабильно</div>
                    </div>
                    <div class="flex flex-col w-24 border-l border-slate-700 pl-4 relative z-10">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] uppercase font-bold text-slate-400">Счастье</span>
                            <span id="hudHappyVal" class="text-[10px] font-bold text-white">100%</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                            <div id="hudHappyBar" class="bg-amber-400 h-full rounded-full transition-all duration-300" style="width: 100%"></div>
                        </div>
                        <div id="happyPrediction" class="text-[9px] h-3 mt-0.5 font-medium transition-colors duration-300 flex items-center gap-1 justify-end">Стабильно</div>
                    </div>
                </div>

                <!-- Right: Action -->
                <div class="flex items-center gap-4 w-full md:w-auto justify-end">
                    <div class="text-right hidden lg:block">
                        <div class="text-[9px] text-slate-400 uppercase tracking-widest">Капитал</div>
                        <div id="hudNetWorth" class="font-mono font-bold text-lg text-emerald-400">$0</div>
                    </div>
                    <button id="nextMonthBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-emerald-900/40 transform active:scale-95 transition-all flex items-center gap-2 text-xs uppercase tracking-wide">
                        <span>Прожить Месяц</span>
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 py-6 space-y-6 md:pr-4 lg:pr-8 transition-all duration-300" id="mainContent">

        <!-- DASHBOARD -->
        <section class="grid grid-cols-1 md:grid-cols-12 gap-4">
            
            <!-- Income Panel -->
            <div class="md:col-span-4 lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-between h-56">
                <div>
                    <div class="flex justify-between items-baseline mb-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Зарплата</label>
                        <div id="incomePenaltyBox" class="hidden text-[9px] text-rose-600 font-bold bg-rose-50 px-1.5 rounded flex items-center gap-1">
                            <i class="fa-solid fa-triangle-exclamation"></i> Штраф
                        </div>
                    </div>
                    <div class="relative group mb-1">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold group-focus-within:text-emerald-500 text-sm">$</span>
                        <input type="number" id="incomeInput" value="4000" class="w-full pl-6 pr-3 py-1.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none font-bold text-slate-800 text-base transition-all">
                    </div>
                    <div class="flex justify-between text-xs font-bold text-slate-500 mt-1 pb-2 border-b border-slate-100">
                        <span>На руки:</span>
                        <span id="realIncomeVal" class="text-emerald-600">$4,000</span>
                    </div>
                    <div class="mt-2 text-[9px] text-slate-400 flex flex-col gap-1">
                        <div class="flex justify-between"><span>Сбережения (4%):</span><span class="text-emerald-500 font-bold" id="savingsInterestText">+$0</span></div>
                        <div class="flex justify-between"><span>Инвестиции (10%):</span><span class="text-indigo-500 font-bold" id="investmentInterestText">+$0</span></div>
                        <div class="flex justify-between mt-1 pt-1 border-t border-slate-100"><span>Рост зарплаты:</span><span class="text-blue-500 font-bold">+5% вклада</span></div>
                    </div>
                </div>
                
                <div id="debtRepayContainer" class="hidden mt-1 pt-1 border-t border-slate-100">
                    <button id="repayDebtBtn" class="w-full bg-rose-50 hover:bg-rose-100 text-rose-600 font-bold py-1.5 rounded-lg border border-rose-200 text-xs transition-colors flex items-center justify-center gap-1 btn-pulse">
                        <i class="fa-solid fa-fire"></i> Погасить: <span id="currentDebtVal">$0</span>
                    </button>
                </div>

                <div class="mt-auto pt-2 flex items-center justify-between">
                    <div><div class="text-[9px] font-bold text-slate-400 uppercase">Баланс</div><div id="balanceBadge" class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-500 inline-block mt-0.5">OK</div></div>
                    <div class="text-right"><div class="flex items-baseline gap-0.5 justify-end"><span id="totalPercent" class="text-2xl font-black text-slate-800">100</span><span class="text-xs font-bold text-slate-400">%</span></div></div>
                </div>
            </div>

            <!-- VS Chart -->
            <div class="md:col-span-8 lg:col-span-9 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 relative flex flex-col h-56">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase">Гонка Капиталов</h3>
                        <div class="text-xs text-slate-500">Вы (Зеленый) vs Джон (Серый)</div>
                    </div>
                    <div class="text-right text-[10px]">
                        <div class="flex items-center gap-1 justify-end"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> <span>Вы</span></div>
                        <div class="flex items-center gap-1 justify-end"><span class="w-2 h-2 rounded-full bg-slate-400"></span> <span>Джон (Сберегает 15% + 5% доход)</span></div>
                    </div>
                </div>
                <div class="flex-grow w-full relative h-48">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Jars -->
        <section>
            <div class="flex items-center gap-2 mb-3 px-1">
                <i class="fa-solid fa-hand-pointer text-slate-400 animate-bounce text-sm"></i>
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Распределение бюджета</h2>
            </div>
            <div class="jars-grid" id="jarsContainer"></div>
        </section>

    </main>

    <!-- REPORT SIDEBAR -->
    <div id="reportPanel" class="report-panel flex flex-col">
        <div class="w-full flex justify-center pt-3 pb-1 md:hidden"><div class="w-12 h-1.5 bg-slate-300 rounded-full"></div></div>
        <div class="p-5 flex-grow overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <div><div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Отчет</div><h2 class="text-xl font-bold text-slate-800">Месяц <span id="reportMonthNum">1</span></h2></div>
                <button onclick="closeReport()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div id="criticalWarnings" class="space-y-3 mb-4"></div>

            <!-- Rival Comparison Card -->
            <div class="bg-slate-800 text-white p-4 rounded-xl mb-4 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Сравнение</div>
                    <div class="flex justify-between items-end mb-2">
                        <div><div class="text-xs opacity-70">Ваш капитал</div><div class="font-bold text-emerald-400 text-lg" id="compUserNet">$0</div></div>
                        <div class="text-right"><div class="text-xs opacity-70">Джон</div><div class="font-bold text-slate-300 text-lg" id="compRivalNet">$0</div></div>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-1.5 mb-1 overflow-hidden">
                        <div id="compBar" class="bg-emerald-500 h-full transition-all duration-500" style="width: 50%"></div>
                    </div>
                    <div id="compText" class="text-[10px] text-center italic text-slate-400">Вы идете вровень</div>
                </div>
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl"></div>
            </div>

            <div id="eventCard" class="hidden bg-slate-50 border-l-4 border-indigo-500 p-4 rounded-r-xl mb-4 shadow-sm">
                <div class="flex items-center gap-2 mb-1" id="eventHeader"></div>
                <p id="eventText" class="text-xs text-slate-600 leading-relaxed"></p>
            </div>

            <div class="space-y-3 mb-4">
                <div class="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl shadow-sm"><div class="text-xs text-slate-500">Активные накопления</div><div class="font-bold text-slate-700" id="reportActiveGain">+$0</div></div>
                <div class="flex justify-between items-center p-3 bg-emerald-50 border border-emerald-100 rounded-xl"><div class="text-xs text-emerald-700 font-bold flex items-center gap-1"><i class="fa-solid fa-seedling"></i> Пассивный доход</div><div class="font-bold text-emerald-700" id="reportPassiveGain">+$0</div></div>
                <div class="flex justify-between items-center p-3 bg-blue-50 border border-blue-100 rounded-xl"><div class="text-xs text-blue-700 font-bold flex items-center gap-1"><i class="fa-solid fa-arrow-up"></i> Рост Зарплаты</div><div class="font-bold text-blue-700" id="reportSalaryGrowth">+$0</div></div>
                <div id="reportDebtRow" class="hidden flex justify-between items-center p-3 bg-rose-50 border border-rose-100 rounded-xl"><div class="text-xs text-rose-700 font-bold">Проценты по кредиту</div><div class="font-bold text-rose-700" id="reportDebtLoss">-$0</div></div>
            </div>

            <div class="text-center mb-4">
                <div class="text-[10px] uppercase font-bold text-slate-400">Итоговый капитал</div>
                <div class="text-3xl font-black text-slate-800 tracking-tight" id="reportNetWorth">$0</div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="text-center"><div class="text-[10px] text-slate-400 uppercase font-bold mb-1">Здоровье</div><div id="reportHealthChange" class="font-bold text-sm">0%</div></div>
                <div class="text-center border-l border-slate-100"><div class="text-[10px] text-slate-400 uppercase font-bold mb-1">Счастье</div><div id="reportHappyChange" class="font-bold text-sm">0%</div></div>
            </div>
            
            <div id="reportFeedback" class="mt-6 text-xs text-center text-slate-400 italic"></div>
        </div>
        <div class="p-4 border-t border-slate-100 bg-white"><button onclick="closeReport()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">Далее</button></div>
    </div>

    <div id="mobileOverlay" onclick="closeReport()" class="fixed inset-0 bg-black/20 z-30 hidden md:hidden transition-opacity opacity-0"></div>

    <div id="gameOverScreen" class="fixed inset-0 z-[100] game-over-overlay hidden flex flex-col items-center justify-center text-white p-6 text-center opacity-0 transition-opacity duration-1000">
        <div class="w-20 h-20 rounded-full bg-rose-600 flex items-center justify-center text-3xl mb-4 shadow-[0_0_30px_rgba(225,29,72,0.6)] animate-pulse"><i id="deathIcon" class="fa-solid fa-skull"></i></div>
        <h1 class="text-3xl font-black mb-1">ИГРА ОКОНЧЕНА</h1>
        <p id="deathReason" class="text-lg text-rose-300 font-medium mb-6 max-w-sm text-sm">Причина...</p>
        <button onclick="location.reload()" class="bg-white text-slate-900 hover:bg-slate-200 font-bold py-2.5 px-8 rounded-full text-sm uppercase transition hover:scale-105 shadow-xl">Заново</button>
    </div>

    <script>
        const CONFIG = { phase1Goal: 5000, phase2Goal: 1000, baseIncome: 4000, rates: { savings: 0.04, investments: 0.10, debt: 0.15 } };
        const JARS = [
            { id: 'nec', name: 'Необходимое', def: 60, color: '#64748B', liquid: '#94A3B8', icon: 'fa-house', type: 'exp' }, 
            { id: 'sav', name: 'Сбережения', def: 10, color: '#10B981', liquid: '#34D399', icon: 'fa-piggy-bank', type: 'save' }, 
            { id: 'inv', name: 'Инвестиции', def: 10, color: '#6366F1', liquid: '#818CF8', icon: 'fa-chart-line', type: 'invest' }, 
            { id: 'edu', name: 'Образование', def: 10, color: '#3B82F6', liquid: '#60A5FA', icon: 'fa-book', type: 'exp' }, 
            { id: 'fun', name: 'Развлечения', def: 10, color: '#F59E0B', liquid: '#FBBF24', icon: 'fa-champagne-glasses', type: 'exp' }
        ];
        // Updated EVENTS with Crisis
        const EVENTS = [
            { text: "Срочный ремонт зубов.", effect: { money: -400, health: 5 }, type: 'bad', icon: 'fa-tooth' },
            { text: "Грипп свалил с ног.", effect: { money: -100, health: -15 }, type: 'bad', icon: 'fa-temperature-arrow-up' },
            { text: "Нашел $200 в старой куртке!", effect: { money: 200 }, type: 'good', icon: 'fa-money-bill-1-wave' },
            { text: "Премия за проект!", effect: { money: 600, happy: 10 }, type: 'good', icon: 'fa-trophy' },
            { text: "Скачок инфляции. Цены выросли.", effect: { money: -150 }, type: 'bad', icon: 'fa-arrow-trend-up' },
            { text: "Выгорание на работе.", effect: { health: -5, happy: -20 }, type: 'bad', icon: 'fa-battery-empty' },
            // New CRISIS Event
            { text: "КРИЗИС! Обвал фондового рынка на 25%!", effect: { crash: 0.25 }, type: 'crash', icon: 'fa-chart-line-down' },
            { text: "Коррекция рынка. Акции упали на 10%.", effect: { crash: 0.10 }, type: 'bad', icon: 'fa-arrow-trend-down' }
        ];

        let state = { month: 1, phase: 1, savings: 0, investments: 0, debt: 0, baseIncome: CONFIG.baseIncome, allocations: {}, health: 100, happiness: 100, history: { labels: [], data: [], rivalData: [] }, rivalNetWorth: 0, isDead: false };
        JARS.forEach(j => state.allocations[j.id] = j.def);
        let els = {}, chartInstance = null, isDragging = false, currentDragJarId = null;

        function init() {
            els = {
                jars: document.getElementById('jarsContainer'),
                income: document.getElementById('incomeInput'),
                realIncomeVal: document.getElementById('realIncomeVal'),
                penaltyBox: document.getElementById('incomePenaltyBox'),
                hudHealthBar: document.getElementById('hudHealthBar'),
                hudHealthVal: document.getElementById('hudHealthVal'),
                healthPrediction: document.getElementById('healthPrediction'),
                hudHappyBar: document.getElementById('hudHappyBar'),
                hudHappyVal: document.getElementById('hudHappyVal'),
                happyPrediction: document.getElementById('happyPrediction'),
                hudNetWorth: document.getElementById('hudNetWorth'),
                passiveIncomeVal: document.getElementById('passiveIncomeVal'),
                savingsInterestText: document.getElementById('savingsInterestText'),
                investmentInterestText: document.getElementById('investmentInterestText'),
                totalPercent: document.getElementById('totalPercent'),
                balanceBadge: document.getElementById('balanceBadge'),
                chartCanvas: document.getElementById('historyChart'),
                phaseGoalText: document.getElementById('phaseGoalText'),
                monthCount: document.getElementById('monthCount'),
                debtRepayContainer: document.getElementById('debtRepayContainer'),
                currentDebtVal: document.getElementById('currentDebtVal'),
                repayDebtBtn: document.getElementById('repayDebtBtn'),
                
                // Sidebar
                reportPanel: document.getElementById('reportPanel'),
                mobileOverlay: document.getElementById('mobileOverlay'),
                reportMonthNum: document.getElementById('reportMonthNum'),
                eventCard: document.getElementById('eventCard'),
                eventHeader: document.getElementById('eventHeader'),
                eventText: document.getElementById('eventText'),
                reportActiveGain: document.getElementById('reportActiveGain'),
                reportPassiveGain: document.getElementById('reportPassiveGain'),
                reportSalaryGrowth: document.getElementById('reportSalaryGrowth'),
                reportDebtRow: document.getElementById('reportDebtRow'),
                reportDebtLoss: document.getElementById('reportDebtLoss'),
                reportNetWorth: document.getElementById('reportNetWorth'),
                reportHealthChange: document.getElementById('reportHealthChange'),
                reportHappyChange: document.getElementById('reportHappyChange'),
                compUserNet: document.getElementById('compUserNet'),
                compRivalNet: document.getElementById('compRivalNet'),
                compBar: document.getElementById('compBar'),
                compText: document.getElementById('compText'),
                rivalStatusText: document.getElementById('rivalStatusText'),
                reportFeedback: document.getElementById('reportFeedback'),
                criticalWarnings: document.getElementById('criticalWarnings'),

                deathScreen: document.getElementById('gameOverScreen'),
                deathReason: document.getElementById('deathReason'),
                deathIcon: document.getElementById('deathIcon')
            };

            renderJars(); initChart(); updateUI();
            els.income.addEventListener('input', (e) => { state.baseIncome = Math.max(0, parseInt(e.target.value) || 0); updateUI(); });
            document.getElementById('nextMonthBtn').addEventListener('click', processTurn);
            if(els.repayDebtBtn) els.repayDebtBtn.addEventListener('click', repayDebt);
            window.addEventListener('mouseup', endDrag); window.addEventListener('touchend', endDrag);
            window.addEventListener('mousemove', onDragMove); window.addEventListener('touchmove', onDragMove, { passive: false });
        }

        function startDrag(jarId) { if(state.isDead) return; isDragging = true; currentDragJarId = jarId; }
        function endDrag() { isDragging = false; currentDragJarId = null; }
        function onDragMove(e) {
            if (!isDragging || !currentDragJarId) return;
            e.preventDefault();
            const container = document.getElementById(`jar-cont-${currentDragJarId}`);
            if (!container) return;
            const rect = container.getBoundingClientRect();
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let percent = ((rect.bottom - clientY) / rect.height) * 100;
            state.allocations[currentDragJarId] = Math.round(Math.max(0, Math.min(100, percent)));
            updateUI();
        }

        function renderJars() {
            if(!els.jars) return;
            els.jars.innerHTML = '';
            JARS.forEach(jar => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-64 select-none';
                card.innerHTML = `
                    <div class="p-2 bg-white z-10 border-b border-slate-100 pointer-events-none text-center">
                        <div class="flex justify-center items-center gap-1.5 mb-1">
                            <div class="w-5 h-5 rounded bg-slate-50 flex items-center justify-center text-[10px]" style="color:${jar.color}"><i class="fa-solid ${jar.icon}"></i></div>
                            <h3 class="font-bold text-slate-700 text-[10px] uppercase truncate">${jar.name}</h3>
                        </div>
                        <div class="flex justify-center items-baseline gap-1">
                            <span id="pct-${jar.id}" class="text-[10px] font-bold text-slate-400">0%</span>
                            <span id="val-${jar.id}" class="font-bold text-slate-800 text-xs">$0</span>
                        </div>
                    </div>
                    <div id="jar-cont-${jar.id}" class="jar-container flex-grow relative w-full group cursor-ns-resize bg-slate-50">
                        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#cbd5e1 1px, transparent 1px); background-size: 100% 20px;"></div>
                        <div id="liq-${jar.id}" class="jar-liquid w-full absolute bottom-0 transition-all duration-75 ease-out pointer-events-none" style="background-color: ${jar.liquid}; height: ${state.allocations[jar.id]}%;">
                             <div class="jar-surface absolute top-0 w-full h-0 border-t-2 border-white/50 flex justify-center"><div class="jar-handle w-5 h-5 bg-white rounded-full shadow-md flex items-center justify-center -translate-y-1/2 text-slate-400 text-[8px] group-hover:scale-110 transition-transform"><i class="fa-solid fa-grip-lines"></i></div></div>
                        </div>
                    </div>`;
                els.jars.appendChild(card);
                const cont = card.querySelector('.jar-container');
                cont.addEventListener('mousedown', () => startDrag(jar.id));
                cont.addEventListener('touchstart', (e) => { startDrag(jar.id); onDragMove(e); }, { passive: false });
            });
        }

        function calculateRealIncome() {
            let penalty = 0;
            if (state.health < 50) penalty += (50 - state.health) * 0.015; 
            if (state.happiness < 50) penalty += (50 - state.happiness) * 0.01;
            penalty = Math.min(0.9, penalty);
            return { realIncome: Math.floor(state.baseIncome * (1 - penalty)), penaltyAmount: state.baseIncome - Math.floor(state.baseIncome * (1 - penalty)), penaltyPct: penalty };
        }
        function calculateBalance() { const total = Object.values(state.allocations).reduce((a,b)=>a+b,0); return { total, balance: 100 - total }; }
        function calculatePassiveIncome() { return { savIncome: state.savings * (CONFIG.rates.savings / 12), invIncome: state.investments * (CONFIG.rates.investments / 12), debtCost: state.debt * (CONFIG.rates.debt / 12), totalPassive: (state.savings * (CONFIG.rates.savings / 12)) + (state.investments * (CONFIG.rates.investments / 12)) }; }
        function getPrediction() {
            const nec = state.allocations.nec; const fun = state.allocations.fun; const edu = state.allocations.edu;
            let hPred = "Стаб.", hClass = "text-slate-400"; if(nec<40){hPred="Падает";hClass="text-rose-600 font-bold";} else if(nec<55){hPred="Сниж.";hClass="text-rose-500 font-bold";} else if(nec>65){hPred="Растет";hClass="text-emerald-500 font-bold";}
            let hapPred = "Стаб.", hapClass = "text-slate-400"; if((fun+edu)<15){hapPred="Падает";hapClass="text-rose-600 font-bold";} else if((fun+edu)<25){hapPred="Сниж.";hapClass="text-rose-500 font-bold";} else if((fun+edu)>35){hapPred="Растет";hapClass="text-emerald-500 font-bold";}
            return { hPred, hClass, hapPred, hapClass };
        }
        function repayDebt() {
            if (state.debt <= 0 || state.savings <= 0) return;
            let amount = Math.min(state.debt, state.savings); state.debt -= amount; state.savings -= amount;
            updateUI(); updateChart(state.savings + state.investments - state.debt, state.rivalNetWorth);
        }

        function updateUI() {
            if(!els.jars) return;
            const inc = calculateRealIncome(), pas = calculatePassiveIncome(), bal = calculateBalance(), pred = getPrediction();
            if (state.debt > 5 && state.savings > 5) { els.debtRepayContainer.classList.remove('hidden'); els.currentDebtVal.innerText = '-$' + Math.floor(state.debt).toLocaleString(); } else els.debtRepayContainer.classList.add('hidden');
            els.realIncomeVal.innerText = '$' + inc.realIncome.toLocaleString(); els.realIncomeVal.className = inc.penaltyAmount > 0 ? "text-rose-600 font-bold" : "text-emerald-600 font-bold";
            els.penaltyBox.classList.toggle('hidden', inc.penaltyAmount <= 0);
            els.savingsInterestText.innerText = `+$${Math.floor(pas.savIncome)}/мес`; els.investmentInterestText.innerText = `+$${Math.floor(pas.invIncome)}/мес`;
            JARS.forEach(jar => { const pct = state.allocations[jar.id], amount = (inc.realIncome * pct) / 100; document.getElementById(`val-${jar.id}`).innerText = '$' + Math.floor(amount).toLocaleString(); document.getElementById(`pct-${jar.id}`).innerText = pct + '%'; const l = document.getElementById(`liq-${jar.id}`); if(l) l.style.height = pct + '%'; });
            els.healthPrediction.innerText = pred.hPred; els.healthPrediction.className = `text-[9px] h-3 mt-0.5 flex items-center gap-1 justify-end transition-all ${pred.hClass}`; els.happyPrediction.innerText = pred.hapPred; els.happyPrediction.className = `text-[9px] h-3 mt-0.5 flex items-center gap-1 justify-end transition-all ${pred.hapClass}`;
            els.hudHealthBar.style.width = state.health + '%'; els.hudHealthVal.innerText = Math.round(state.health) + '%'; els.hudHappyBar.style.width = state.happiness + '%'; els.hudHappyVal.innerText = Math.round(state.happiness) + '%';
            
            const net = state.savings + state.investments - state.debt;
            els.hudNetWorth.innerText = '$' + Math.floor(net).toLocaleString(); els.hudNetWorth.className = net < 0 ? "font-mono font-bold text-lg text-rose-500" : "font-mono font-bold text-lg text-emerald-400";
            els.passiveIncomeVal.innerText = '$' + Math.floor(pas.totalPassive).toLocaleString();
            
            if(els.rivalStatusText) {
                if(net > state.rivalNetWorth) els.rivalStatusText.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Вы лидируете';
                else els.rivalStatusText.innerHTML = '<span class="w-2 h-2 rounded-full bg-rose-500"></span> Отставание';
            }

            if(els.phaseGoalText) {
                if (state.phase === 1) els.phaseGoalText.innerHTML = `<span>Накопить $${CONFIG.phase1Goal.toLocaleString()}</span>`;
                else els.phaseGoalText.innerHTML = `<i class="fa-solid fa-crown text-amber-400"></i> <span class="text-amber-400">Пассив: $${CONFIG.phase2Goal.toLocaleString()}/мес</span>`;
            }
            
            els.totalPercent.innerText = bal.total;
            if(bal.balance > 0) { els.totalPercent.className = "text-2xl font-black text-emerald-500"; els.balanceBadge.innerText = `В долг/сбер +${bal.balance}%`; els.balanceBadge.className = "text-[9px] font-bold px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-600 uppercase"; }
            else if(bal.balance < 0) { els.totalPercent.className = "text-2xl font-black text-rose-500"; els.balanceBadge.innerText = `В долг ${bal.balance}%`; els.balanceBadge.className = "text-[9px] font-bold px-1.5 py-0.5 rounded bg-rose-100 text-rose-600 uppercase"; }
            else { els.totalPercent.className = "text-2xl font-black text-slate-800"; els.balanceBadge.innerText = "OK"; els.balanceBadge.className = "text-[9px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-500 uppercase"; }
        }

        function processTurn() {
            if(state.isDead || checkDeath()) return;
            const pred = getPrediction();
            if(pred.hClass.includes("rose-600")) state.health -= 12; else if(pred.hClass.includes("rose-500")) state.health -= 6; else state.health += 3;
            if(pred.hapClass.includes("rose-600")) state.happiness -= 12; else if(pred.hapClass.includes("rose-500")) state.happiness -= 6; else state.happiness += 3;
            state.health = Math.max(0, Math.min(100, state.health)); state.happiness = Math.max(0, Math.min(100, state.happiness));
            if (checkDeath()) return;

            let event = Math.random() < 0.35 ? EVENTS[Math.floor(Math.random()*EVENTS.length)] : null;
            
            // Handle CRISIS Effect logic
            if(event) {
                if(event.type === 'crash' || event.effect.crash) {
                    state.investments *= (1 - event.effect.crash); // Reduce investments
                }
                if(event.effect.health) state.health += event.effect.health;
                if(event.effect.happy) state.happiness += event.effect.happy;
                state.health = Math.max(0, Math.min(100, state.health)); state.happiness = Math.max(0, Math.min(100, state.happiness));
                if (checkDeath()) return;
            }

            const inc = calculateRealIncome(); const pas = calculatePassiveIncome();
            state.savings += pas.savIncome; state.investments += pas.invIncome; state.debt += pas.debtCost;
            let effInc = inc.realIncome; if(event && event.effect.money) effInc += event.effect.money;
            const bal = calculateBalance(), rem = (effInc * bal.balance) / 100;
            let addSav = (effInc * state.allocations.sav) / 100, addInv = (effInc * state.allocations.inv) / 100, addDebt = 0;
            const eduSpent = (effInc * state.allocations.edu) / 100, salaryInc = Math.floor(eduSpent * 0.05);
            state.baseIncome += salaryInc; els.income.value = state.baseIncome;

            if(rem > 0) { if (state.debt > 0) { if (state.debt >= rem) state.debt -= rem; else { const l = rem - state.debt; state.debt = 0; addSav += l; } } else addSav += rem; } else addDebt += Math.abs(rem);
            if(state.phase === 1) { addSav += addInv; addInv = 0; }
            state.savings += addSav; state.investments += addInv; state.debt += addDebt;

            // Updated Rival Logic (Harder Mode)
            // John saves 15% (0.15) and gets ~5% annual growth on his pile (simplified monthly)
            const rivalIncome = state.baseIncome; 
            const rivalSave = rivalIncome * 0.15; 
            state.rivalNetWorth += rivalSave; 
            state.rivalNetWorth *= 1.004; // ~5% APY compound for John

            if(state.phase === 1 && state.savings >= CONFIG.phase1Goal && state.debt <= 0) { state.phase = 2; document.getElementById('mainHeader').classList.add('border-amber-500', 'border-b-4'); }
            
            const net = state.savings + state.investments - state.debt;
            updateChart(net, state.rivalNetWorth);
            openReport(event, addSav + addInv - addDebt, pas, net, salaryInc, state.rivalNetWorth);
            state.month++; if(els.monthCount) els.monthCount.innerText = state.month;
            updateUI();
        }

        function checkDeath() { if (state.health <= 0) { triggerDeath("Истощение.", "fa-heart-crack"); return true; } if (state.happiness <= 0) { triggerDeath("Выгорание.", "fa-face-dizzy"); return true; } return false; }
        function triggerDeath(reason, icon) { state.isDead = true; document.getElementById('deathReason').innerText = reason; document.getElementById('deathIcon').className = `fa-solid ${icon}`; els.deathScreen.classList.remove('hidden'); setTimeout(() => els.deathScreen.classList.remove('opacity-0'), 50); }
        
        function initChart() {
            if(!els.chartCanvas) return;
            const ctx = els.chartCanvas.getContext('2d');
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: state.history.labels, datasets: [
                { label: 'Вы', data: state.history.data, borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, pointRadius: 2 },
                { label: 'Джон', data: state.history.rivalData, borderColor: '#94A3B8', borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0 }
            ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { borderDash: [4, 4], color: '#f1f5f9' } } } } });
            updateChart(0, 0);
        }
        function updateChart(val, rivalVal) { state.history.labels.push(state.month); state.history.data.push(val); state.history.rivalData.push(rivalVal); if(chartInstance) chartInstance.update(); }

        function openReport(event, actGain, pas, net, salGrow, rivalNet) {
            els.reportMonthNum.innerText = state.month;
            
            els.criticalWarnings.innerHTML = ''; 
            if (state.health < 35) { const w = document.createElement('div'); w.className = 'bg-rose-50 border border-rose-200 rounded-lg p-3 text-xs text-rose-800 critical-pulse'; w.innerHTML = `<strong><i class="fa-solid fa-heart-pulse"></i> Критическое здоровье!</strong><br>Увеличьте расходы на "Необходимое" (NEC) > 55%.`; els.criticalWarnings.appendChild(w); }
            if (state.happiness < 35) { const w = document.createElement('div'); w.className = 'bg-amber-50 border border-amber-200 rounded-lg p-3 text-xs text-amber-800 critical-pulse'; w.innerHTML = `<strong><i class="fa-solid fa-face-sad-tear"></i> Депрессия!</strong><br>Потратьте больше на "Развлечения" или "Образование".`; els.criticalWarnings.appendChild(w); }

            if(event) {
                els.eventCard.classList.remove('hidden');
                let iconHtml = event.type === 'good' ? '<i class="fa-solid fa-star text-emerald-500"></i> <span class="font-bold text-emerald-700">Удача</span>' : '<i class="fa-solid fa-triangle-exclamation text-rose-500"></i> <span class="font-bold text-rose-700">Событие</span>';
                if(event.type === 'crash') iconHtml = '<i class="fa-solid fa-chart-line-down text-rose-600"></i> <span class="font-bold text-rose-800">ОБВАЛ РЫНКА</span>';
                
                els.eventHeader.innerHTML = iconHtml;
                els.eventText.innerText = event.text;
                els.eventCard.className = `p-4 rounded-xl mb-4 shadow-sm border-l-4 ${event.type === 'good' ? 'bg-emerald-50 border-emerald-500' : event.type === 'crash' ? 'bg-rose-100 border-rose-600' : 'bg-rose-50 border-rose-500'}`;
            } else els.eventCard.classList.add('hidden');

            els.reportActiveGain.innerText = (actGain >= 0 ? '+' : '') + '$' + Math.floor(actGain).toLocaleString();
            els.reportPassiveGain.innerText = '+$' + Math.floor(pas.totalPassive).toLocaleString();
            els.reportSalaryGrowth.innerText = '+$' + Math.floor(salGrow).toLocaleString();
            if(pas.debtCost > 0) { els.reportDebtRow.classList.remove('hidden'); els.reportDebtLoss.innerText = '-$' + Math.floor(pas.debtCost).toLocaleString(); } else els.reportDebtRow.classList.add('hidden');
            
            if (els.reportNetWorth) els.reportNetWorth.innerText = '$' + Math.floor(net).toLocaleString();

            const hDiff = state.health - (state.lastHealth || 100); const hapDiff = state.happiness - (state.lastHappy || 100);
            els.reportHealthChange.innerHTML = `<i class="fa-solid fa-heart ${hDiff < 0 ? 'text-rose-500' : 'text-emerald-500'}"></i> ${hDiff > 0 ? '+' : ''}${Math.round(hDiff)}%`;
            els.reportHappyChange.innerHTML = `<i class="fa-solid fa-face-smile ${hapDiff < 0 ? 'text-rose-500' : 'text-emerald-500'}"></i> ${hapDiff > 0 ? '+' : ''}${Math.round(hapDiff)}%`;
            state.lastHealth = state.health; state.lastHappy = state.happiness;

            els.compUserNet.innerText = '$' + Math.floor(net).toLocaleString();
            els.compRivalNet.innerText = '$' + Math.floor(rivalNet).toLocaleString();
            const total = Math.max(net, rivalNet) * 1.5 || 100;
            els.compBar.style.width = Math.max(0, (net / total) * 100) + '%';
            if (net > rivalNet) els.compText.innerText = `Вы опережаете Джона на $${Math.floor(net - rivalNet).toLocaleString()}!`;
            else els.compText.innerText = `Вы отстаете на $${Math.floor(rivalNet - net).toLocaleString()}. Поднажмите!`;

            els.reportFeedback.innerText = "Анализ завершен.";

            els.reportPanel.classList.add('open');
            els.mobileOverlay.classList.remove('hidden');
            setTimeout(() => els.mobileOverlay.classList.remove('opacity-0'), 10);
        }

        window.closeReport = function() {
            els.reportPanel.classList.remove('open');
            els.mobileOverlay.classList.add('opacity-0');
            setTimeout(() => els.mobileOverlay.classList.add('hidden'), 300);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
