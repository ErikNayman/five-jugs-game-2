<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовая Гонка: Стабильный Интерфейс</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; overflow-x: hidden; }

        /* Jar Styles */
        .jar-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .jar-container {
            position: relative; height: 280px; background-color: #E2E8F0; border-radius: 0 0 12px 12px; overflow: hidden;
            border: 1px solid #CBD5E1; border-top: none; cursor: ns-resize; touch-action: none; transition: border-color 0.2s;
        }
        .jar-container:hover { border-color: #94A3B8; }
        .jar-liquid {
            position: absolute; bottom: 0; left: 0; right: 0;
            transition: height 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }
        .jar-surface {
            position: absolute; top: 0; left: 0; right: 0; height: 0;
            border-top: 2px solid rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center;
        }
        .jar-handle {
            width: 24px; height: 24px; background-color: white; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); transform: translateY(-50%);
            display: flex; align-items: center; justify-content: center;
            color: #64748B; font-size: 10px; transition: transform 0.1s;
        }
        .jar-container:hover .jar-handle { transform: translateY(-50%) scale(1.15); }
        
        /* Sidebar */
        .report-panel {
            position: fixed; z-index: 40; background: white; box-shadow: -5px 0 25px rgba(0,0,0,0.1);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @media (min-width: 768px) { .report-panel { top: 80px; right: 0; bottom: 0; width: 360px; border-left: 1px solid #E2E8F0; transform: translateX(100%); } .report-panel.open { transform: translateX(0); } }
        @media (max-width: 767px) { .report-panel { left: 0; right: 0; bottom: 0; height: auto; max-height: 85vh; border-radius: 20px 20px 0 0; transform: translateY(100%); padding-bottom: 20px; } .report-panel.open { transform: translateY(0); } }

        .jars-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        @media (min-width: 768px) { .jars-grid { grid-template-columns: repeat(5, 1fr); gap: 1rem; } }

        .game-over-overlay { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 100; }
        .btn-pulse { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(244, 63, 94, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0); } }
        
        .critical-pulse { animation: critical-pulse 1.5s infinite; }
        @keyframes critical-pulse { 0%, 100% { color: #f43f5e; transform: scale(1); } 50% { color: #e11d48; transform: scale(1.2); } }
        
        .highlight-jar { animation: highlight-bounce 2s ease-in-out infinite; box-shadow: 0 0 0 4px #F43F5E !important; border-color: #F43F5E !important; z-index: 20; }
        @keyframes highlight-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Custom Tooltip */
        .custom-tooltip {
            visibility: hidden; width: 220px; background-color: #1e293b; color: #fff; text-align: left; border-radius: 8px; padding: 10px;
            position: absolute; z-index: 50; bottom: 110%; left: 0; opacity: 0; transition: opacity 0.2s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); font-weight: normal; line-height: 1.4; border: 1px solid #475569;
        }
        .tooltip-container:hover .custom-tooltip { visibility: visible; opacity: 1; }

        /* Modal */
        .info-overlay { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(3px); z-index: 80; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 select-none pb-24 md:pb-0">

    <!-- HEADER -->
    <header class="bg-slate-900 text-white sticky top-0 z-50 shadow-xl border-b border-slate-700 transition-colors duration-500" id="mainHeader">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
                
                <!-- LEFT GROUP: Goals & Vitals -->
                <div class="flex flex-col md:flex-row items-center gap-6 w-full lg:w-auto">
                    
                    <!-- Goal Progress -->
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <button onclick="openInfoModal()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-white text-[10px] flex items-center justify-center transition-colors flex-shrink-0">
                            <i class="fa-solid fa-info"></i>
                        </button>

                        <div class="flex-grow md:w-48">
                            <div class="flex justify-between items-end mb-1">
                                <div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider" id="goalTitle">Цель: Подушка</div>
                                <div class="text-xs font-bold text-emerald-400" id="goalValue">$0 / $5k</div>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-2 overflow-hidden shadow-inner border border-slate-600">
                                <div id="goalProgressBar" class="bg-emerald-500 h-full rounded-full transition-all duration-700 relative overflow-hidden" style="width: 0%">
                                    <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vitals (Moved to Left & Fixed Alignment) -->
                    <div class="flex gap-6 w-full md:w-auto border-t md:border-t-0 md:border-l border-slate-700 pt-2 md:pt-0 md:pl-6">
                        
                        <!-- Health -->
                        <div class="flex items-center gap-3 min-w-[120px]">
                            <div class="flex-grow">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[9px] uppercase font-bold text-slate-400 flex items-center gap-1"><i class="fa-solid fa-heart text-rose-500"></i> Здоровье</span>
                                    <div id="healthPrediction" class="text-[9px] font-bold w-12 text-right"><!-- Dynamic --></div>
                                </div>
                                <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                    <div id="hudHealthBar" class="bg-rose-500 h-full rounded-full transition-all duration-300" style="width: 100%"></div>
                                </div>
                            </div>
                            <span id="hudHealthVal" class="text-[10px] font-bold text-white w-8 text-right tabular-nums">100%</span>
                        </div>

                        <!-- Happiness -->
                        <div class="flex items-center gap-3 min-w-[120px]">
                            <div class="flex-grow">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[9px] uppercase font-bold text-slate-400 flex items-center gap-1"><i class="fa-solid fa-face-smile text-amber-400"></i> Счастье</span>
                                    <div id="happyPrediction" class="text-[9px] font-bold w-12 text-right"><!-- Dynamic --></div>
                                </div>
                                <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                    <div id="hudHappyBar" class="bg-amber-400 h-full rounded-full transition-all duration-300" style="width: 100%"></div>
                                </div>
                            </div>
                            <span id="hudHappyVal" class="text-[10px] font-bold text-white w-8 text-right tabular-nums">100%</span>
                        </div>

                    </div>
                </div>

                <!-- RIGHT GROUP: Action & Capital -->
                <div class="flex items-center gap-4 w-full lg:w-auto justify-between lg:justify-end border-t lg:border-none border-slate-700 pt-3 lg:pt-0">
                    <div class="flex flex-col items-end">
                         <div class="text-[9px] text-slate-400 uppercase tracking-widest">Капитал</div>
                         <div id="hudNetWorth" class="font-mono font-bold text-lg text-emerald-400">$0</div>
                    </div>
                    <button id="nextMonthBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-8 rounded-lg shadow-lg shadow-emerald-900/40 transform active:scale-95 transition-all flex items-center gap-2 text-xs uppercase tracking-wide">
                        <span>Прожить Месяц</span>
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>

            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 py-6 space-y-6 md:pr-4 lg:pr-8 transition-all duration-300" id="mainContent">

        <!-- DASHBOARD -->
        <section class="grid grid-cols-1 md:grid-cols-12 gap-4">
            
            <!-- Income Panel -->
            <div class="md:col-span-4 lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-between h-auto min-h-[14rem]">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Зарплата</label>
                        
                        <!-- Penalty UI -->
                        <div id="incomePenaltyBox" class="hidden relative tooltip-container cursor-help">
                            <div class="flex items-center gap-1.5 bg-rose-50 px-2 py-0.5 rounded border border-rose-100">
                                <i class="fa-solid fa-circle-exclamation text-rose-500 text-[10px]"></i>
                                <span class="text-[9px] text-slate-500 font-medium">Штраф <span id="penaltyPercent" class="text-rose-600 font-bold">-0%</span></span>
                            </div>
                            <div class="custom-tooltip">
                                <div class="font-bold text-rose-400 mb-1 text-xs">Эффективность снижена</div>
                                <p class="text-[10px] text-slate-300 leading-relaxed mb-1">Ваше состояние критическое (<50%). Доход падает.</p>
                                <ul class="list-disc pl-3 text-[10px] text-white/80 space-y-0.5"><li>Поднимите Необходимое</li><li>Поднимите Развлечения</li></ul>
                            </div>
                        </div>
                    </div>
                    <div class="relative group mb-1">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold group-focus-within:text-emerald-500 text-sm">$</span>
                        <input type="number" id="incomeInput" value="4000" class="w-full pl-6 pr-3 py-1.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none font-bold text-slate-800 text-base transition-all">
                    </div>
                    <div class="flex justify-between text-xs font-bold text-slate-500 mt-1 pb-2 border-b border-slate-100">
                        <span>На руки (Факт):</span>
                        <span id="realIncomeVal" class="text-emerald-600">$4,000</span>
                    </div>
                    
                    <div class="mt-2 text-[10px] text-slate-500 flex flex-col gap-1.5">
                        <div class="flex justify-between">
                            <span>Сбережения (4% год.):</span>
                            <span class="text-emerald-600 font-bold" id="savingsInterestText">+$0/мес</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Инвестиции (10% год.):</span>
                            <span class="text-indigo-600 font-bold" id="investmentInterestText">+$0/мес</span>
                        </div>
                        <div class="flex justify-between mt-1 pt-2 border-t border-slate-100">
                            <span>Рост ЗП (от Образ.):</span>
                            <span class="text-blue-600 font-bold" id="salaryGrowthPreview">+$0/мес</span>
                        </div>
                    </div>
                </div>
                
                <div id="debtRepayContainer" class="hidden mt-2 pt-2 border-t border-slate-100">
                    <button id="repayDebtBtn" class="w-full bg-rose-50 hover:bg-rose-100 text-rose-600 font-bold py-1.5 rounded-lg border border-rose-200 text-xs transition-colors flex items-center justify-center gap-1 btn-pulse">
                        <i class="fa-solid fa-fire"></i> Погасить: <span id="currentDebtVal">$0</span>
                    </button>
                </div>

                <div class="mt-auto pt-3 flex items-center justify-between border-t border-slate-100">
                    <div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Остаток / Баланс</div>
                        <div id="balanceBadgeContainer">
                            <div id="balanceBadge" class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-500 inline-block mt-0.5">OK</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex items-baseline gap-0.5 justify-end">
                            <span id="totalPercent" class="text-2xl font-black text-slate-800">100</span>
                            <span class="text-xs font-bold text-slate-400">%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VS Chart -->
            <div class="md:col-span-8 lg:col-span-9 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 relative flex flex-col h-auto min-h-[14rem]">
                <div class="mb-1 flex justify-between items-center">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase">СТРУКТУРА КАПИТАЛА</h3>
                    <span class="text-[9px] text-slate-400 bg-slate-100 px-2 py-0.5 rounded">Джон = 20% в банк (без риска)</span>
                </div>
                <div class="flex-grow w-full relative h-48">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Jars -->
        <section>
            <div class="flex items-center gap-2 mb-3 px-1">
                <i class="fa-solid fa-hand-pointer text-slate-400 animate-bounce text-sm"></i>
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Распределение бюджета (Тяните за уровень)</h2>
            </div>
            <div class="jars-grid" id="jarsContainer"></div>
        </section>

    </main>

    <!-- INFO MODAL (RULES) -->
    <div id="infoModal" class="fixed inset-0 info-overlay hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0">
        <div class="bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-all duration-300 overflow-hidden text-white">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-flag-checkered"></i> Правила Гонки</h2>
                <button onclick="closeInfoModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="p-6 space-y-6">
                
                <!-- John -->
                <div class="flex gap-4 items-start bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div class="w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center text-2xl text-slate-600 flex-shrink-0 border-2 border-white">
                        <i class="fa-solid fa-user-tie"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-base">Соперник: Джон</h3>
                        <p class="text-xs text-slate-400 mt-1 leading-relaxed">
                            Консерватор. Живет стабильно:<br>
                            • Откладывает <strong>20%</strong> зарплаты в банк.<br>
                            • Получает <strong>4% годовых</strong>.<br>
                            • Не рискует, не учится, не болеет.
                        </p>
                    </div>
                </div>

                <!-- Phases -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold uppercase text-slate-500 tracking-widest">Две Фазы Игры:</h3>
                    
                    <div class="flex gap-3 items-center">
                        <div class="w-10 h-10 rounded bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-lg font-bold">1</div>
                        <div>
                            <div class="font-bold text-sm text-emerald-400">Подушка Безопасности</div>
                            <div class="text-[10px] text-slate-400">Цель: Накопить <strong>$5,000</strong> в Сбережениях (Подушка). <br>Инвестиции работают как сбережения.</div>
                        </div>
                    </div>

                    <div class="flex gap-3 items-center">
                        <div class="w-10 h-10 rounded bg-amber-500/20 text-amber-400 flex items-center justify-center text-lg font-bold">2</div>
                        <div>
                            <div class="font-bold text-sm text-amber-400">Финансовая Свобода</div>
                            <div class="text-[10px] text-slate-400">Цель: Пассивный доход <strong>$1,000/мес</strong>. <br>Инвестиции разгоняются до 10%, но возможны кризисы!</div>
                        </div>
                    </div>
                </div>

                <!-- Mechanics -->
                <div class="grid grid-cols-2 gap-3 mt-2">
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <i class="fa-solid fa-scale-balanced text-blue-400 mb-1"></i>
                        <div class="text-[10px] font-bold">Авто-баланс</div>
                        <div class="text-[9px] text-slate-500 leading-tight mt-1">Кувшин "Сбережения" автоматически заполняется остатком.</div>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <i class="fa-solid fa-skull-crossbones text-rose-400 mb-1"></i>
                        <div class="text-[10px] font-bold">Риск смерти</div>
                        <div class="text-[9px] text-slate-500 leading-tight mt-1">Если Здоровье или Счастье упадут до 0% — игра окончена.</div>
                    </div>
                </div>

                <button onclick="closeInfoModal()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95">Понятно, к бою!</button>
            </div>
        </div>
    </div>

    <!-- REPORT SIDEBAR -->
    <div id="reportPanel" class="report-panel flex flex-col">
        <div class="w-full flex justify-center pt-3 pb-1 md:hidden"><div class="w-12 h-1.5 bg-slate-300 rounded-full"></div></div>
        <div class="p-5 flex-grow overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <div><div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Отчет</div><h2 class="text-xl font-bold text-slate-800">Месяц <span id="reportMonthNum">1</span></h2></div>
                <button onclick="closeReport()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div id="criticalWarnings" class="space-y-3 mb-4"></div>

            <!-- Rival Comparison Card -->
            <div class="bg-slate-800 text-white p-4 rounded-xl mb-4 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Сравнение</div>
                    <div class="flex justify-between items-end mb-2">
                        <div><div class="text-xs opacity-70">Ваш капитал</div><div class="font-bold text-emerald-400 text-lg" id="compUserNet">$0</div></div>
                        <div class="text-right"><div class="text-xs opacity-70">Джон</div><div class="font-bold text-slate-300 text-lg" id="compRivalNet">$0</div></div>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-1.5 mb-1 overflow-hidden">
                        <div id="compBar" class="bg-emerald-500 h-full transition-all duration-500" style="width: 50%"></div>
                    </div>
                    <div id="compText" class="text-[10px] text-center italic text-slate-400">Вы идете вровень</div>
                </div>
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl"></div>
            </div>

            <div id="eventCard" class="hidden bg-slate-50 border-l-4 border-indigo-500 p-4 rounded-r-xl mb-4 shadow-sm">
                <div class="flex items-center gap-2 mb-1" id="eventHeader"></div>
                <p id="eventText" class="text-xs text-slate-600 leading-relaxed"></p>
                <p id="eventJohnText" class="text-[10px] text-slate-400 mt-2 pt-2 border-t border-slate-200" style="display:none;"></p>
            </div>

            <div class="space-y-3 mb-4">
                <div class="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl shadow-sm"><div class="text-xs text-slate-500">Активные накопления</div><div class="font-bold text-slate-700" id="reportActiveGain">+$0</div></div>
                <div class="flex justify-between items-center p-3 bg-emerald-50 border border-emerald-100 rounded-xl"><div class="text-xs text-emerald-700 font-bold flex items-center gap-1"><i class="fa-solid fa-seedling"></i> Пассивный доход</div><div class="font-bold text-emerald-700" id="reportPassiveGain">+$0</div></div>
                <div class="flex justify-between items-center p-3 bg-blue-50 border border-blue-100 rounded-xl"><div class="text-xs text-blue-700 font-bold flex items-center gap-1"><i class="fa-solid fa-arrow-up"></i> Рост Зарплаты</div><div class="font-bold text-blue-700" id="reportSalaryGrowth">+$0</div></div>
                <div id="reportDebtRow" class="hidden flex justify-between items-center p-3 bg-rose-50 border border-rose-100 rounded-xl"><div class="text-xs text-rose-700 font-bold">Проценты по кредиту</div><div class="font-bold text-rose-700" id="reportDebtLoss">-$0</div></div>
            </div>

            <div class="text-center mb-4">
                <div class="text-[10px] uppercase font-bold text-slate-400">Итоговый капитал</div>
                <div class="text-3xl font-black text-slate-800 tracking-tight" id="reportNetWorth">$0</div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="text-center"><div class="text-[10px] text-slate-400 uppercase font-bold mb-1">Здоровье</div><div id="reportHealthChange" class="font-bold text-sm">0%</div></div>
                <div class="text-center border-l border-slate-100"><div class="text-[10px] text-slate-400 uppercase font-bold mb-1">Счастье</div><div id="reportHappyChange" class="font-bold text-sm">0%</div></div>
            </div>
            
            <div id="reportFeedback" class="mt-6 text-xs text-center text-slate-400 italic"></div>
        </div>
        <div class="p-4 border-t border-slate-100 bg-white"><button onclick="closeReport()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">Далее</button></div>
    </div>

    <div id="mobileOverlay" onclick="closeReport()" class="fixed inset-0 bg-black/20 z-30 hidden md:hidden transition-opacity opacity-0"></div>

    <!-- GAME OVER -->
    <div id="gameOverScreen" class="fixed inset-0 z-[100] game-over-overlay hidden flex flex-col items-center justify-center text-white p-6 text-center opacity-0 transition-opacity duration-1000">
        <div class="w-20 h-20 rounded-full bg-rose-600 flex items-center justify-center text-3xl mb-4 shadow-[0_0_30px_rgba(225,29,72,0.6)] animate-pulse"><i id="deathIcon" class="fa-solid fa-skull"></i></div>
        <h1 class="text-3xl font-black mb-1">ИГРА ОКОНЧЕНА</h1>
        <p id="deathReason" class="text-lg text-rose-300 font-medium mb-6 max-w-sm text-sm">Причина...</p>
        <button onclick="location.reload()" class="bg-white text-slate-900 hover:bg-slate-200 font-bold py-2.5 px-8 rounded-full text-sm uppercase transition hover:scale-105 shadow-xl">Заново</button>
    </div>

    <!-- WIN SCREEN -->
    <div id="winScreen" class="fixed inset-0 z-[100] game-over-overlay hidden flex flex-col items-center justify-center text-white p-6 text-center opacity-0 transition-opacity duration-1000 bg-slate-900/95">
        <div class="w-24 h-24 rounded-full bg-emerald-500 flex items-center justify-center text-4xl mb-6 shadow-[0_0_50px_rgba(16,185,129,0.5)] animate-bounce"><i class="fa-solid fa-trophy"></i></div>
        <h1 class="text-4xl font-black mb-2 text-emerald-400 tracking-tight">ПОБЕДА!</h1>
        <p class="text-lg text-slate-300 font-medium mb-8 max-w-md">Вы достигли финансовой свободы!</p>
        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 mb-8 w-full max-w-sm text-left space-y-4">
            <div class="flex justify-between border-b border-slate-700 pb-2">
                <span class="text-slate-400 text-xs uppercase">Прошло времени</span>
                <span class="font-bold"><span id="winMonths">0</span> мес.</span>
            </div>
            <div class="flex justify-between border-b border-slate-700 pb-2">
                <span class="text-slate-400 text-xs uppercase">Пассивный доход</span>
                <span class="font-bold text-emerald-400" id="winPassive">$0/мес</span>
            </div>
            <div class="flex justify-between">
                <span class="text-slate-400 text-xs uppercase">Капитал</span>
                <span class="font-bold text-white" id="winNetWorth">$0</span>
            </div>
        </div>
        <button onclick="location.reload()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-10 rounded-full text-sm uppercase transition hover:scale-105 shadow-xl">Начать заново</button>
    </div>

    <script>
        const CONFIG = { phase1Goal: 5000, phase2Goal: 1000, baseIncome: 4000, rates: { savings: 0.04, investments: 0.10, debt: 0.15 } };
        const JARS = [
            { id: 'nec', name: 'Необходимое', def: 60, color: '#64748B', liquid: '#94A3B8', icon: 'fa-house', type: 'exp' }, 
            { id: 'fun', name: 'Развлечения', def: 10, color: '#F59E0B', liquid: '#FBBF24', icon: 'fa-champagne-glasses', type: 'exp' }, 
            { id: 'edu', name: 'Образование', def: 10, color: '#3B82F6', liquid: '#60A5FA', icon: 'fa-book', type: 'exp' }, 
            { id: 'sav', name: 'Сбережения', def: 10, color: '#10B981', liquid: '#34D399', icon: 'fa-piggy-bank', type: 'save' }, 
            { id: 'inv', name: 'Инвестиции', def: 10, color: '#6366F1', liquid: '#818CF8', icon: 'fa-chart-line', type: 'invest' }
        ];
        
        const STANDARD_EVENTS = [
            { text: "Срочный ремонт зубов.", effect: { money: -400, health: 5 }, type: 'bad', icon: 'fa-tooth' },
            { text: "Грипп свалил с ног.", effect: { money: -100, health: -15 }, type: 'bad', icon: 'fa-temperature-arrow-up' },
            { text: "Нашел $200 в старой куртке!", effect: { money: 200 }, type: 'good', icon: 'fa-money-bill-1-wave' },
            { text: "Премия за проект!", effect: { money: 600, happy: 10 }, type: 'good', icon: 'fa-trophy' },
            { text: "Скачок инфляции. Цены выросли.", effect: { money: -150, rivalMod: -0.03 }, type: 'bad', icon: 'fa-arrow-trend-up', global: true },
            { text: "Выгорание на работе.", effect: { health: -5, happy: -20 }, type: 'bad', icon: 'fa-battery-empty' }
        ];

        const EVENTS = [
            { text: "КРИЗИС! Обвал фондового рынка на 25%!", effect: { crash: 0.25, rivalMod: -0.05 }, type: 'crash', icon: 'fa-chart-line-down', global: true },
            { text: "Коррекция рынка. Акции упали на 10%.", effect: { crash: 0.10, rivalMod: -0.02 }, type: 'bad', icon: 'fa-arrow-trend-down', global: true }
        ];

        let state = { month: 1, phase: 1, savings: 0, investments: 0, debt: 0, baseIncome: CONFIG.baseIncome, allocations: {}, health: 100, happiness: 100, 
                      history: { labels: [], savingsData: [], investmentsData: [], rivalData: [] }, rivalNetWorth: 0, isDead: false, isWon: false };
        
        JARS.forEach(j => state.allocations[j.id] = j.def);
        let els = {}, chartInstance = null, isDragging = false, currentDragJarId = null;

        function init() {
            els = {
                jars: document.getElementById('jarsContainer'),
                income: document.getElementById('incomeInput'),
                realIncomeVal: document.getElementById('realIncomeVal'),
                penaltyBox: document.getElementById('incomePenaltyBox'),
                penaltyPercent: document.getElementById('penaltyPercent'),
                hudHealthBar: document.getElementById('hudHealthBar'),
                hudHealthVal: document.getElementById('hudHealthVal'),
                healthPrediction: document.getElementById('healthPrediction'),
                hudHappyBar: document.getElementById('hudHappyBar'),
                hudHappyVal: document.getElementById('hudHappyVal'),
                happyPrediction: document.getElementById('happyPrediction'),
                hudNetWorth: document.getElementById('hudNetWorth'),
                savingsInterestText: document.getElementById('savingsInterestText'),
                investmentInterestText: document.getElementById('investmentInterestText'),
                salaryGrowthPreview: document.getElementById('salaryGrowthPreview'),
                totalPercent: document.getElementById('totalPercent'),
                balanceBadgeContainer: document.getElementById('balanceBadgeContainer'),
                chartCanvas: document.getElementById('historyChart'),
                goalTitle: document.getElementById('goalTitle'),
                goalValue: document.getElementById('goalValue'),
                goalProgressBar: document.getElementById('goalProgressBar'),
                monthCount: document.getElementById('monthCount'),
                debtRepayContainer: document.getElementById('debtRepayContainer'),
                currentDebtVal: document.getElementById('currentDebtVal'),
                repayDebtBtn: document.getElementById('repayDebtBtn'),
                
                // Modal
                infoModal: document.getElementById('infoModal'),
                reportPanel: document.getElementById('reportPanel'),
                mobileOverlay: document.getElementById('mobileOverlay'),
                reportMonthNum: document.getElementById('reportMonthNum'),
                eventCard: document.getElementById('eventCard'),
                eventHeader: document.getElementById('eventHeader'),
                eventText: document.getElementById('eventText'),
                eventJohnText: document.getElementById('eventJohnText'),
                reportActiveGain: document.getElementById('reportActiveGain'),
                reportPassiveGain: document.getElementById('reportPassiveGain'),
                reportSalaryGrowth: document.getElementById('reportSalaryGrowth'),
                reportDebtRow: document.getElementById('reportDebtRow'),
                reportDebtLoss: document.getElementById('reportDebtLoss'),
                reportNetWorth: document.getElementById('reportNetWorth'),
                reportHealthChange: document.getElementById('reportHealthChange'),
                reportHappyChange: document.getElementById('reportHappyChange'),
                compUserNet: document.getElementById('compUserNet'),
                compRivalNet: document.getElementById('compRivalNet'),
                compBar: document.getElementById('compBar'),
                compText: document.getElementById('compText'),
                rivalStatusText: document.getElementById('rivalStatusText'),
                reportFeedback: document.getElementById('reportFeedback'),
                criticalWarnings: document.getElementById('criticalWarnings'),

                deathScreen: document.getElementById('gameOverScreen'),
                deathReason: document.getElementById('deathReason'),
                deathIcon: document.getElementById('deathIcon'),
                winScreen: document.getElementById('winScreen')
            };

            renderJars(); initChart(); updateUI();
            els.income.addEventListener('input', (e) => { state.baseIncome = Math.max(0, parseInt(e.target.value) || 0); updateUI(); });
            document.getElementById('nextMonthBtn').addEventListener('click', processTurn);
            document.getElementById('nextMonthBtnMobile')?.addEventListener('click', processTurn);
            if(els.repayDebtBtn) els.repayDebtBtn.addEventListener('click', repayDebt);
            window.addEventListener('mouseup', endDrag); window.addEventListener('touchend', endDrag);
            window.addEventListener('mousemove', onDragMove); window.addEventListener('touchmove', onDragMove, { passive: false });
            
            // Open Info on Start
            setTimeout(openInfoModal, 500);
        }

        window.openInfoModal = function() { els.infoModal.classList.remove('hidden'); setTimeout(() => els.infoModal.classList.remove('opacity-0'), 10); }
        window.closeInfoModal = function() { els.infoModal.classList.add('opacity-0'); setTimeout(() => els.infoModal.classList.add('hidden'), 300); }

        function startDrag(jarId) { if(state.isDead || state.isWon) return; isDragging = true; currentDragJarId = jarId; }
        function endDrag() { isDragging = false; currentDragJarId = null; }
        
        function onDragMove(e) {
            if (!isDragging || !currentDragJarId) return;
            e.preventDefault();
            const container = document.getElementById(`jar-cont-${currentDragJarId}`);
            if (!container) return;
            
            const rect = container.getBoundingClientRect();
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let percent = ((rect.bottom - clientY) / rect.height) * 100;
            state.allocations[currentDragJarId] = Math.round(Math.max(0, Math.min(100, percent)));
            
            if (currentDragJarId !== 'sav') {
                let bufferId = 'sav';
                if (currentDragJarId === 'sav') bufferId = 'inv'; 
                
                let used = 0;
                for(let key in state.allocations) if(key !== bufferId) used += state.allocations[key];
                state.allocations[bufferId] = Math.max(0, 100 - used);
            }
            updateUI();
        }

        function renderJars() {
            if(!els.jars) return;
            els.jars.innerHTML = '';
            JARS.forEach(jar => {
                const card = document.createElement('div');
                card.className = 'jar-card bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-64 select-none';
                card.id = `card-${jar.id}`; 
                card.innerHTML = `
                    <div class="p-2 bg-white z-10 border-b border-slate-100 pointer-events-none text-center">
                        <div class="flex justify-center items-center gap-1.5 mb-1">
                            <div class="w-5 h-5 rounded bg-slate-50 flex items-center justify-center text-[10px]" style="color:${jar.color}"><i class="fa-solid ${jar.icon}"></i></div>
                            <h3 class="font-bold text-slate-700 text-[10px] uppercase truncate">${jar.name}</h3>
                        </div>
                        <div class="flex justify-center items-baseline gap-1">
                            <span id="pct-${jar.id}" class="text-[10px] font-bold text-slate-400">0%</span>
                            <span id="val-${jar.id}" class="font-bold text-slate-800 text-xs">$0</span>
                        </div>
                    </div>
                    <div id="jar-cont-${jar.id}" class="jar-container flex-grow relative w-full group cursor-ns-resize bg-slate-50">
                        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#cbd5e1 1px, transparent 1px); background-size: 100% 20px;"></div>
                        <div id="liq-${jar.id}" class="jar-liquid w-full absolute bottom-0 transition-all duration-150 ease-out pointer-events-none" style="background-color: ${jar.liquid}; height: ${state.allocations[jar.id]}%;">
                             <div class="jar-surface absolute top-0 w-full h-0 border-t-2 border-white/50 flex justify-center"><div class="jar-handle w-5 h-5 bg-white rounded-full shadow-md flex items-center justify-center -translate-y-1/2 text-slate-400 text-[8px] group-hover:scale-110 transition-transform"><i class="fa-solid fa-grip-lines"></i></div></div>
                        </div>
                    </div>`;
                els.jars.appendChild(card);
                const cont = card.querySelector('.jar-container');
                cont.addEventListener('mousedown', () => startDrag(jar.id));
                cont.addEventListener('touchstart', (e) => { startDrag(jar.id); onDragMove(e); }, { passive: false });
            });
        }

        // --- FOCUS JAR LOGIC ---
        window.focusJar = function(id) {
            window.closeReport();
            setTimeout(() => {
                const card = document.getElementById(`card-${id}`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.classList.add('highlight-jar');
                    setTimeout(() => card.classList.remove('highlight-jar'), 2000);
                }
            }, 300);
        }

        function calculateRealIncome() {
            let penalty = 0;
            if (state.health < 50) penalty += (50 - state.health) * 0.015; 
            if (state.happiness < 50) penalty += (50 - state.happiness) * 0.01;
            penalty = Math.min(0.9, penalty);
            return { realIncome: Math.floor(state.baseIncome * (1 - penalty)), penaltyAmount: state.baseIncome - Math.floor(state.baseIncome * (1 - penalty)), penaltyPct: penalty };
        }
        function calculateBalance() { const total = Object.values(state.allocations).reduce((a,b)=>a+b,0); return { total, balance: 100 - total }; }
        function calculatePassiveIncome() { 
            const invRate = state.phase === 1 ? CONFIG.rates.savings : CONFIG.rates.investments;
            return { savIncome: state.savings * (CONFIG.rates.savings / 12), invIncome: state.investments * (invRate / 12), debtCost: state.debt * (CONFIG.rates.debt / 12), totalPassive: (state.savings * (CONFIG.rates.savings / 12)) + (state.investments * (invRate / 12)) }; 
        }
        
        function getPrediction() {
            const nec = state.allocations.nec; const fun = state.allocations.fun; const edu = state.allocations.edu;
            
            // Trend logic with icons and colors
            let hPred = "Стаб.", hClass = "text-slate-400"; 
            if(nec<40){ hPred = "Падает"; hClass = "text-rose-600 font-bold"; } 
            else if(nec<55){ hPred = "Сниж."; hClass = "text-rose-500 font-bold"; } 
            else if(nec>65){ hPred = "Растет"; hClass = "text-emerald-500 font-bold"; }
            
            let hapPred = "Стаб.", hapClass = "text-slate-400"; 
            if((fun+edu)<15){ hapPred = "Падает"; hapClass = "text-rose-600 font-bold"; } 
            else if((fun+edu)<25){ hapPred = "Сниж."; hapClass = "text-rose-500 font-bold"; } 
            else if((fun+edu)>35){ hapPred = "Растет"; hapClass = "text-emerald-500 font-bold"; }

            // Add Icons
            const getIcon = (text) => {
                if(text.includes("Падает")) return '<i class="fa-solid fa-angles-down"></i> ' + text;
                if(text.includes("Сниж")) return '<i class="fa-solid fa-angle-down"></i> ' + text;
                if(text.includes("Растет")) return '<i class="fa-solid fa-angle-up"></i> ' + text;
                return '<i class="fa-solid fa-circle text-[6px]"></i> ' + text;
            };

            return { 
                hPred: getIcon(hPred), hClass, 
                hapPred: getIcon(hapPred), hapClass 
            };
        }
        
        function repayDebt() {
            if (state.debt <= 0 || state.savings <= 0) return;
            let amount = Math.min(state.debt, state.savings); state.debt -= amount; state.savings -= amount;
            updateUI(); 
            const idx = state.history.labels.length - 1;
            if (idx >= 0) {
                state.history.savingsData[idx] = state.savings;
                state.history.investmentsData[idx] = state.investments;
                if(chartInstance) chartInstance.update();
            }
        }

        function updateUI() {
            if(!els.jars) return;
            const inc = calculateRealIncome(), pas = calculatePassiveIncome(), bal = calculateBalance(), pred = getPrediction();
            
            const eduAlloc = state.allocations.edu; 
            const eduAmount = (inc.realIncome * eduAlloc) / 100;
            const projectedSalaryGrowth = Math.floor(eduAmount * 0.05);
            if(els.salaryGrowthPreview) els.salaryGrowthPreview.innerText = `+$${projectedSalaryGrowth}/мес`;

            if (els.debtRepayContainer) {
                if (state.debt > 5 && state.savings > 5) { els.debtRepayContainer.classList.remove('hidden'); if(els.currentDebtVal) els.currentDebtVal.innerText = '-$' + Math.floor(state.debt).toLocaleString(); } else els.debtRepayContainer.classList.add('hidden');
            }
            
            if(els.realIncomeVal) {
                els.realIncomeVal.innerText = '$' + inc.realIncome.toLocaleString(); 
                els.realIncomeVal.className = inc.penaltyAmount > 0 ? "text-rose-600 font-bold" : "text-emerald-600 font-bold";
            }
            
            if (inc.penaltyAmount > 0) {
                if(els.penaltyBox) els.penaltyBox.classList.remove('hidden');
                if(els.penaltyPercent) els.penaltyPercent.innerText = `-${Math.round(inc.penaltyPct*100)}%`;
            } else {
                if(els.penaltyBox) els.penaltyBox.classList.add('hidden');
            }

            if(els.savingsInterestText) els.savingsInterestText.innerText = `+$${Math.floor(pas.savIncome)}/мес`; 
            if(els.investmentInterestText) els.investmentInterestText.innerText = `+$${Math.floor(pas.invIncome)}/мес`;
            
            JARS.forEach(jar => { 
                const pct = state.allocations[jar.id], amount = (inc.realIncome * pct) / 100; 
                const valEl = document.getElementById(`val-${jar.id}`);
                const pctEl = document.getElementById(`pct-${jar.id}`);
                const liqEl = document.getElementById(`liq-${jar.id}`);
                
                if(valEl) valEl.innerText = '$' + Math.floor(amount).toLocaleString(); 
                if(pctEl) pctEl.innerText = pct + '%'; 
                if(liqEl) liqEl.style.height = pct + '%'; 
            });

            // Health/Happy Predictions with Icons
            if(els.healthPrediction) {
                els.healthPrediction.innerHTML = pred.hPred; 
                els.healthPrediction.className = `text-[9px] h-3 mt-0.5 flex items-center gap-1 justify-end transition-all ${pred.hClass}`;
            }
            if(els.happyPrediction) {
                els.happyPrediction.innerHTML = pred.hapPred; 
                els.happyPrediction.className = `text-[9px] h-3 mt-0.5 flex items-center gap-1 justify-end transition-all ${pred.hapClass}`;
            }
            
            if(els.hudHealthBar) els.hudHealthBar.style.width = state.health + '%'; 
            if(els.hudHealthVal) els.hudHealthVal.innerText = Math.round(state.health) + '%'; 
            if(els.hudHappyBar) els.hudHappyBar.style.width = state.happiness + '%'; 
            if(els.hudHappyVal) els.hudHappyVal.innerText = Math.round(state.happiness) + '%';
            
            const net = state.savings + state.investments - state.debt;
            if(els.hudNetWorth) {
                els.hudNetWorth.innerText = '$' + Math.floor(net).toLocaleString(); 
                els.hudNetWorth.className = net < 0 ? "font-mono font-bold text-lg text-rose-500" : "font-mono font-bold text-lg text-emerald-400";
            }
            
            if(els.rivalStatusText) {
                if(net > state.rivalNetWorth) els.rivalStatusText.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Вы лидируете';
                else els.rivalStatusText.innerHTML = '<span class="w-2 h-2 rounded-full bg-rose-500"></span> Отставание';
            }

            if(els.goalTitle) {
                let target = state.phase === 1 ? CONFIG.phase1Goal : CONFIG.phase2Goal;
                let current = state.phase === 1 ? state.savings : pas.totalPassive;
                
                els.goalTitle.innerText = state.phase === 1 ? "Цель: Подушка" : "Цель: Пассивный Доход";
                els.goalValue.innerText = `$${Math.floor(current).toLocaleString()} / $${target.toLocaleString()}`;
                
                let pct = Math.min(100, Math.max(0, (current / target) * 100));
                els.goalProgressBar.style.width = pct + '%';
                els.goalProgressBar.className = state.phase === 1 
                    ? "bg-emerald-500 h-full rounded-full transition-all duration-700 relative overflow-hidden" 
                    : "bg-amber-400 h-full rounded-full transition-all duration-700 relative overflow-hidden";
            }
            
            if(els.totalPercent) els.totalPercent.innerText = bal.total;
            
            if(els.balanceBadgeContainer) {
                if(bal.balance > 0) { 
                    els.totalPercent.className = "text-2xl font-black text-emerald-500"; 
                    els.balanceBadgeContainer.innerHTML = state.debt > 0 
                        ? `<div class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700 uppercase flex items-center gap-1"><i class="fa-solid fa-rotate"></i> Остаток ${bal.balance}% → Погашение Долга</div>`
                        : `<div class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700 uppercase flex items-center gap-1"><i class="fa-solid fa-arrow-right-to-bracket"></i> Остаток ${bal.balance}% → В Сбережения</div>`;
                }
                else if(bal.balance < 0) { 
                    els.totalPercent.className = "text-2xl font-black text-rose-500"; 
                    els.balanceBadgeContainer.innerHTML = `<div class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-rose-100 text-rose-700 uppercase flex items-center gap-1"><i class="fa-solid fa-triangle-exclamation"></i> Дефицит ${Math.abs(bal.balance)}% → Долг</div>`;
                }
                else { 
                    els.totalPercent.className = "text-2xl font-black text-slate-800"; 
                    els.balanceBadgeContainer.innerHTML = `<div class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-500 uppercase">Идеальный баланс</div>`;
                }
            }
        }

        function processTurn() {
            if(state.isDead || state.isWon) return;
            if(checkDeath()) return;

            const pred = getPrediction();
            
            // Apply Decay logic
            const nec = state.allocations.nec; const fun = state.allocations.fun; const edu = state.allocations.edu;
            
            if(nec<40) state.health -= 12; else if(nec<55) state.health -= 6; else state.health += 3;
            if((fun+edu)<15) state.happiness -= 12; else if((fun+edu)<25) state.happiness -= 6; else state.happiness += 3;

            state.health = Math.max(0, Math.min(100, state.health)); state.happiness = Math.max(0, Math.min(100, state.happiness));
            if (checkDeath()) return;

            let event = null; const roll = Math.random();
            if (roll < 0.02) { event = EVENTS.find(e => e.type === 'crash'); if(!event) event = EVENTS[EVENTS.length-2]; } 
            else if (roll < 0.10) { event = EVENTS.find(e => e.text.includes('Коррекция')); if(!event) event = EVENTS[EVENTS.length-1]; } 
            else if (roll < 0.40) { event = STANDARD_EVENTS[Math.floor(Math.random() * STANDARD_EVENTS.length)]; }

            // Rival Impact
            let rivalImpact = 0;
            if(event) {
                if(event.type === 'crash' || event.effect.crash) state.investments *= (1 - event.effect.crash);
                if(event.effect.health) state.health += event.effect.health;
                if(event.effect.happy) state.happiness += event.effect.happy;
                
                if (event.global || event.effect.rivalMod) {
                    const mod = event.effect.rivalMod || (event.type === 'crash' ? -0.05 : -0.02); 
                    const lost = Math.floor(state.rivalNetWorth * Math.abs(mod));
                    state.rivalNetWorth *= (1 + mod);
                    rivalImpact = -lost;
                }

                state.health = Math.max(0, Math.min(100, state.health)); state.happiness = Math.max(0, Math.min(100, state.happiness));
                if (checkDeath()) return;
            }

            const inc = calculateRealIncome(); const pas = calculatePassiveIncome();
            state.savings += pas.savIncome; state.investments += pas.invIncome; state.debt += pas.debtCost;
            let effInc = inc.realIncome; if(event && event.effect.money) effInc += event.effect.money;
            const bal = calculateBalance(), rem = (effInc * bal.balance) / 100;
            let addSav = (effInc * state.allocations.sav) / 100, addInv = (effInc * state.allocations.inv) / 100, addDebt = 0;
            const eduSpent = (effInc * state.allocations.edu) / 100, salaryInc = Math.floor(eduSpent * 0.05);
            state.baseIncome += salaryInc; els.income.value = state.baseIncome;

            // AUTO-BALANCE LOGIC
            if(rem > 0) { 
                if (state.debt > 0) { 
                    if (state.debt >= rem) state.debt -= rem; 
                    else { const l = rem - state.debt; state.debt = 0; addSav += l; } 
                } else addSav += rem; 
            } else addDebt += Math.abs(rem);
            
            state.savings += addSav; state.investments += addInv; state.debt += addDebt;

            const rivalIncome = state.baseIncome; 
            const rivalSave = rivalIncome * 0.20; 
            state.rivalNetWorth += rivalSave; 
            state.rivalNetWorth *= 1.004;

            if(state.phase === 1 && state.savings >= CONFIG.phase1Goal && state.debt <= 0) { state.phase = 2; document.getElementById('mainHeader').classList.add('border-amber-500', 'border-b-4'); }
            
            const net = state.savings + state.investments - state.debt;
            updateChart(state.savings, state.investments, state.rivalNetWorth);
            openReport(event, addSav + addInv - addDebt, pas, net, salaryInc, state.rivalNetWorth, rivalImpact);
            
            if(state.phase === 2 && pas.totalPassive >= CONFIG.phase2Goal) {
                triggerWin();
                return;
            }

            state.month++; if(els.monthCount) els.monthCount.innerText = state.month;
            updateUI();
        }

        function checkDeath() { if (state.health <= 0) { triggerDeath("Истощение.", "fa-heart-crack"); return true; } if (state.happiness <= 0) { triggerDeath("Выгорание.", "fa-face-dizzy"); return true; } return false; }
        function triggerDeath(reason, icon) { state.isDead = true; document.getElementById('deathReason').innerText = reason; document.getElementById('deathIcon').className = `fa-solid ${icon}`; els.deathScreen.classList.remove('hidden'); setTimeout(() => els.deathScreen.classList.remove('opacity-0'), 50); }
        
        function triggerWin() {
            state.isWon = true;
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            document.getElementById('winMonths').innerText = state.month;
            document.getElementById('winPassive').innerText = '$' + Math.floor(calculatePassiveIncome().totalPassive).toLocaleString() + '/мес';
            document.getElementById('winNetWorth').innerText = '$' + Math.floor(state.savings + state.investments).toLocaleString();
            els.winScreen.classList.remove('hidden');
            setTimeout(() => els.winScreen.classList.remove('opacity-0'), 50);
        }

        function initChart() {
            if(!els.chartCanvas) return;
            const ctx = els.chartCanvas.getContext('2d');
            chartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: state.history.labels, 
                    datasets: [
                        { 
                            label: 'Сбережения', 
                            data: state.history.savingsData, 
                            borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.4)', fill: 'origin', pointRadius: 0, borderWidth: 1, stack: 'player' 
                        },
                        { 
                            label: 'Инвестиции', 
                            data: state.history.investmentsData, 
                            borderColor: '#6366F1', backgroundColor: 'rgba(99, 102, 241, 0.4)', fill: '-1', pointRadius: 0, borderWidth: 1, stack: 'player' 
                        },
                        { 
                            label: 'Джон', 
                            data: state.history.rivalData, 
                            borderColor: '#94A3B8', borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0, borderWidth: 2, stack: 'rival' 
                        }
                    ] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { display: true, position: 'top', align: 'end', labels: { boxWidth: 8, font: { size: 10 }, usePointStyle: true } },
                        tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += Math.round(context.parsed.y).toLocaleString(); } return label; } } }
                    }, 
                    scales: { 
                        x: { display: false }, 
                        y: { stacked: true, grid: { borderDash: [4, 4], color: '#f1f5f9' } } 
                    } 
                } 
            });
            updateChart(0, 0, 0);
        }
        function updateChart(sav, inv, rivalVal) { 
            state.history.labels.push(state.month); 
            state.history.savingsData.push(sav);
            state.history.investmentsData.push(inv);
            state.history.rivalData.push(rivalVal); 
            if(chartInstance) chartInstance.update(); 
        }

        function openReport(event, actGain, pas, net, salGrow, rivalNet, rivalImpact) {
            els.reportMonthNum.innerText = state.month;
            
            // Critical Warnings Generation with Interaction
            els.criticalWarnings.innerHTML = ''; 
            if (state.health < 35) { 
                const w = document.createElement('div'); 
                w.className = 'bg-rose-50 border border-rose-200 rounded-lg p-3 text-xs text-rose-800 critical-alert flex items-center gap-3'; 
                w.innerHTML = `<i class="fa-solid fa-heart-pulse text-lg"></i> <div><strong>Критическое здоровье!</strong><div class="opacity-75">Нажми, чтобы исправить</div></div>`; 
                w.onclick = () => focusJar('nec');
                els.criticalWarnings.appendChild(w); 
            }
            if (state.happiness < 35) { 
                const w = document.createElement('div'); 
                w.className = 'bg-amber-50 border border-amber-200 rounded-lg p-3 text-xs text-amber-800 critical-alert flex items-center gap-3'; 
                w.innerHTML = `<i class="fa-solid fa-face-sad-tear text-lg"></i> <div><strong>Депрессия!</strong><div class="opacity-75">Нажми, чтобы исправить</div></div>`; 
                w.onclick = () => focusJar('fun');
                els.criticalWarnings.appendChild(w); 
            }

            if(event) {
                els.eventCard.classList.remove('hidden');
                let iconHtml = event.type === 'good' ? '<i class="fa-solid fa-star text-emerald-500"></i> <span class="font-bold text-emerald-700">Удача</span>' : '<i class="fa-solid fa-triangle-exclamation text-rose-500"></i> <span class="font-bold text-rose-700">Событие</span>';
                if(event.type === 'crash') iconHtml = '<i class="fa-solid fa-chart-line-down text-rose-600"></i> <span class="font-bold text-rose-800">ОБВАЛ РЫНКА</span>';
                
                els.eventHeader.innerHTML = iconHtml;
                els.eventText.innerText = event.text;
                els.eventCard.className = `p-4 rounded-xl mb-4 shadow-sm border-l-4 ${event.type === 'good' ? 'bg-emerald-50 border-emerald-500' : event.type === 'crash' ? 'bg-rose-100 border-rose-600' : 'bg-rose-50 border-rose-500'}`;
                
                if (rivalImpact < 0) {
                    els.eventJohnText.innerText = `Джон тоже пострадал: ${rivalImpact.toLocaleString()} $`;
                    els.eventJohnText.style.display = 'block';
                } else {
                    els.eventJohnText.style.display = 'none';
                }

            } else els.eventCard.classList.add('hidden');

            els.reportActiveGain.innerText = (actGain >= 0 ? '+' : '') + '$' + Math.floor(actGain).toLocaleString();
            els.reportPassiveGain.innerText = '+$' + Math.floor(pas.totalPassive).toLocaleString();
            els.reportSalaryGrowth.innerText = '+$' + Math.floor(salGrow).toLocaleString();
            if(pas.debtCost > 0) { els.reportDebtRow.classList.remove('hidden'); els.reportDebtLoss.innerText = '-$' + Math.floor(pas.debtCost).toLocaleString(); } else els.reportDebtRow.classList.add('hidden');
            
            if (els.reportNetWorth) els.reportNetWorth.innerText = '$' + Math.floor(net).toLocaleString();

            const hDiff = state.health - (state.lastHealth || 100); const hapDiff = state.happiness - (state.lastHappy || 100);
            els.reportHealthChange.innerHTML = `<i class="fa-solid fa-heart ${hDiff < 0 ? 'text-rose-500' : 'text-emerald-500'}"></i> ${hDiff > 0 ? '+' : ''}${Math.round(hDiff)}%`;
            els.reportHappyChange.innerHTML = `<i class="fa-solid fa-face-smile ${hapDiff < 0 ? 'text-rose-500' : 'text-emerald-500'}"></i> ${hapDiff > 0 ? '+' : ''}${Math.round(hapDiff)}%`;
            state.lastHealth = state.health; state.lastHappy = state.happiness;

            els.compUserNet.innerText = '$' + Math.floor(net).toLocaleString();
            els.compRivalNet.innerText = '$' + Math.floor(rivalNet).toLocaleString();
            const total = Math.max(net, rivalNet) * 1.5 || 100;
            els.compBar.style.width = Math.max(0, (net / total) * 100) + '%';
            if (net > rivalNet) els.compText.innerText = `Вы опережаете Джона на $${Math.floor(net - rivalNet).toLocaleString()}!`;
            else els.compText.innerText = `Вы отстаете на $${Math.floor(rivalNet - net).toLocaleString()}. Поднажмите!`;

            els.reportFeedback.innerText = "Анализ завершен.";

            els.reportPanel.classList.add('open');
            els.mobileOverlay.classList.remove('hidden');
            setTimeout(() => els.mobileOverlay.classList.remove('opacity-0'), 10);
        }

        window.closeReport = function() {
            els.reportPanel.classList.remove('open');
            els.mobileOverlay.classList.add('opacity-0');
            setTimeout(() => els.mobileOverlay.classList.add('hidden'), 300);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
