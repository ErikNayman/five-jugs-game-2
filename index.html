<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>5 –ö—É–≤—à–∏–Ω–æ–≤</title>

  <!-- Tailwind & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- noUiSlider -->
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.js"></script>

  <style>
  /* ========== –ö—É–≤—à–∏–Ω—ã-–ø–æ–ª–∑—É–Ω–∫–∏ ========== */
  .jar-wrap {width:120px; display:flex; flex-direction:column; align-items:center;}
  .jar      {width:80px;  height:160px; border:4px solid #555; border-radius:8px 8px 32px 32px;
             position:relative; background:#fff; overflow:hidden;}
  .liquid   {position:absolute; bottom:0; left:0; width:100%; height:0;
             background:linear-gradient(#4ade80,#16a34a); transition:height .25s;}
  .slider-v {height:160px; margin-top:12px;}
  input.hidden-field{display:none;}

  /* –ø–æ–¥–ø–∏—Å—å –ø–æ–¥ –∫—É–≤—à–∏–Ω–æ–º, —Ñ–∏–∫—Å. –≤—ã—Å–æ—Ç–∞ 60 px */
  .jar-caption{display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
               height:60px; font-size:15px; font-weight:600; line-height:1.1; text-align:center;}

  /* ========== –í–µ—Ä—Ö–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω—ã ========== */
  .glass-wrap {width:100px; display:flex; flex-direction:column; align-items:center;}
  .glass{width:70px; height:140px; border:4px solid #555; border-radius:8px 8px 28px 28px;
         position:relative; background:#fff; overflow:hidden;}
  .liquid-glass{position:absolute; bottom:0; left:0; width:100%; height:0; transition:height .25s;}

  /* –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è */
  .neg-liquid{background:#e11d48 !important;}
  .neg-text  {color:#e11d48 !important;}

  /* ========== –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã (Health / Happy) ========== */
  .vbar      {width:26px; height:140px; background:#d1d5db; border-radius:13px;
              position:relative; overflow:hidden;}
  .vbar-fill {position:absolute; bottom:0; left:0; width:100%; height:0; transition:height .25s;}
  .vbar-text {position:absolute; top:4px; left:0; width:100%; text-align:center;
              font-size:14px; font-weight:700; pointer-events:none; line-height:1;}

  /* ========== –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –ë–∞–ª–ª–æ–≤ ========== */
  .mini-chart-box{width:100px; height:140px; position:relative; display:flex;
                  align-items:center; justify-content:center;}
  #scoreChart{width:100px !important; height:100px !important;}
  #scoreBig  {position:absolute; top:0; left:0; width:100%; text-align:center;
              font-size:18px; font-weight:700; pointer-events:none;}
  </style>
</head>

<body class="bg-gray-100">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–¢–ê–†–¢ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- –º–∏–Ω–∏-—Ç—É—Ç–æ—Ä–∏–∞–ª (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<div id="tutorial" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden">
  <div class="bg-white rounded shadow max-w-md w-11/12 p-6 text-center space-y-4">
    <h3 id="tutTitle" class="text-xl font-bold"></h3>
    <p  id="tutText"></p>
    <button id="tutNext" class="bg-blue-600 text-white px-4 py-2 rounded">–î–∞–ª—å—à–µ</button>
  </div>
</div>
  
<div id="start-screen" class="min-h-screen flex flex-col items-center justify-center p-6">
  <h1 class="text-5xl font-bold mb-6"><span class="mr-2">üí∞</span>5 –ö—É–≤—à–∏–Ω–æ–≤</h1>

  <div class="bg-white p-6 rounded shadow w-full max-w-sm space-y-4 text-left">

    <!-- –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
    <p class="font-semibold">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–≥—Ä—ã:</p>
    <div class="flex gap-4">
      <button onclick="startGame(24)" class="flex-1 bg-green-600 text-white py-2 rounded">24 –º–µ—Å</button>
      <button onclick="startGame(36)" class="flex-1 bg-blue-600  text-white py-2 rounded">36 –º–µ—Å</button>
    </div>

    <!-- —Ä–µ–∂–∏–º—ã -->
    <p class="font-semibold mt-4 mb-1">–ö–∞–∫ –Ω–∞—á–∞—Ç—å?</p>

<!-- –°–≤–æ–±–æ–¥–Ω—ã–π –ø–ª–∞–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<label class="block">
  <input type="radio" name="mode" value="free" checked>
  <span class="ml-1">‚öôÔ∏è –°–≤–æ–±–æ–¥–Ω—ã–π –ø–ª–∞–Ω</span>
</label>

<!-- –í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å -->
<label class="block">
  <input type="radio" name="mode" value="role">
  <span class="ml-1">üë§ –í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å</span>
</label>

<!-- –±–ª–æ–∫ —Ä–æ–ª–µ–π (—Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è) -->
<div id="roleBlock" class="ml-6 mt-2 hidden">
  <label class="mr-4"><input type="radio" name="role" value="Saver"    checked> Saver</label>
  <label class="mr-4"><input type="radio" name="role" value="Investor"> Investor</label>
  <label class="mr-4"><input type="radio" name="role" value="Spec"> Speculator</label>
</div>

<!-- –í—ã–±—Ä–∞—Ç—å —Ü–µ–ª—å -->
<label class="block mt-2">
  <input type="radio" name="mode" value="goal">
  <span class="ml-1">üéØ –í—ã–±—Ä–∞—Ç—å —Ü–µ–ª—å</span>
</label>

<!-- –±–ª–æ–∫ —Ü–µ–ª–µ–π (—Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è) -->
<div id="goalBlock" class="ml-6 mt-2 hidden">
  <label class="block"><input type="radio" name="goal" value="buffer"  checked> –ü–æ–¥—É—à–∫–∞ –Ω–∞ 12 –º–µ—Å</label>
  <label class="block"><input type="radio" name="goal" value="passive"> –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ $1000/–º–µ—Å</label>
  <label class="block"><input type="radio" name="goal" value="tenk">    –ù–∞–∫–æ–ø–∏—Ç—å $10 000</label>
</div>

    <!-- –∞–≤—Ç–æ–¥–æ–ª–∏–≤ -->
    <label class="flex items-center space-x-2 mt-4">
      <input id="autoAdjust" type="checkbox" class="h-4 w-4 text-blue-600 rounded">
      <span class="text-sm">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –≤ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è</span>
    </label>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ò–ì–†–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game-screen" class="hidden p-6 space-y-6 max-w-7xl mx-auto">

  <h2 id="goalHeader" class="text-xl font-bold text-center mb-4">
  –¢–≤–æ—è —Ü–µ–ª—å: –í—ã–∂–∏—Ç—å
  </h2>
  
  <!-- –í–µ—Ä—Ö–Ω–∏–π dashboard -->
  <div class="flex flex-wrap gap-6 mb-8 justify-center">

    <!-- –î–æ—Ö–æ–¥—ã -->
    <div class="glass-wrap">
      <div class="glass"><div id="glassIncome"  class="liquid-glass" style="background:#82A8AB"></div></div>
      <p class="mt-1 font-semibold text-center text-sm">–î–æ—Ö–æ–¥—ã</p>
    </div>

    <!-- –†–∞—Å—Ö–æ–¥—ã -->
    <div class="glass-wrap">
      <div class="glass"><div id="glassExpenses" class="liquid-glass" style="background:#A77F4B"></div></div>
      <p class="mt-1 font-semibold text-center text-sm">–†–∞—Å—Ö–æ–¥—ã</p>
    </div>

    <!-- –°–±–µ—Ä–µ–∂–µ–Ω–∏—è -->
    <div class="glass-wrap">
      <div class="glass"><div id="glassSavings" class="liquid-glass" style="background:#728565"></div></div>
      <p class="mt-1 font-semibold text-center text-sm">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è</p>
    </div>

    <!-- –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ -->
    <div class="glass-wrap">
      <div class="glass"><div id="glassInvest" class="liquid-glass" style="background:#3B4550"></div></div>
      <p class="mt-1 font-semibold text-center text-sm">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</p>
    </div>

    <!-- –°–ø–µ–∫—É–ª—è—Ü–∏–∏ (–ø—É—Å—Ç–æ–π) -->
    <div class="glass-wrap">
      <div class="glass"><div id="glassSpec" class="liquid-glass" style="background:#BF8200"></div></div>
      <p class="mt-1 font-semibold text-center text-sm">–°–ø–µ–∫—É–ª—è—Ü–∏–∏</p>
    </div>

    <!-- –ó–¥–æ—Ä–æ–≤—å–µ (–≤–µ—Ä—Ç. –ø–æ–ª–æ—Å–∞) -->
    <div class="glass-wrap">
      <div class="vbar">
        <div id="vHealthFill" class="vbar-fill" style="background:#22c55e"></div>
        <span id="vHealthTxt" class="vbar-text">100%</span>
      </div>
      <p class="mt-1 font-semibold text-center text-sm">–ó–¥–æ—Ä–æ–≤—å–µ</p>
    </div>

    <!-- –°—á–∞—Å—Ç—å–µ -->
    <div class="glass-wrap">
      <div class="vbar">
        <div id="vHappyFill" class="vbar-fill" style="background:#facc15"></div>
        <span id="vHappyTxt" class="vbar-text">90%</span>
      </div>
      <p class="mt-1 font-semibold text-center text-sm">–°—á–∞—Å—Ç—å–µ</p>
    </div>

    <!-- –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –ë–∞–ª–ª—ã -->
    <div class="glass-wrap">
      <div class="mini-chart-box">
        <canvas id="scoreChart"></canvas>
        <span id="scoreBig">0</span>
      </div>
      <p class="mt-1 font-semibold text-center text-sm">–ë–∞–ª–ª—ã</p>
    </div>
  </div>

  <!-- –î–æ—Ö–æ–¥—ã / –†–∞—Å—Ö–æ–¥—ã —Ç–µ–∫—Å—Ç–æ–º -->
  <div class="grid grid-cols-2 gap-6">
    <div>
      <label class="block font-semibold mb-1">–î–æ—Ö–æ–¥—ã ($)</label>
      <p id="incomeDisplay" class="w-full border p-2 rounded bg-gray-50">$0</p>
    </div>
    <div>
      <label class="block font-semibold mb-1">–†–∞—Å—Ö–æ–¥—ã ($)</label>
      <p id="expensesDisplay" class="w-full border p-2 rounded bg-gray-50">$0</p>
    </div>
  </div>

  <!-- –®–µ—Å—Ç—å –∫—É–≤—à–∏–Ω–æ–≤-–ø–æ–ª–∑—É–Ω–∫–æ–≤ -->
  <div class="flex flex-wrap gap-6 mb-8">

    <!-- –í—ã–∂–∏–≤–∞–Ω–∏–µ -->
    <div class="jar-wrap">
      <div class="jar"><div id="survivalFill" class="liquid"></div></div>
      <div id="survivalSlider" class="slider-v"></div>
      <div class="jar-caption mt-1">–í—ã–∂–∏–≤–∞–Ω–∏–µ<br><span id="survivalVal">500</span> $</div>
      <input id="survival" type="hidden" class="hidden-field" value="500">
    </div>

    <!-- –ö–æ–º—Ñ–æ—Ä—Ç -->
    <div class="jar-wrap">
      <div class="jar"><div id="comfortFill" class="liquid"></div></div>
      <div id="comfortSlider" class="slider-v"></div>
      <div class="jar-caption mt-1">–ö–æ–º—Ñ–æ—Ä—Ç<br><span id="comfortVal">500</span> $</div>
      <input id="comfort" type="hidden" class="hidden-field" value="500">
    </div>

    <!-- –°–±–µ—Ä–µ–∂–µ–Ω–∏—è -->
    <div class="jar-wrap">
      <div class="jar"><div id="saveFill" class="liquid"></div></div>
      <div id="saveSlider" class="slider-v"></div>
      <div class="jar-caption mt-1">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è<br><span id="saveLabel">0</span> $</div>
      <input id="save" type="hidden" class="hidden-field" value="0">
    </div>

    <!-- –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ -->
    <div class="jar-wrap">
      <div class="jar"><div id="investFill" class="liquid"></div></div>
      <div id="investSlider" class="slider-v"></div>
      <div class="jar-caption mt-1">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏<br><span id="investVal">0</span> $</div>
      <input id="invest" type="hidden" class="hidden-field" value="0">
    </div>

    <!-- –ó–¥–æ—Ä–æ–≤—å–µ -->
    <div class="jar-wrap">
      <div class="jar"><div id="healthFill" class="liquid"></div></div>
      <div id="healthSlider" class="slider-v"></div>
      <div class="jar-caption mt-1">–ó–¥–æ—Ä–æ–≤—å–µ<br><span id="healthVal">0</span> $</div>
      <input id="healthSpend" type="hidden" class="hidden-field" value="0">
    </div>

    <!-- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ -->
    <div class="jar-wrap">
      <div class="jar"><div id="eduFill" class="liquid"></div></div>
      <div id="eduSlider" class="slider-v"></div>
      <div class="jar-caption mt-1">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ<br><span id="eduVal">0</span> $</div>
      <input id="edu" type="hidden" class="hidden-field" value="0">
    </div>
  </div>

  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ -->
  <div>
    <label for="extra" class="block font-semibold mb-1">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞</label>
    <select id="extra" class="w-full border p-2 rounded max-w-xs">
      <option value="–Ω–µ—Ç">–ù–µ—Ç</option>
      <option value="–¥–∞">–î–∞</option>
    </select>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ —Ö–æ–¥–∞ -->
<button onclick="runTurn()"
        class="fixed top-4 left-4 z-20 w-12 h-12 rounded-full
               bg-blue-600/90 hover:bg-blue-600 text-white
               flex items-center justify-center shadow-md"
        title="–°–¥–µ–ª–∞—Ç—å —Ö–æ–¥">
  <!-- —Å—Ç—Ä–µ–ª–∫–∞ –≤–ø–µ—Ä—ë–¥ -->
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
       width="20" height="20" fill="currentColor">
    <path d="M8 5v14l11-7z"/>
  </svg>
</button>

  <!-- –ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="text-center space-y-2">
    <p>–•–æ–¥: <span id="turn">0</span> / <span id="maxTurns">0</span></p>
    <p>–°–æ–±—ã—Ç–∏–µ: <span id="event">-</span></p>
    <p>–°–≤–æ–±–æ–¥–Ω—ã–µ –¥–µ–Ω—å–≥–∏: <span id="free">$0</span></p>
    <p>–°–±–µ—Ä–µ–∂–µ–Ω–∏—è: <span id="savings">$0</span></p>
    <p>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: <span id="investments">$0</span></p>
    <p>–¶–µ–ª—å: <span id="goalText">‚Äì</span>
      <span id="goalStatus" class="text-sm text-gray-500 ml-1">‚Äì</span></p>
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏ -->
    <div class="w-full h-4 bg-gray-300 rounded-full overflow-hidden mt-1">
  <div id="goalBar" class="h-full bg-green-500 w-0 transition-all duration-300"></div>
    </div>
  <p class="text-sm text-gray-600">
  <span id="goalPercent">0</span>% &nbsp;|&nbsp;
  –æ—Å—Ç–∞–ª–æ—Å—å <span id="goalLeft">‚Äì</span>
</p>
  </div>

  <!-- –ò—Å—Ç–æ—Ä–∏—è -->
  <div class="mt-8">
    <h2 class="text-xl font-bold text-center mb-2">üìò –ò—Å—Ç–æ—Ä–∏—è —Ö–æ–¥–æ–≤</h2>
    <table class="w-full text-sm bg-white rounded shadow overflow-hidden">
      <thead class="bg-gray-200 font-bold">
        <tr>
          <th class="p-2">–•–æ–¥</th><th class="p-2">–°–æ–±—ã—Ç–∏–µ</th><th class="p-2">–°–≤–æ–±–æ–¥–Ω—ã–µ $</th>
          <th class="p-2">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è</th><th class="p-2">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</th>
          <th class="p-2">–ó–¥–æ—Ä–æ–≤—å–µ</th><th class="p-2">–°—á–∞—Å—Ç—å–µ</th>
        </tr>
      </thead>
      <tbody id="historyTable" class="text-center"></tbody>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
document.addEventListener('DOMContentLoaded', ()=>{

  let turn = 0, maxTurns = 0;
  let savings = 0, investments = 0;
  let health = 100, happiness = 90;
  let startSavings = 0, startInvestments = 0;
  const scores = [];
let activeRules = [];        // –ø—Ä–∞–≤–∏–ª–∞ —Ç–µ–∫—É—â–µ–π —Ä–æ–ª–∏
let bonusFlag   = false;     // true ‚Üí ¬±5 –∫ happiness
let currentGoal = null;      // –æ–±—ä–µ–∫—Ç —Ü–µ–ª–∏ –∏–ª–∏ null
const goals = {
  buffer : { key:'buffer',  text:'–ü–æ–¥—É—à–∫–∞ –Ω–∞ 12 –º–µ—Å—è—Ü–µ–≤',   check:g=>g.savings>=g.monthExpenses*12 },
  passive: { key:'passive', text:'–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ $1000/–º–µ—Å', check:g=>g.passiveIncome>=1000 },
  tenk   : { key:'tenk',    text:'–ù–∞–∫–æ–ø–∏—Ç—å $10 000',        check:g=>g.savings>=10000 },
  double : { key:'double', text :'–£–¥–≤–æ–∏—Ç—å –∫–∞–ø–∏—Ç–∞–ª',    // —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å —Ç–µ–º, —á—Ç–æ –±—ã–ª–æ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã
    check: g => (g.savings + g.investments) >= (startSavings + startInvestments) * 2
  }
};

const tutSlides = [          // –º–∏–Ω–∏-—Ç—É—Ç–æ—Ä–∏–∞–ª –¥–ª—è Saver
  ['–®–∞–≥ 1/3','–û—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ ‚â• 10 % –¥–æ—Ö–æ–¥–∞ ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ ¬´–ø–æ–¥—É—à–∫—É¬ª.'],
  ['–®–∞–≥ 2/3','–ü–æ–¥—É—à–∫–∞ –Ω–∞ 12 –º–µ—Å ‚Üí –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ ‚â• 15 %.'],
  ['–®–∞–≥ 3/3','–ë–∞–∑–æ–≤—ã–µ —Ç—Ä–∞—Ç—ã ‚â§ 50 % –¥–æ—Ö–æ–¥–∞.']
];

  /* —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ä—Ç-—ç–∫—Ä–∞–Ω–∞ */
const roleBlock   = document.getElementById('roleBlock');
const goalBlock   = document.getElementById('goalBlock');
const goalHeader  = document.getElementById('goalHeader');
const startScreen = document.getElementById('start-screen');
const gameScreen  = document.getElementById('game-screen');

  /* === –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –ë–∞–ª–ª–æ–≤ === */
  const chart = new Chart(document.getElementById('scoreChart').getContext('2d'),{
    type:'line',
    data:{labels:[],datasets:[{data:[], borderColor:'#3b82f6', borderWidth:1,
                               tension:0.3, fill:false, pointRadius:0}]},
    options:{responsive:false, animation:false,
             scales:{x:{display:false}, y:{display:false}},
             plugins:{legend:{display:false}, tooltip:{enabled:false}}}
  });

  /* –∫—É–≤—à–∏–Ω-–ø–æ–ª–∑—É–Ω–æ–∫ */
  function buildJar(sliderId, fillId, valId, hiddenId, max){

    const slider=document.getElementById(sliderId);
    const fill  =document.getElementById(fillId);
    const valEl =document.getElementById(valId);
    const hidden=document.getElementById(hiddenId);

    noUiSlider.create(slider,{
      start:+hidden.value, orientation:'vertical', direction:'rtl',
      step:10, connect:[true,false], range:{min:0,max:max}
    });

    slider.noUiSlider.on('update', v=>{
      const num=Math.round(v[0]);
      fill.style.height=(num/max*100)+'%';
      valEl.textContent=num;
      hidden.value=num;
      updateIncomeExpenses();
    });
  }

      /* --- –ø—Ä–µ—Å–µ—Ç—ã —Ä–æ–ª–µ–π (–ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç –ë–ê–ó–û–í–û–ì–û –¥–æ—Ö–æ–¥–∞ 1000 $) --- */
const rolePresets = {
  /* min / max ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç –¥–æ—Ö–æ–¥–∞; buf ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è ¬´–ø–æ–¥—É—à–∫–∞¬ª –≤ –º–µ—Å—è—Ü–∞—Ö */
  Saver : {
    plan  : {survival:50, comfort:25, save:10, invest:5, health:5, edu:5},
    rules : [
      {type:'min', jar:'save',   value:10},
      {type:'ratio', max:50},                 // survival+comfort ‚â§ 50 %
      {type:'buf',  months:12}                // –ü–æ–¥—É—à–∫–∞ –Ω–∞ 12 –º–µ—Å
    ],
    bonus:+5, // —É—Å–ø–µ—Ö ‚Üí +5 happiness, –ø—Ä–æ–≤–∞–ª ‚Üí ‚Äì5
    goalKey : 'buffer'
  },
  Investor : {
    plan  : {survival:40, comfort:20, save:10, invest:20, health:5, edu:5},
    rules : [
      {type:'min', jar:'invest', value:15},
      {type:'ratio', max:50},
      {type:'buf',  months:6}
    ],
    bonus:+5,
    goalKey : 'passive'
  },
  Spec : {
    plan  : {survival:40, comfort:20, save:5,  invest:15, health:3, edu:2},
    rules : [
      {type:'min', jar:'save', value:5},
      {type:'ratio', max:50}
    ],
    bonus:false,       // –±–µ–∑ –±–æ–Ω—É—Å–∞/—à—Ç—Ä–∞—Ñ–∞
    goalKey : 'double'
  }
};

/* —É–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –¥–≤–∏–≥–∞–µ–º —Å–ª–∞–π–¥–µ—Ä –ø–æ id –Ω–∞ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ */
function setSlider(id, value){
  document.getElementById(id + 'Slider').noUiSlider.set(value);
}

  /* —à–µ—Å—Ç—å –∫—É–≤—à–∏–Ω–æ–≤ */
  buildJar('survivalSlider','survivalFill','survivalVal','survival',2000);
  buildJar('comfortSlider' ,'comfortFill' ,'comfortVal' ,'comfort' ,2000);
  buildJar('saveSlider'    ,'saveFill'    ,'saveLabel'  ,'save'    ,2000);
  buildJar('investSlider'  ,'investFill'  ,'investVal'  ,'invest'  ,2000);
  buildJar('healthSlider'  ,'healthFill'  ,'healthVal'  ,'healthSpend',2000);
  buildJar('eduSlider'     ,'eduFill'     ,'eduVal'     ,'edu',       2000);

  /* –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–∏—Ö —Å—Ç–∞–∫–∞–Ω–æ–≤ */
  function updateGlasses(income, survival, comfort, savePlan, investPlan){
    const full = income * 2 || 1;

    const setH = (id,v)=>{document.getElementById(id).style.height=
                          (Math.min(Math.abs(v),full)/full*100)+'%';};

    setH('glassIncome', income);
    setH('glassExpenses', survival+comfort);

    /* —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è: ¬± */
    const gS=document.getElementById('glassSavings');
    const lS=document.getElementById('saveLabel');
    if(savePlan>=0){gS.classList.remove('neg-liquid'); lS.classList.remove('neg-text');}
    else           {gS.classList.add('neg-liquid');    lS.classList.add('neg-text');}
    setH('glassSavings', savePlan);

    /* –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ */
    setH('glassInvest', Math.max(0, investPlan));
  }

function showTutorial(){
  let i=0; const dlg=document.getElementById('tutorial');
  const title=document.getElementById('tutTitle'),
        text =document.getElementById('tutText'),
        btn  =document.getElementById('tutNext');
  const render=()=>{title.textContent=tutSlides[i][0]; text.textContent=tutSlides[i][1];
                    btn.textContent=i===2?'–ü–æ–Ω—è–ª!':'–î–∞–ª—å—à–µ';};
  render(); dlg.classList.remove('hidden');
  btn.onclick=()=>{i<2 ? (i++,render()) : (dlg.classList.add('hidden'),localStorage.saverTut=1);}
}

  /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã –∑–¥–æ—Ä–æ–≤—å—è/—Å—á–∞—Å—Ç—å—è */
  function updateBars(){
    const h=Math.max(0,Math.min(100,health));
    const p=Math.max(0,Math.min(100,happiness));

    document.getElementById('vHealthFill').style.height = h+'%';
    document.getElementById('vHappyFill' ).style.height = p+'%';
    document.getElementById('vHealthTxt').textContent   = h+'%';
    document.getElementById('vHappyTxt' ).textContent   = p+'%';
  }

  /* –ø–µ—Ä–µ—Å—á—ë—Ç –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ */
  function updateIncomeExpenses(){
    const survival =+document.getElementById('survival').value;
    const comfort  =+document.getElementById('comfort').value;
    const savePlan =+document.getElementById('save').value;
    const investPlan=+document.getElementById('invest').value;
    const healthSp =+document.getElementById('healthSpend').value;
    const edu      =+document.getElementById('edu').value;
    const extra    = document.getElementById('extra').value;

    let income=1000; if(extra==='–¥–∞') income+=200;
    const spend=survival+comfort+savePlan+investPlan+healthSp+edu;
/* ----- –∞–≤—Ç–æ–¥–æ–ª–∏–≤ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞ –≤ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è ----- */
if (document.getElementById('autoAdjust').checked) {
  const rest = income - spend;
  if (rest > 0) {
    setSlider('save', savePlan + rest);      // –¥–≤–∏–≥–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–∞–π–¥–µ—Ä ¬´–°–±–µ—Ä–µ–∂–µ–Ω–∏—è¬ª
    return;                                  // –≤—ã—Ö–æ–¥–∏–º: updateIncomeExpenses –≤—ã–∑–æ–≤–µ—Ç—Å—è —Å–Ω–æ–≤–∞
  }
}
    document.getElementById('incomeDisplay').innerText   = `$${income}`;
    document.getElementById('expensesDisplay').innerText = `$${spend}`;
    updateGlasses(income,survival,comfort,savePlan,investPlan);
  }

function rulesBroken(income){
  const pct  = v => v / income * 100;
  const surv = +survival.value,
        comf = +comfort.value,
        sv   = +save.value,
        iv   = +invest.value;
  return activeRules.some(r=>{
    if (r.type === 'min')   return pct(r.jar === 'save' ? sv : iv) < r.value;
    if (r.type === 'ratio') return pct(surv + comf) > r.max;
    if (r.type === 'buf')   return (surv + comf) > 0 && savings / (surv + comf) < r.months;
  });
}

  function updateGoalProgress(goal, ctx){
  /* ctx: {savings, investments, passiveIncome, monthExpenses} */
  let pct = 0, leftTxt = '';

  if (goal.key === 'buffer'){
    const need = ctx.monthExpenses * 12;
    pct = Math.min(100, ctx.savings / need * 100);
    leftTxt = (need - ctx.savings > 0) ? `$${(need-ctx.savings).toFixed(0)}` : '0';
  }
  else if (goal.key === 'passive'){
    pct = Math.min(100, ctx.passiveIncome / 1000 * 100);
    leftTxt = (1000 - ctx.passiveIncome > 0) ? `$${(1000-ctx.passiveIncome).toFixed(0)}` : '0';
  }
  else if (goal.key === 'tenk'){
    pct = Math.min(100, ctx.savings / 10000 * 100);
    leftTxt = (10000 - ctx.savings > 0) ? `$${(10000-ctx.savings).toFixed(0)}` : '0';
  }
else if (goal.key === 'double'){
  const startCap = startSavings + startInvestments;   // —á—Ç–æ –±—ã–ª–æ –≤ –Ω–∞—á–∞–ª–µ
  const nowCap   = ctx.savings + ctx.investments;     // —á—Ç–æ –µ—Å—Ç—å —Å–µ–π—á–∞—Å
  pct     = Math.min(100, nowCap / (startCap*2) * 100);
  leftTxt = (startCap*2 - nowCap > 0)
              ? `$${(startCap*2 - nowCap).toFixed(0)}`
              : '0';
 }
    
  /* –≤–∏–∑—É–∞–ª—å–Ω–æ */
  document.getElementById('goalBar').style.width = pct + '%';
  document.getElementById('goalPercent').textContent = Math.floor(pct);
  document.getElementById('goalLeft').textContent    = leftTxt;
}

  /* —Ç–∞–±–ª–∏—Ü–∞-–∏—Å—Ç–æ—Ä–∏—è */
  function pushHistory(evt,free){
    const row=document.createElement('tr');
    row.innerHTML=`
      <td class="p-2">${turn}</td><td class="p-2">${evt}</td>
      <td class="p-2">$${Math.round(free)}</td>
      <td class="p-2">$${Math.round(savings)}</td>
      <td class="p-2">$${Math.round(investments)}</td>
      <td class="p-2">${health}%</td><td class="p-2">${happiness}%</td>`;
    document.getElementById('historyTable').appendChild(row);
  }

  /* –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ */
  function updateChart(score){
    scores.push(score);
    chart.data.labels.push(turn);
    chart.data.datasets[0].data.push(score);
    chart.update();
    document.getElementById('scoreBig').textContent = score;
  }

  /* —Å—Ç–∞—Ä—Ç */
window.startGame = n => {
  maxTurns = n;
  document.getElementById('maxTurns').innerText = n;
  /* —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É */
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('game-screen').classList.remove('hidden');
  /* ---------------- –ø—Ä–µ—Å–µ—Ç—ã ---------------- */
  const mode = document.querySelector('input[name="mode"]:checked').value;

  console.log('[startGame] mode =', mode); // –ü–†–û–í–ï–†–ö–ê
  
 if (mode === 'role') {
  const role = document.querySelector('input[name="role"]:checked').value,
        cfg  = rolePresets[role];
  activeRules = cfg.rules;             // ‚Üê –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞
  bonusFlag   = !!cfg.bonus;           // true/false
  const base  = 1000;
  Object.entries(cfg.plan).forEach(([field,pc])=>{
    setSlider(field, Math.round(base*pc/100/10)*10);
  });
  startSavings = +document.getElementById('save').value;
  startInvestments = +document.getElementById('invest').value;
   if(role==='Saver' && !localStorage.saverTut) setTimeout(showTutorial,300);
   // –Ω–∞–∑–Ω–∞—á–∞–µ–º —Ü–µ–ª—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ä–æ–ª–∏
currentGoal = goals[cfg.goalKey];

       console.log('[role] currentGoal =', currentGoal);      // –ü–†–û–í–ï–†–ö–ê
   
document.getElementById('goalText').textContent   = currentGoal.text;
document.getElementById('goalStatus').textContent = '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ';
updateGoalProgress(currentGoal, {
  savings        : startSavings,
  investments    : startInvestments,
  passiveIncome  : 0,
  monthExpenses  : +document.getElementById('survival').value +
                   +document.getElementById('comfort').value
});

goalHeader.textContent = '–¢–≤–æ—è —Ü–µ–ª—å: ' + currentGoal.text;
} else {
  activeRules = []; bonusFlag = false;
}

  /* ---------------- —Ü–µ–ª—å ---------------- */
if (mode === 'goal') {
  const goalKey     = document.querySelector('input[name="goal"]:checked').value;
  currentGoal       = goals[goalKey];

  document.getElementById('goalText').textContent   = currentGoal.text;
  document.getElementById('goalStatus').textContent = '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ';
  updateGoalProgress(currentGoal, {
    savings: 0, investments: 0, passiveIncome: 0, monthExpenses: 1
  });
}

/* --- –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ü–µ–ª–∏ / —Ä–æ–ª–∏ --- */
if (currentGoal) {                     // —Ü–µ–ª—å (–¥–ª—è —Ä–µ–∂–∏–º–∞ goal –ò–õ–ò role) –µ—Å—Ç—å
  goalHeader.textContent = '–¢–≤–æ—è —Ü–µ–ª—å: ' + currentGoal.text;
} else {                               // —Å–≤–æ–±–æ–¥–Ω—ã–π –ø–ª–∞–Ω ‚Äì —Ü–µ–ª–∏ –Ω–µ—Ç
  goalHeader.textContent = '–¢–≤–æ—è —Ü–µ–ª—å: –í—ã–∂–∏—Ç—å';
}

  /* –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ goal / free –Ω–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω–∞–¥–æ */
  /* –æ–±–Ω—É–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã */
turn = 0;
savings = 0;
investments = 0;
health = 100;
happiness = 90;  

/* ===== –ü–†–û–í–ï–†–ö–ê ===== */
console.log('[startGame] goalHeader —Å–µ–π—á–∞—Å =', goalHeader.textContent);
/* ==================== */
              
  updateIncomeExpenses(); updateBars();
};


  /* –•–û–î */
  window.runTurn = ()=>{
    turn++;

    const survival  =+document.getElementById('survival').value;
    const comfort   =+document.getElementById('comfort').value;
    const savePlan  =+document.getElementById('save').value;
    const investPlan=+document.getElementById('invest').value;
    const healthSp  =+document.getElementById('healthSpend').value;
    const edu       =+document.getElementById('edu').value;
    const extra     = document.getElementById('extra').value;

    let income=1000; if(extra==='–¥–∞') income+=200;
    const spend=survival+comfort+savePlan+investPlan+healthSp+edu;

    /* —Å–æ–±—ã—Ç–∏–µ */
    let evt='–Ω–∏—á–µ–≥–æ', penalty=0, crisis=0;
    const r=Math.random();
    if(r<0.15){evt='–º–µ–ª–∫–∞—è —Ç—Ä–∞—Ç–∞ ‚Äì $50'; penalty=-50;}
    else if(r<0.25){evt='–∫—Ä–∏–∑–∏—Å ‚Äì 6 % –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π'; crisis=investments*0.06;}
    else if(r<0.40){evt='–±–æ–ª–µ–∑–Ω—å ‚Äì 5 –∑–¥–æ—Ä–æ–≤—å—è'; health=Math.max(0,health-5);}

    const free=income-spend+penalty;
    savings+=savePlan+free;
    const growth=Math.random()<=0.7?Math.random()*0.03:Math.random()*-0.01;
    investments=(investments+investPlan-crisis)*(1+growth);

    /* –∑–¥–æ—Ä–æ–≤—å–µ / —Å—á–∞—Å—Ç—å–µ */
    if(evt!=='–±–æ–ª–µ–∑–Ω—å ‚Äì 5 –∑–¥–æ—Ä–æ–≤—å—è'){
      if(survival<500) health-=((500-survival)/500)*100;
      else             health+=5;
      if(happiness>=90) health+=5;
      health+=(healthSp/500)*50;
    }
    health=Math.round(Math.max(0,Math.min(100,health)));

    if(extra==='–¥–∞') health=Math.max(0,health-5);
    if(comfort<500)  happiness-=((500-comfort)/500)*10;
    if(extra==='–¥–∞') happiness-=5;
    happiness=Math.round(Math.max(0,happiness));

    /* –±–æ–Ω—É—Å –∏–ª–∏ —à—Ç—Ä–∞—Ñ –ø–æ –∏—Ç–æ–≥–∞–º –ø—Ä–∞–≤–∏–ª */
if (bonusFlag){
  const bad = rulesBroken(income);
  happiness = Math.max(0, Math.min(100, happiness + (bad ? -5 : +5)));
}
    /* –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
    document.getElementById('turn').innerText=turn;
    document.getElementById('event').innerText=evt;
    document.getElementById('free').innerText        = `$${Math.round(free)}`;
    document.getElementById('savings').innerText     = `$${Math.round(savings)}`;
    document.getElementById('investments').innerText = `$${Math.round(investments)}`;

    updateIncomeExpenses(); updateBars(); pushHistory(evt,free);

    /* –±–∞–ª–ª—ã */
    let score=Math.floor(savings/1000)+Math.floor(investments/1000)*2;
    if(health>70)    score+=20;
    if(happiness>70) score+=20;
    const passive=(investments*0.05+savings*0.03)/12;
    if(passive>1000) score+=30;
    updateChart(score);

    /* ------------ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ ------------ */
if (currentGoal){
  const monthExpenses = survival + comfort;
  const passiveIncome = (investments*0.05 + savings*0.03) / 12;
  const done = currentGoal.check({
    savings, passiveIncome, monthExpenses
  });
  document.getElementById('goalStatus').textContent = done ? '‚úî –≤—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ';
  updateGoalProgress(currentGoal, {
  savings,
  investments,
  passiveIncome,
  monthExpenses
});
  if (done){
    finish('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —Ü–µ–ª–∏: ' + currentGoal.text);
    return;               // —á—Ç–æ–±—ã –±–æ–ª—å—à–µ –Ω–µ –≤–µ—Å—Ç–∏ —Ä–∞—Å—á—ë—Ç—ã –ø–æ—Å–ª–µ finish()
  }
}

    /* —Ñ–∏–Ω–∏—à? */
    if(health<=0||happiness<=0||turn>=maxTurns){
      const reason=health<=0?'–¢—ã –ø–æ—Ç–µ—Ä—è–ª –∑–¥–æ—Ä–æ–≤—å–µ.' :
                   happiness<=0?'–¢—ã –ø–æ—Ç–µ—Ä—è–ª —Å—á–∞—Å—Ç—å–µ.' : '–•–æ–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.';
      finish(reason);
    }
  };

function finish(reason){
  alert(reason + '\n–ë–∞–ª–ª—ã: ' + scores[scores.length-1]);
  /* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç-—ç–∫—Ä–∞–Ω */
  gameScreen.classList.add('hidden');
  startScreen.classList.remove('hidden');
  /* —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–¥–æ—Ä–æ–≤—å–µ/—Å—á–∞—Å—Ç—å–µ –∏ –∏—Ö –±–∞—Ä—ã */
  health = 100;
  happiness = 90;
  updateBars();
  
  /* 2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –æ–±–Ω—É–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ë–∞–ª–ª–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  chart.data.labels.length = 0;                 // –æ—á–∏—â–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –æ—Å–∏ X
  chart.data.datasets[0].data.length = 0;       // –æ—á–∏—â–∞–µ–º —Å–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è
  chart.update();                               // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫
  document.getElementById('scoreBig').textContent = 0;   // –∫—Ä—É–ø–Ω–∞—è —Ü–∏—Ñ—Ä–∞ ‚Üí 0
  scores.length = 0;                            // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –æ–±–Ω—É–ª—è–µ–º –º–∞—Å—Å–∏–≤ scores

  /* (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –æ–±–Ω—É–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ü–µ–ª–∏ */
  document.getElementById('goalStatus').textContent = '‚Äì';
  
  /* –æ–±–Ω—É–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Ü–µ–ª–∏ */
document.getElementById('goalBar').style.width   = '0%';
document.getElementById('goalPercent').textContent = 0;
document.getElementById('goalLeft').textContent    = '‚Äì';
}
  
  /* –ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è */
  updateIncomeExpenses(); updateBars();
});

/* –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –Ω–∞ —Å—Ç–∞—Ä—Ç-—ç–∫—Ä–∞–Ω–µ */
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    const m = r.value;
    roleBlock.classList.toggle('hidden', m !== 'role');
    goalBlock.classList.toggle('hidden', m !== 'goal');
  });
});

</script>
</body>
</html>
