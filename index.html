<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>5 –ö—É–≤—à–∏–Ω–æ–≤</title>

  <!-- Tailwind & Chart.js -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- noUiSlider -->
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.js"></script>

  <style>
  /* ========== –ö—É–≤—à–∏–Ω—ã-–ø–æ–ª–∑—É–Ω–∫–∏ ========== */
  .jar-wrap {width:120px; display:flex; flex-direction:column; align-items:center;}
  .jar      {width:80px;  height:160px; border:4px solid #555; border-radius:8px 8px 32px 32px;
             position:relative; background:#fff; overflow:hidden;}
  .liquid   {position:absolute; bottom:0; left:0; width:100%; height:0;
             background:linear-gradient(#4ade80,#16a34a); transition:height .25s;}
  .slider-v {height:160px; margin-top:12px;}
  input.hidden-field{display:none;}

  /* –ø–æ–¥–ø–∏—Å—å –ø–æ–¥ –∫—É–≤—à–∏–Ω–æ–º, —Ñ–∏–∫—Å. –≤—ã—Å–æ—Ç–∞ 60 px */
  .jar-caption{display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
               height:60px; font-size:15px; font-weight:600; line-height:1.1; text-align:center;}

  /* ========== –í–µ—Ä—Ö–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω—ã ========== */
  .glass-wrap {width:100px; display:flex; flex-direction:column; align-items:center;}
  .glass{width:70px; height:140px; border:4px solid #555; border-radius:8px 8px 28px 28px;
         position:relative; background:#fff; overflow:hidden;}
  .liquid-glass{position:absolute; bottom:0; left:0; width:100%; height:0; transition:height .25s;}

  /* –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è */
  .neg-liquid{background:#e11d48 !important;}
  .neg-text  {color:#e11d48 !important;}

  /* ========== –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã (Health / Happy) ========== */
  .vbar      {width:26px; height:140px; background:#d1d5db; border-radius:13px;
              position:relative; overflow:hidden;}
  .vbar-fill {position:absolute; bottom:0; left:0; width:100%; height:0; transition:height .25s;}
  .vbar-text {position:absolute; top:4px; left:0; width:100%; text-align:center;
              font-size:14px; font-weight:700; pointer-events:none; line-height:1;}

  /* ========== –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –ë–∞–ª–ª–æ–≤ ========== */
  .mini-chart-box{width:100px; height:140px; position:relative; display:flex;
                  align-items:center; justify-content:center;}
  #scoreChart{width:100px !important; height:100px !important;}
  #scoreBig  {position:absolute; top:0; left:0; width:100%; text-align:center;
              font-size:18px; font-weight:700; pointer-events:none;}
  </style>
  <style>
    
  #toastBox{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
          z-index:9000;font-size:14px;font-weight:600;color:#fff;}
  .toast{background:#3b82f6;padding:8px 14px;margin-top:8px;border-radius:6px;
       opacity:0;animation:fade 4s forwards;}
  @keyframes fade{0%{opacity:0}10%{opacity:1}90%{opacity:1}100%{opacity:0}}
  </style>
  <style>
  #roleBlock label{
  font-size:0.8rem;
  line-height:1;
}
</style>

<style>
  .jar{display:none}
  .slider-v{margin-top:0}
</style>
  
</head>
  <body class="bg-gray-100">
  <div id="toastBox"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–¢–ê–†–¢ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- –º–∏–Ω–∏-—Ç—É—Ç–æ—Ä–∏–∞–ª (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<div id="tutorial" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden" style="z-index:1000">
  <div class="bg-white rounded shadow max-w-md w-11/12 p-6 text-center space-y-4">
    <h3 id="tutTitle" class="text-xl font-bold"></h3>
    <p  id="tutText"></p>
    <button id="tutNext" class="bg-blue-600 text-white px-4 py-2 rounded">–î–∞–ª—å—à–µ</button>
  </div>
</div>
  
<div id="start-screen" class="min-h-screen flex flex-col items-center justify-center p-6">
  
    <p class="text-center max-w-lg mb-6 text-gray-800 leading-snug">
  –í –∏–≥—Ä–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ —Ç—ã –ø—Ä–æ–∫–∞—á–∞–µ—à—å —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è <span class="font-semibold">–¥–µ–Ω–µ–∂–Ω—ã—Ö —Ü–µ–ª–µ–π</span>
  - ¬´–ü–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏¬ª (<span class="font-semibold">–°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å</span>), 
    ¬´$1 000 –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞¬ª <span class="font-semibold">–ò–Ω–≤–µ—Å—Ç–æ—Ä</span>) 
   "–£–¥–≤–æ–∏—Ç—å –∫–∞–ø–∏—Ç–∞–ª" (<span class="font-semibold">–°–ø–µ–∫—É–ª—è–Ω—Ç</span>) + –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è <span class="font-semibold">–ó–¥–æ—Ä–æ–≤—å—è</span>, 
    <span class="font-semibold">–°—á–∞—Å—Ç—å—è</span>.
  </p>
  <h1 class="text-5xl font-bold mb-6"><span class="mr-2">üí∞</span>5 –ö—É–≤—à–∏–Ω–æ–≤</h1>

  <div class="bg-white p-6 rounded shadow w-full max-w-sm space-y-4 text-left">

    <!-- –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
    <p class="font-semibold">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–≥—Ä—ã:</p>
    <div class="flex gap-4">
      <button onclick="startGame(24)" class="flex-1 bg-green-600 text-white py-2 rounded">24 –º–µ—Å (—Ö–æ–¥–æ–≤)</button>
      <button onclick="startGame(60)" class="flex-1 bg-blue-600  text-white py-2 rounded">60 –º–µ—Å (—Ö–æ–¥–æ–≤)</button>
    </div>

    <!-- —Ä–µ–∂–∏–º—ã -->
    <p class="font-semibold mt-4 mb-1">–í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å</p>

<!-- –±–ª–æ–∫ —Ä–æ–ª–µ–π -->
<div id="roleBlock" class="ml-6 mt-2">
  <label class="mr-4"><input type="radio" name="role" value="Saver"    checked required> –°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å</label>
  <label class="mr-4"><input type="radio" name="role" value="Investor"> –ò–Ω–≤–µ—Å—Ç–æ—Ä</label>
  <label class="mr-4"><input type="radio" name="role" value="Spec"> –°–ø–µ–∫—É–ª—è–Ω—Ç</label>
</div>

<p id="roleGoalHint" class="mt-2 text-sm text-gray-600"></p>
    
    <!-- ‚îÄ‚îÄ‚îÄ –°–õ–û–ñ–ù–û–°–¢–¨ ‚îÄ‚îÄ‚îÄ -->
<p class="font-semibold mt-4 mb-1">üí° –°–ª–æ–∂–Ω–æ—Å—Ç—å</p>
<div class="flex items-center gap-4 flex-wrap ml-6">
  <label class="flex items-center gap-1">
    <input type="radio" name="diff" value="easy"
           class="accent-green-600" checked>
    –õ—ë–≥–∫–∏–π
  </label>
  <label class="flex items-center gap-1">
    <input type="radio" name="diff" value="normal"
           class="accent-yellow-500">
    –°—Ä–µ–¥–Ω–∏–π
  </label>
  <label class="flex items-center gap-1">
    <input type="radio" name="diff" value="hard"
           class="accent-red-600">
    –°–ª–æ–∂–Ω—ã–π
  </label>
</div>

    <!-- –∞–≤—Ç–æ–¥–æ–ª–∏–≤ -->
    <label class="flex items-center space-x-2 mt-4">
      <input id="autoAdjust" type="checkbox" class="h-4 w-4 text-blue-600 rounded">
      <span class="text-sm">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –≤ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è</span>
    </label>

    <!-- üÜï –ë–ª–æ–∫ ¬´–†–µ–∂–∏–º –∏–≥—Ä—ã¬ª -->
<p class="font-semibold mt-4 mb-1">–†–µ–∂–∏–º –∏–≥—Ä—ã</p>

<label class="block">
  <input type="radio" name="mode" value="role" checked>
  <span class="ml-1">üéØ –†–æ–ª–µ–≤–∞—è –∏–≥—Ä–∞ (Saver / Investor / Spec)</span>
</label>

<label class="block">
  <input type="radio" name="mode" value="custom">
  <span class="ml-1">üõ† –°–≤–æ—è —Å—Ö–µ–º–∞</span>
</label>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ò–ì–†–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game-screen" class="hidden p-6 space-y-6 max-w-7xl mx-auto">

<h2 id="goalHeader"
    class="text-2xl font-bold text-center mt-4">
  –ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏ <span id="goalName"></span>
  ‚Äî <span id="goalStatus" class="text-base font-semibold">‚Äì</span>
</h2>
  
<div class="flex justify-center mt-4">   <!-- —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º -->
  <button onclick="runTurn()"
          class="w-12 h-12 rounded-full bg-blue-600/90 hover:bg-blue-600
                 text-white flex items-center justify-center shadow-md"
          title="–°–¥–µ–ª–∞—Ç—å —Ö–æ–¥">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         width="20" height="20" fill="currentColor">
      <path d="M8 5v14l11-7z"/>
    </svg>
  </button>
</div>

<div class="w-full max-w-lg mx-auto">
  <div class="w-full h-4 bg-gray-300 rounded-full overflow-hidden mt-2">
    <div id="goalBar"
         class="h-full bg-green-500 w-0 transition-all duration-300"></div>
  </div>
  <p class="text-center text-sm mt-1">
    <span id="goalPercent">0</span>% | –æ—Å—Ç–∞–ª–æ—Å—å
    <span id="goalLeft">‚Äì</span>
  </p>
</div>
  
<!-- ‚ïê‚ïê‚ïê –í–µ—Ä—Ö–Ω–∏–π dashboard (3 –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–∞) ‚ïê‚ïê‚ïê -->
<div class="flex flex-col lg:flex-row gap-6 mb-8 justify-center">

  <!-- ‚îÄ‚îÄ ‚ë† 5 —Å—Ç–∞–∫–∞–Ω–æ–≤ –¥–µ–Ω–µ–∂–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ ‚îÄ‚îÄ -->
  <div class="p-4 bg-white/70 rounded-lg shadow flex flex-wrap gap-6 justify-center">
<!-- –î–æ—Ö–æ–¥—ã -->
<div class="glass-wrap">
  <div class="glass">
      <!--‚Ää–∞–∫—Ç–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ (–¥–Ω–æ) -->
      <div id="glassIncomeActive"  class="liquid-glass" style="background:#82A8AB"></div>
      <!--‚Ää–ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ (–Ω–∞–¥ –∞–∫—Ç–∏–≤–Ω—ã–º) -->
      <div id="glassIncomePassive" class="liquid-glass" style="background:#4ade80"></div>
  </div>
  <p class="mt-1 font-semibold text-center text-sm">–î–æ—Ö–æ–¥—ã</p>
</div>

    <!-- –†–∞—Å—Ö–æ–¥—ã -->
    <div class="glass-wrap">
      <div class="glass"><div id="glassExpenses" class="liquid-glass" style="background:#A77F4B"></div></div>
      <p class="mt-1 font-semibold text-center text-sm">–†–∞—Å—Ö–æ–¥—ã</p>
    </div>

    <!-- –°–±–µ—Ä–µ–∂–µ–Ω–∏—è -->
    <div class="glass-wrap">
      <div class="glass"><div id="glassSavings" class="liquid-glass" style="background:#728565"></div></div>
      <p class="mt-1 font-semibold text-center text-sm">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è</p>
    </div>

    <!-- –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ -->
    <div class="glass-wrap">
      <div class="glass"><div id="glassInvest" class="liquid-glass" style="background:#3B4550"></div></div>
      <p class="mt-1 font-semibold text-center text-sm">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</p>
    </div>

    <!-- –°–ø–µ–∫—É–ª—è—Ü–∏–∏ (–ø—É—Å—Ç–æ–π) -->
    <div class="glass-wrap">
      <div class="glass"><div id="glassSpec" class="liquid-glass" style="background:#BF8200"></div></div>
      <p class="mt-1 font-semibold text-center text-sm">–°–ø–µ–∫—É–ª—è—Ü–∏–∏</p>
    </div>
  </div>

 <!-- ‚îÄ‚îÄ ‚ë° –ó–¥–æ—Ä–æ–≤—å–µ + –°—á–∞—Å—Ç—å–µ + –ë–∞–ª–ª—ã ‚îÄ‚îÄ -->
<div class="p-4 bg-white/70 rounded-lg shadow flex gap-6 justify-center items-end mx-auto">

  <!-- –ó–¥–æ—Ä–æ–≤—å–µ -->
  <div class="glass-wrap">
    <div class="vbar">
      <div id="vHealthFill" class="vbar-fill" style="background:#22c55e"></div>
      <span id="vHealthTxt" class="vbar-text">100%</span>
    </div>
    <p class="mt-1 font-semibold text-center text-sm">–ó–¥–æ—Ä–æ–≤—å–µ</p>
  </div>

  <!-- –°—á–∞—Å—Ç—å–µ -->
  <div class="glass-wrap">
    <div class="vbar">
      <div id="vHappyFill" class="vbar-fill" style="background:#facc15"></div>
      <span id="vHappyTxt" class="vbar-text">100%</span>
    </div>
    <p class="mt-1 font-semibold text-center text-sm">–°—á–∞—Å—Ç—å–µ</p>
  </div>

  <!-- –ë–∞–ª–ª—ã -->
  <div class="glass-wrap">
    <div class="mini-chart-box">
      <canvas id="scoreChart"></canvas>
      <span id="scoreBig">0</span>
    </div>
    <p class="mt-1 font-semibold text-center text-sm">–ë–∞–ª–ª—ã</p>
  </div>
</div>

</div> <!-- –∫–æ–Ω–µ—Ü flex-–æ–±—ë—Ä—Ç–∫–∏ dashboard -->

 <!-- –î–æ—Ö–æ–¥—ã / –†–∞—Å—Ö–æ–¥—ã / –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞ -->
<div class="p-4 bg-white/70 rounded-lg shadow inline-block">
  <div class="grid grid-cols-3 gap-6">      <!-- ‚ù∂ –æ–¥–Ω–∞ —Å–µ—Ç–∫–∞ -->
    <!-- –î–æ—Ö–æ–¥—ã -->
    <div>
      <label class="block font-semibold mb-1">–î–æ—Ö–æ–¥—ã ($)</label>
      <p id="incomeDisplay"
         class="w-40 border p-2 rounded bg-gray-50">$0</p>
    </div>

    <!-- –†–∞—Å—Ö–æ–¥—ã -->
    <div>
      <label class="block font-semibold mb-1">–†–∞—Å—Ö–æ–¥—ã ($)</label>
      <p id="expensesDisplay"
         class="w-40 border p-2 rounded bg-gray-50">$0</p>
    </div>

    <!-- –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞ -->
    <div>
      <label for="extra" class="block font-semibold mb-1">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</label>
      <select id="extra"
              class="w-40 border p-2 rounded">
        <option value="–Ω–µ—Ç">–ù–µ—Ç</option>
        <option value="–¥–∞">–î–∞</option>
      </select>
    </div>
  </div>                                     <!-- /grid -->
</div>                                       <!-- /card -->

<!-- –®–µ—Å—Ç—å –∫—É–≤—à–∏–Ω–æ–≤-–ø–æ–ª–∑—É–Ω–∫–æ–≤ -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê –ë–∞–Ω–∫–∏: 3 –≥—Ä—É–ø–ø—ã + 9 –±–µ–≥—É–Ω–∫–æ–≤ –≤ –æ–¥–Ω—É –ª–∏–Ω–∏—é ‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="grid gap-6 mb-8
            lg:grid-cols-9               <!-- –Ω–∞ —à–∏—Ä–æ–∫–æ–º —ç–∫—Ä–∞–Ω–µ 9 —Ä–∞–≤–Ω—ã—Ö —è—á–µ–µ–∫ -->
            sm:grid-cols-3">             <!-- –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–æ 3 -->

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ó–∞–≥–æ–ª–æ–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∞ 1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="col-span-3 text-center text-lg font-semibold">
    –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å —É–≤–µ–ª–∏—á–∏—Ç—å —Å–≤–æ–∏ –¥–æ—Ö–æ–¥—ã
  </div>
  <div class="col-span-3 text-center text-lg font-semibold">
    –ó–¥–µ—Å—å —Ç—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—à—å —Å–≤–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã
  </div>
  <div class="col-span-3 text-center text-lg font-semibold">
    –ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –∫–∞–∫ –º–Ω–æ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å, —Ç–∞–∫ –∏ –ø–æ—Ç–µ—Ä—è—Ç—å
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ë–∞–Ω–∫–∏ (—Å—Ç—Ä–æ–∫–∞ 2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

  <!-- –°–±–µ—Ä–µ–∂–µ–Ω–∏—è -->
  <div class="jar-wrap">
    <div class="jar"><div id="saveFill" class="liquid"></div></div>
    <div id="saveSlider" class="slider-v"></div>
    <div class="jar-caption">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è<br><span id="saveLabel">0</span> $</div>
    <input id="save" type="hidden" class="hidden-field" value="0">
  </div>

  <!-- –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ -->
  <div class="jar-wrap">
    <div class="jar"><div id="investFill" class="liquid"></div></div>
    <div id="investSlider" class="slider-v"></div>
    <div class="jar-caption">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏<br><span id="investVal">0</span> $</div>
    <input id="invest" type="hidden" class="hidden-field" value="0">
  </div>

  <!-- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ -->
  <div class="jar-wrap">
    <div class="jar"><div id="eduFill" class="liquid"></div></div>
    <div id="eduSlider" class="slider-v"></div>
    <div class="jar-caption">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ<br><span id="eduVal">0</span> $</div>
    <input id="edu" type="hidden" class="hidden-field" value="0">
  </div>

  <!-- –í—ã–∂–∏–≤–∞–Ω–∏–µ -->
  <div class="jar-wrap">
    <div class="jar"><div id="survivalFill" class="liquid"></div></div>
    <div id="survivalSlider" class="slider-v"></div>
    <div class="jar-caption">–í—ã–∂–∏–≤–∞–Ω–∏–µ<br><span id="survivalVal">500</span> $</div>
    <input id="survival" type="hidden" class="hidden-field" value="500">
  </div>

  <!-- –ö–æ–º—Ñ–æ—Ä—Ç -->
  <div class="jar-wrap">
    <div class="jar"><div id="comfortFill" class="liquid"></div></div>
    <div id="comfortSlider" class="slider-v"></div>
    <div class="jar-caption">–ö–æ–º—Ñ–æ—Ä—Ç<br><span id="comfortVal">500</span> $</div>
    <input id="comfort" type="hidden" class="hidden-field" value="500">
  </div>

  <!-- –ó–¥–æ—Ä–æ–≤—å–µ -->
  <div class="jar-wrap">
    <div class="jar"><div id="healthFill" class="liquid"></div></div>
    <div id="healthSpendSlider" class="slider-v"></div>
    <div class="jar-caption">–ó–¥–æ—Ä–æ–≤—å–µ<br><span id="healthVal">0</span> $</div>
    <input id="healthSpend" type="hidden" class="hidden-field" value="0">
  </div>

  <!-- –°–ø–µ–∫—É–ª—è—Ü–∏–∏ -->
  <div class="jar-wrap">
    <div class="jar"><div id="specFill" class="liquid"></div></div>
    <div id="specSlider" class="slider-v"></div>
    <div class="jar-caption">–°–ø–µ–∫—É–ª—è—Ü–∏–∏<br><span id="specVal">0</span> $</div>
    <input id="spec" type="hidden" class="hidden-field" value="0">
  </div>

  <!-- –ë–∏–∑–Ω–µ—Å -->
  <div class="jar-wrap">
    <div class="jar"><div id="businessFill" class="liquid"></div></div>
    <div id="businessSlider" class="slider-v"></div>
    <div class="jar-caption">–ë–∏–∑–Ω–µ—Å<br><span id="businessVal">0</span> $</div>
    <input id="business" type="hidden" class="hidden-field" value="0">
  </div>

  <!-- –§—Ä–∏–ª–∞–Ω—Å -->
  <div class="jar-wrap">
    <div class="jar"><div id="freelanceFill" class="liquid"></div></div>
    <div id="freelanceSlider" class="slider-v"></div>
    <div class="jar-caption">–§—Ä–∏–ª–∞–Ω—Å<br><span id="freelanceVal">0</span> $</div>
    <input id="freelance" type="hidden" class="hidden-field" value="0">
  </div>

</div>

  <!-- –ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="text-center space-y-2">
    <p>–•–æ–¥: <span id="turn">0</span> / <span id="maxTurns">0</span></p>
    <p>–°–æ–±—ã—Ç–∏–µ: <span id="event">-</span></p>
    <p>–°–≤–æ–±–æ–¥–Ω—ã–µ –¥–µ–Ω—å–≥–∏: <span id="free">$0</span></p>
    <p>–°–±–µ—Ä–µ–∂–µ–Ω–∏—è: <span id="savings">$0</span></p>
    <p>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: <span id="investments">$0</span></p>
  <p class="text-sm text-gray-600">
  <span id="goalPercentMini">0</span>% &nbsp;|&nbsp;
  –æ—Å—Ç–∞–ª–æ—Å—å <span id="goalLeftMini">‚Äì</span>
</p>
  </div>

  <!-- –ò—Å—Ç–æ—Ä–∏—è -->
  <div class="mt-8">
    <h2 class="text-xl font-bold text-center mb-2">üìò –ò—Å—Ç–æ—Ä–∏—è —Ö–æ–¥–æ–≤</h2>
    <table class="w-full text-sm bg-white rounded shadow overflow-hidden">
      <thead class="bg-gray-200 font-bold">
        <tr>
          <th class="p-2">–•–æ–¥</th><th class="p-2">–°–æ–±—ã—Ç–∏–µ</th><th class="p-2">–°–≤–æ–±–æ–¥–Ω—ã–µ $</th>
          <th class="p-2">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è</th><th class="p-2">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</th>
          <th class="p-2">–ó–¥–æ—Ä–æ–≤—å–µ</th><th class="p-2">–°—á–∞—Å—Ç—å–µ</th>
        </tr>
      </thead>
      <tbody id="historyTable" class="text-center"></tbody>
    </table>
  </div>
</div> <!-- ‚Üê –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è <div id="game-screen"> -->

<button id="openAch"
        class="fixed top-4 right-4 z-30 bg-yellow-500 text-white
               w-12 h-12 rounded-full shadow-md">
  üèÜ
  <span id="achCount"
        class="absolute -top-1 -right-1 bg-red-600 text-xs
               rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
</button>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div id="achModal" class="fixed inset-0 bg-black/60 hidden
            items-center justify-center z-40">
  <div class="bg-white rounded shadow p-6 w-11/12 max-w-md">
    <h3 class="text-xl font-bold mb-4">–ú–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
    <table class="w-full text-sm" id="achTable"></table>
    <button id="resetAch"
        class="mt-3 text-sm text-red-600 underline">–°–±—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    </button>
    <button id="resetBest"
        class="mt-1 text-sm text-red-600 underline">–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã
    </button>
    <button id="closeAch" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">
      –ó–∞–∫—Ä—ã—Ç—å
    </button>
  </div>
</div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ ? –∏ –ø–∞–Ω–µ–ª—å FAQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<button id="openFaq" class="fixed top-4 right-20 z-30
        bg-indigo-500 text-white w-12 h-12 rounded-full shadow-md">
  ?
</button>

<div id="faqPanel" class="fixed top-0 left-0 h-full w-72 bg-white/95
     shadow-lg p-6 space-y-4 overflow-y-auto transition-transform
     -translate-x-full z-40">
  <h3 class="text-xl font-bold mb-4">–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>

  <details open>
    <summary class="font-semibold cursor-pointer">–ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥?</summary>
    <p class="mt-2 text-sm leading-snug">
      ‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥—Ä–∞–±–æ—Ç–∫—É (–Ω–æ —Å—á–∞—Å—Ç—å–µ —Å–Ω–∏–∑–∏—Ç—Å—è).<br>
      ‚Ä¢ –£–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî —ç—Ç–æ —Ä–∞—Å—Ç–∏—Ç –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥.<br>
      ‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ‚Üí –ø–æ–≤—ã—à–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã –Ω–∞ 10% –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π.
    </p>
  </details>

  <details>
    <summary class="font-semibold cursor-pointer">–ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –ø–æ–¥—É—à–∫–∞?</summary>
    <p class="mt-2 text-sm leading-snug">
      –ë–µ–∑ –Ω–µ—ë —Å—á–∞—Å—Ç—å–µ –ø–∞–¥–∞–µ—Ç. –ü–æ–¥—É—à–∫–∞ ‚â• 3 –º–µ—Å—è—Ü–µ–≤ –¥–∞—ë—Ç +1 –∫ —Å—á–∞—Å—Ç—å—é.
    </p>
  </details>

  <details>
  <summary class="font-semibold cursor-pointer">
    –ö–∞–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–±–ª–∏–∂–∞—é—Ç –∏–ª–∏ –æ—Ç–¥–∞–ª—è—é—Ç –æ—Ç —Ü–µ–ª–∏?
  </summary>
  <div class="mt-2 text-sm leading-snug space-y-1">
    <p><strong>‚è© –ü—Ä–∏–±–ª–∏–∂–∞—é—Ç</strong>:<br>
       ‚Ä¢ –û—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å ‚â• 10 % –¥–æ—Ö–æ–¥–∞ ‚Üó ¬´–ø–æ–¥—É—à–∫–∞¬ª<br>
       ‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å ‚â• 15 % –¥–æ—Ö–æ–¥–∞ ‚Üó –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥<br>
       ‚Ä¢ –î–µ—Ä–∂–∞—Ç—å –∫–æ–º—Ñ–æ—Ä—Ç ‚â§ 40 % –¥–æ—Ö–æ–¥–∞ ‚Üó —Å—á–∞—Å—Ç—å–µ<br>
       ‚Ä¢ –¢—Ä–∞—Ç–∏—Ç—å –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ/–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ‚â§ —Ä–∞–∑—É–º–Ω—ã—Ö 10 %</p>
    <p><strong>‚è™ –û—Ç–¥–∞–ª—è—é—Ç</strong>:<br>
       ‚Ä¢ –ö–æ–º—Ñ–æ—Ä—Ç &gt; 50 % ‚Äî —Å—á–∞—Å—Ç—å–µ ‚Üì, ¬´–ø–æ–¥—É—à–∫–∞¬ª –Ω–µ —Ä–∞—Å—Ç—ë—Ç<br>
       ‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π ‚Äî —à—Ç—Ä–∞—Ñ –∫ —Å—á–∞—Å—Ç—å—é<br>
       ‚Ä¢ –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ –æ—Ç–¥—ã—Ö–∞ ‚Äî —Å—á–∞—Å—Ç—å–µ ‚Äì3 –µ–¥. –∑–∞ —Ö–æ–¥<br>
       ‚Ä¢ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è ‚Äî –ø—Ä—è–º–æ–π —É—Ä–æ–Ω –∑–¥–æ—Ä–æ–≤—å—é</p>
  </div>
</details>

<details>
  <summary class="font-semibold cursor-pointer">
    –ß—Ç–æ —Ç–∞–∫–æ–µ ¬´—Ö–æ–¥¬ª –∏ –∫–∞–∫ –æ–Ω –¥–µ–ª–∞–µ—Ç—Å—è?
  </summary>
  <p class="mt-2 text-sm leading-snug">
    –û–¥–∏–Ω —Ö–æ–¥ ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–µ—Å—è—Ü. –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É <kbd>‚ñ∂</kbd> –≤—ã
    ¬´–ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç–µ¬ª –º–µ—Å—è—Ü –≤–ø–µ—Ä—ë–¥: –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è,
    —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è/–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ —Ä–∞—Å—Ç—É—Ç (–∏–ª–∏ –ø–∞–¥–∞—é—Ç), —Å–ª—É—á–∞—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è,<br>
    –∞ –∑–¥–æ—Ä–æ–≤—å–µ –∏ —Å—á–∞—Å—Ç—å–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è.
  </p>
</details>

<details>
  <summary class="font-semibold cursor-pointer">
    –ò–∑ —á–µ–≥–æ —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –¥–æ—Ö–æ–¥—ã?
  </summary>
  <p class="mt-2 text-sm leading-snug">
    ‚Ä¢ <strong>–ê–∫—Ç–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</strong> ‚Äî –≤–∞—à–∞ –∑–∞—Ä–ø–ª–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é $1 000).<br>
    &nbsp;&nbsp;‚Ä¢ –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—ë—Ç +$200, –Ω–æ ‚Äì3 –µ–¥. —Å—á–∞—Å—Ç—å—è.<br>
    &nbsp;&nbsp;‚Ä¢ –ö–∞–∂–¥—ã–π $100, –≤–ª–æ–∂–µ–Ω–Ω—ã–π –≤ ¬´–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ¬ª, –ø–æ–≤—ã—à–∞–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—É
      –Ω–∞&nbsp;$10 (10 %).<br>
    ‚Ä¢ <strong>–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</strong> ‚Äî 5 % –≥–æ–¥–æ–≤—ã—Ö –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π +
      3 % –≥–æ–¥–æ–≤—ã—Ö –æ—Ç —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π, –¥–µ–ª—ë–Ω–Ω—ã–µ –Ω–∞ 12.
  </p>
</details>

<details>
  <summary class="font-semibold cursor-pointer">
    –ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä–∞—Å—Ö–æ–¥–∞–º–∏?
  </summary>
  <p class="mt-2 text-sm leading-snug">
    –í—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç–µ —Å–µ–º—å ¬´–∫—É–≤—à–∏–Ω–æ–≤¬ª-–∫–∞—Ç–µ–≥–æ—Ä–∏–π:<br>
    ‚Ä¢ –í—ã–∂–∏–≤–∞–Ω–∏–µ&nbsp;(–µ–¥–∞, –∂–∏–ª—å—ë)‚ÄÉ‚Ä¢ –ö–æ–º—Ñ–æ—Ä—Ç‚ÄÉ‚Ä¢ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è‚ÄÉ‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏<br>
    ‚Ä¢ –°–ø–µ–∫—É–ª—è—Ü–∏–∏‚ÄÉ‚Ä¢ –ó–¥–æ—Ä–æ–≤—å–µ‚ÄÉ‚Ä¢ –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ<br>
    –°—É–º–º–∞ –≤—Å–µ—Ö –∫—É–≤—à–∏–Ω–æ–≤ = –º–µ—Å—è—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã. –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω
    ¬´–ê–≤—Ç–æ–¥–æ–ª–∏–≤¬ª, —Å–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–∫–∏–¥—ã–≤–∞–µ—Ç—Å—è –≤ ¬´–°–±–µ—Ä–µ–∂–µ–Ω–∏—è¬ª.
  </p>
</details>

<details>
  <summary class="font-semibold cursor-pointer">
    –ü–æ—á–µ–º—É ¬´–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏¬ª –∏ ¬´–°–ø–µ–∫—É–ª—è—Ü–∏–∏¬ª –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ —Ç—Ä–∞—Ç–∞?
  </summary>
  <p class="mt-2 text-sm leading-snug">
    –ù–∞ –≥—Ä–∞—Ñ–∏–∫–µ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Ö–æ–¥&nbsp;‚Äî –≤—ã –≤—ã–≤–æ–¥–∏—Ç–µ –¥–µ–Ω—å–≥–∏
    ¬´–∏–∑ –∫–æ—à–µ–ª—å–∫–∞¬ª.<br>
    ‚Ä¢ <strong>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</strong> ‚Üí –ø–æ–ø–æ–ª–Ω—è—é—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –¥–∞—ë—Ç
      +5 % –≥–æ–¥–æ–≤—ã—Ö –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞.<br>
    ‚Ä¢ <strong>–°–ø–µ–∫—É–ª—è—Ü–∏–∏</strong> ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—á—ë—Ç —Å –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é
      (-1 %‚Ä¶+3 % –≤&nbsp;–ª–µ–≥–∫–æ–º —Ä–µ–∂–∏–º–µ, -10 %‚Ä¶+10 % –≤&nbsp;—Å–ª–æ–∂–Ω–æ–º).
      –ü—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ —Å–æ–±—ã—Ç–∏–µ ¬´—Å–ø–µ–∫—É–ª—è—Ü–∏–∏ ¬±$...¬ª.
  </p>
</details>
</div>
<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –∫–æ–Ω–µ—Ü FAQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>

  const difficulties = {
  /* ----------  EASY  -------------------------------------- */
  easy : {
    /* —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–≥—É–Ω–∫–∞–º–∏ */
    sliderStep      : 100,     // —à–∞–≥ –ø–æ–ª–∑—É–Ω–∫–∞, $   (–∫—Ä—É–ø–Ω—ã–π ‚Äì –º–µ–Ω—å—à–µ ¬´–≤–æ–∑–Ω–∏¬ª)

    /* —Å–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è */
    eventProb       : 0.25,    // —Å—É–º–º–∞—Ä–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ ¬´—á—Ç–æ-—Ç–æ¬ª —Å–ª—É—á–∏—Ç—Å—è
    eventWeights    : {        // –∫–∞–∫ –¥–µ–ª–∏—Ç—Å—è eventProb
      minorExpense  : 0.50,    // 50 % –æ—Ç eventProb ‚Üí –º–µ–ª–∫–∞—è —Ç—Ä–∞—Ç–∞
      crisis        : 0.25,    // 25 %            ‚Üí –æ–±–≤–∞–ª –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
      sickness      : 0.25     // 25 %            ‚Üí –±–æ–ª–µ–∑–Ω—å
    },
    minorExpense$   : 30,      // —Ä–∞–∑–º–µ—Ä –º–µ–ª–∫–æ–π —Ç—Ä–∞—Ç—ã
    crisisLossPct   : 0.04,    // -4 % –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
    sicknessHP      : 3,       // -3 –∑–¥–æ—Ä–æ–≤—å—è

    /* —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø–æ—Å–ª–∞–±–ª–µ–Ω–∏—è */
    startBonus$     : 0      // +$0 –∫ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è–º –≤ –Ω–∞—á–∞–ª–µ
  },

  /* ----------  NORMAL  ------------------------------------ */
  normal : {
    sliderStep      : 10,
    eventProb       : 0.35,
    eventWeights    : { minorExpense:0.45, crisis:0.30, sickness:0.25 },
    minorExpense$   : 50,
    crisisLossPct   : 0.06,
    sicknessHP      : 5,
    startBonus$     : 0
  },

  /* ----------  HARD  -------------------------------------- */
  hard : {
    sliderStep      : 1,
    eventProb       : 0.45,
    eventWeights    : { minorExpense:0.40, crisis:0.35, sickness:0.25 },
    minorExpense$   : 70,
    crisisLossPct   : 0.08,
    sicknessHP      : 7,
    startBonus$     : -200     // –Ω–∞—á–∏–Ω–∞–µ–º ¬´–≤ –º–∏–Ω—É—Å–µ¬ª (–¥–æ–ª–≥)
  }
};

  let turn = 0, maxTurns = 0;
  let savings = 0, investments = 0;
  let specBalance = 0; let startSpec = 0;
let businessBalance = 0;   // —Ç–µ–∫—É—â–∏–π –∫–∞–ø–∏—Ç–∞–ª –±–∏–∑–Ω–µ—Å–∞
let businessTier    = 0;   // 0 ‚Äì –Ω–µ—Ç, 1 ‚Äì –º–∞–ª—ã–π, 2 ‚Äì —Å—Ä–µ–¥–Ω–∏–π, 3 ‚Äì –∫—Ä—É–ø–Ω—ã–π
  let health = 100, happiness = 100;
  let startSavings = 0, startInvestments = 0;
  const scores = [];
let activeRules = [];        // –ø—Ä–∞–≤–∏–ª–∞ —Ç–µ–∫—É—â–µ–π —Ä–æ–ª–∏
let bonusFlag   = false;     // true ‚Üí ¬±5 –∫ happiness
let currentGoal = null;      // –æ–±—ä–µ–∫—Ç —Ü–µ–ª–∏ –∏–ª–∏ null
  /* —Ç–µ–∫—É—â–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å ‚Äî –∑–∞–ø–æ–ª–Ω–∏–º –≤ startGame() */
let currentDiff = difficulties.easy;   // default
let currentDiffKey  = 'easy';
document.addEventListener('DOMContentLoaded', ()=>{

const goals = {
  buffer : { key:'buffer',  text:'–ü–æ–¥—É—à–∫–∞ –Ω–∞ 3 –º–µ—Å—è—Ü–∞',   check:g=>g.savings>=g.monthExpenses*3 },
  passive: { key:'passive', text:'–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ $1000/–º–µ—Å', check:g=>g.passiveIncome>=1000 },
  tenk   : { key:'tenk',    text:'–ù–∞–∫–æ–ø–∏—Ç—å $10 000',        check:g=>g.savings>=10000 },
  double : { key:'double', text :'–£–¥–≤–æ–∏—Ç—å –∫–∞–ø–∏—Ç–∞–ª',    // —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å —Ç–µ–º, —á—Ç–æ –±—ã–ª–æ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã
    check: g => (g.savings + g.investments) >= (startSavings + startInvestments) * 2
  }
};

  const BASE_INCOME = 1000;        // –±–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞, –ø–æ –Ω–µ–π –∫–∞–ª–∏–±—Ä—É–µ–º —Å—Ç–∞–∫–∞–Ω
  let salaryBonus = 0;   // –≤—Å—ë, —á—Ç–æ ¬´–Ω–∞–∫–∏–Ω—É–ª–∏¬ª –∑–∞ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
  const SURV_SAFE       = 500;  // <$ 500  ‚Üí —É–±—ã–ª—å –∑–¥–æ—Ä–æ–≤—å—è
  const SURV_BONUS      = 600;  // >=600‚ÄÇ  ‚Üí +5 –∑–¥–æ—Ä–æ–≤—å—è –∑–∞ —Ö–æ–¥
  const COMF_SAFE       = 300;  // <$ 300  ‚Üí —É–±—ã–ª—å —Å—á–∞—Å—Ç—å—è
  const COMF_BONUS      = 400;  // >=400‚ÄÇ  ‚Üí +2 —Å—á–∞—Å—Ç—å—è –∑–∞ —Ö–æ–¥
  const HAPPY_K    = 12;     // –º–∞–∫—Å–∏–º—É–º ‚àí12 –µ–¥. —Å—á–∞—Å—Ç—å—è –∑–∞ —Ö–æ–¥
  const HAPPY_BONUS_THRESHOLD = 400; // ‚â•400 $ –¥–∞—ë—Ç –Ω–µ–±–æ–ª—å—à–æ–π –ø–ª—é—Å
  const FREEL_INCOME_K   = 1.0;   // $1 –¥–æ—Ö–æ–¥–∞ –Ω–∞ $1 –±–µ–≥—É–Ω–∫–∞
  const FREEL_HAPPY_STEP = 100;   // ‚Äì1 —Å—á–∞—Å—Ç—å—è –∑–∞ –∫–∞–∂–¥—ã–µ $200 —Ñ—Ä–∏–ª–∞–Ω—Å–∞
  const FREEL_HEALTH_STEP  = 100;   // ‚Äì1 HP    –∑–∞ –∫–∞–∂–¥—ã–µ $300
  
  const achievements = [
  { id:'save100',   text:'–ü–µ—Ä–≤—ã–µ $100 —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π',        check:g=>g.savings >= 100           },
  { id:'save1k',    text:'–°–±–µ—Ä–µ–∂–µ–Ω–∏—è $1 000',             check:g=>g.savings >= 1000          },
  { id:'invest5k',  text:'–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ $5 000',             check:g=>g.investments >= 5000      },
  { id:'health100', text:'–í–µ—Ä–Ω—É—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –¥–æ 100 %',     check:g=>g.health === 100           },
  { id:'specGuru',  text:'x2 –∫–∞–ø–∏—Ç–∞–ª –∑–∞ —Å—á—ë—Ç —Å–ø–µ–∫—É–ª—è—Ü–∏–π', check:g => g.startSpec > 0 && g.specBalance >= g.startSpec * 2 }
];

  /* === localStorage helpers for achievements ================= */
  function loadAch(){
    return JSON.parse(localStorage.fiveJarsAchievements || '{}');
  }
  function saveAch(obj){
    localStorage.fiveJarsAchievements = JSON.stringify(obj);
  }
  /* —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π: {id: timestamp, ‚Ä¶}  */
  let achState = loadAch();

  /* === –ª–∏—á–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ============== */
function loadBest(name){
  /* —Ö—Ä–∞–Ω–∏—Ç—Å—è JSON-–æ–±—ä–µ–∫—Ç –≤–∏–¥–∞ {"easy":123,"normal":456,"hard":789} */
  return JSON.parse(localStorage.getItem('fiveJars_'+name) || '{}');
}
function getBest(name, diff){
  const obj = loadBest(name);
  return obj[diff] ?? 0;
}
function saveBest(name, diff, val){
  const obj = loadBest(name);
  obj[diff] = val;
  localStorage.setItem('fiveJars_'+name, JSON.stringify(obj));
}
/* –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∫–æ—Ä–¥—ã —Ç–µ–∫—É—â–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ */
function updatePersonalBests(score, turns, diff){
  if (score > getBest('bestScore', diff))  saveBest('bestScore', diff, score);
  if (turns > getBest('bestTurns', diff))  saveBest('bestTurns', diff, turns);
}

const tutSlides = [          // –º–∏–Ω–∏-—Ç—É—Ç–æ—Ä–∏–∞–ª –¥–ª—è Saver
  ['–®–∞–≥ 1/3','–û—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ ‚â• 10 % –¥–æ—Ö–æ–¥–∞ ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ ¬´–ø–æ–¥—É—à–∫—É¬ª.'],
  ['–®–∞–≥ 2/3','–ü–æ–¥—É—à–∫–∞ –Ω–∞ 3 –º–µ—Å ‚Üí –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ ‚â• 15 %.'],
  ['–®–∞–≥ 3/3','–ë–∞–∑–æ–≤—ã–µ —Ç—Ä–∞—Ç—ã ‚â§ 50 % –¥–æ—Ö–æ–¥–∞.']
];

  /* —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ä—Ç-—ç–∫—Ä–∞–Ω–∞ */
const roleBlock   = document.getElementById('roleBlock');
const goalBlock   = document.getElementById('goalBlock');
const goalHeader  = document.getElementById('goalHeader');
const startScreen = document.getElementById('start-screen');
const gameScreen  = document.getElementById('game-screen');

  /* ====== –∫–Ω–æ–ø–∫–∞ ¬´üèÜ¬ª –∏ –º–æ–¥–∞–ª–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π ====== */
  document.getElementById('openAch').onclick =
    () => document.getElementById('achModal').classList.remove('hidden');

  document.getElementById('closeAch').onclick =
    () => document.getElementById('achModal').classList.add('hidden');

  document.getElementById('resetAch').onclick = ()=>{
  if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è?')){
    achState = {};
    saveAch(achState);
    renderAchTable();
    updateTrophyCounter();
  }
};

  document.getElementById('resetBest').onclick = ()=>{
  if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ª–∏—á–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã?')){
    localStorage.removeItem('fiveJars_bestScore');
    localStorage.removeItem('fiveJars_bestTurns');
    toast('–†–µ–∫–æ—Ä–¥—ã –æ–±–Ω—É–ª–µ–Ω—ã');
  }
};
  
  function renderAchTable(){
    const tb = document.getElementById('achTable');
    tb.innerHTML = achievements.map(a=>{
      const ok = !!achState[a.id];
      return `<tr>
        <td class="p-1 pr-3">${ok ? '‚úÖ' : '‚¨úÔ∏è'}</td>
        <td class="p-1">${a.text}</td>
        <td class="p-1 text-xs text-gray-500">
             ${ok ? new Date(achState[a.id]).toLocaleDateString() : '‚Äî'}
        </td>
      </tr>`;
    }).join('');
  }
  renderAchTable();   // –ø–µ—Ä–≤–∏—á–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞

/* === —Å—á—ë—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–µ "üèÜ" ============================= */
function updateTrophyCounter(){
  const unlocked = Object.keys(achState).length;   // —Å–∫–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç–æ
  const total    = achievements.length;

  const badge = document.getElementById('achCount');
  badge.textContent = unlocked;            // –ø–∏—à–µ–º —á–∏—Å–ª–æ

  // --- –≤–∞—Ä–∏–∞–Ω—Ç ¬´–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–µ–≥–¥–∞¬ª ---
badge.classList.remove('hidden');        // –±–µ–∑ toggle

if (unlocked === 0){
  badge.classList.add   ('bg-gray-400');
  badge.classList.remove('bg-red-600','bg-green-600');
}else if (unlocked === total){
  badge.classList.add   ('bg-green-600');
  badge.classList.remove('bg-gray-400','bg-red-600');
}else{
  badge.classList.add   ('bg-red-600');
  badge.classList.remove('bg-gray-400','bg-green-600');
}

  // (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞—Ç—å –ø—Ä–∏ 100 %
  if (unlocked === total) {
    badge.classList.add ('bg-green-600');
    badge.classList.remove('bg-red-600');
  } else {
    badge.classList.add ('bg-red-600');
    badge.classList.remove('bg-green-600');
  }
}
  
  /* === –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ –ë–∞–ª–ª–æ–≤ === */
  const chart = new Chart(document.getElementById('scoreChart').getContext('2d'),{
    type:'line',
    data:{labels:[],datasets:[{data:[], borderColor:'#3b82f6', borderWidth:1,
                               tension:0.3, fill:false, pointRadius:0}]},
    options:{responsive:false, animation:false,
             scales:{x:{display:false}, y:{display:false}},
             plugins:{legend:{display:false}, tooltip:{enabled:false}}}
  });

  /* –∫—É–≤—à–∏–Ω-–ø–æ–ª–∑—É–Ω–æ–∫ */
function buildJar(sliderId, fillId, valId, hiddenId, minVal, maxVal){

  const slider = document.getElementById(sliderId);
  const fill   = document.getElementById(fillId);
  const valEl  = document.getElementById(valId);
  const hidden = document.getElementById(hiddenId);

  noUiSlider.create(slider,{
    start      : +hidden.value, orientation: 'vertical',
    direction  : 'rtl',
    step       : 10, connect: [true,false],
    range      : { min: minVal,  max: maxVal }
  });

  slider.noUiSlider.on('update', v=>{
    const num = Math.round(v[0]);
    fill.style.height = (num / maxVal * 100) + '%';
    valEl.textContent = num;
    hidden.value      = num;
    updateIncomeExpenses();
  });
}

      /* --- –ø—Ä–µ—Å–µ—Ç—ã —Ä–æ–ª–µ–π (–ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç –ë–ê–ó–û–í–û–ì–û –¥–æ—Ö–æ–¥–∞ 1000 $) --- */
const rolePresets = {
  /* min / max ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç –¥–æ—Ö–æ–¥–∞; buf ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è ¬´–ø–æ–¥—É—à–∫–∞¬ª –≤ –º–µ—Å—è—Ü–∞—Ö */
  Saver : {
    plan  : {survival:50, comfort:50, save:0, invest:0, healthSpend:0, edu:0, spec:0},
    rules : [
      {type:'min', jar:'save',   value:10},
      {type:'comfortMax', max:50},
    ],
    bonus:+5, // —É—Å–ø–µ—Ö ‚Üí +5 happiness, –ø—Ä–æ–≤–∞–ª ‚Üí ‚Äì5
    goalKey : 'buffer'
  },
  Investor : {
    plan  : {survival:50, comfort:50, save:0, invest:0, healthSpend:0, edu:0, spec:0},
    rules : [
      {type:'min', jar:'invest', value:15},
      {type:'comfortMax', max:55},
    ],
    bonus:+5,
    goalKey : 'passive'
  },
Spec : {
  plan  : {survival:50, comfort:50, save:0, invest:0, healthSpend:0, edu:0, spec:0},
  rules : [
    { type:'min', jar:'spec', value:10 },
    { type:'comfortMax', max:55 }
  ],
  bonus:false,
  goalKey:'double'
}
};

/* === –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Ü–µ–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–æ–ª–∏ ==================== */
function updateRoleGoalHint(){
  const role = document.querySelector('input[name="role"]:checked')?.value;
  if (!role) return;

  const goalKey = rolePresets[role].goalKey;     // buffer / passive / double ‚Ä¶
  const text    = goals[goalKey].text;
  document.getElementById('roleGoalHint').textContent = '–¶–µ–ª—å: ' + text;
}

/* —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–ª–∏ */
document.querySelectorAll('input[name="role"]').forEach(r=>{
  r.addEventListener('change', updateRoleGoalHint);
});

/* –≤—ã–∑–≤–∞—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
updateRoleGoalHint();


/* —É–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –¥–≤–∏–≥–∞–µ–º —Å–ª–∞–π–¥–µ—Ä –ø–æ id –Ω–∞ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ */
function setSlider(id, value){
  document.getElementById(id + 'Slider').noUiSlider.set(value);
};

  /* —à–µ—Å—Ç—å –∫—É–≤—à–∏–Ω–æ–≤ */

buildJar('survivalSlider', 'survivalFill', 'survivalVal', 'survival', 100, 500);
buildJar('comfortSlider',  'comfortFill',  'comfortVal',  'comfort',  0,   2000);
buildJar('saveSlider',     'saveFill',     'saveLabel',   'save',     0,   2000);
buildJar('investSlider',   'investFill',   'investVal',   'invest',   0,   2000);
buildJar('healthSpendSlider','healthFill', 'healthVal',   'healthSpend',0, 2000);
buildJar('eduSlider',      'eduFill',      'eduVal',      'edu',      0,   2000);
buildJar('specSlider','specFill','specVal','spec',0,2000);
buildJar('businessSlider', 'businessFill', 'businessVal', 'business',  0, 2000);
buildJar('freelanceSlider','freelanceFill','freelanceVal','freelance', 0, 2000);


  /* –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–∏—Ö —Å—Ç–∞–∫–∞–Ω–æ–≤ */
function updateGlasses(activeIncome,passiveIncome, survival, comfort, savePlan, investPlan, specPlan){
  const full = (BASE_INCOME + salaryBonus) * 2 || 1;               // –º–∞—Å—à—Ç–∞–± –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞–∫–∞–Ω–æ–≤
  const setH = (id,v)=>{                       // helper-—Ñ—É–Ω–∫—Ü–∏—è
    document.getElementById(id).style.height =
        (Math.min(Math.abs(v), full) / full * 100) + '%';
  };
  const incomeTotal = activeIncome + passiveIncome;
  setH('glassIncomeActive',  activeIncome);
  setH('glassIncomePassive', passiveIncome);
  setH('glassExpenses', survival + comfort);

  /* —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è: –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º */
  const gS = document.getElementById('glassSavings');
  const lS = document.getElementById('saveLabel');
  if (savePlan >= 0){ gS.classList.remove('neg-liquid'); lS.classList.remove('neg-text'); }
  else              { gS.classList.add   ('neg-liquid'); lS.classList.add   ('neg-text'); }
  setH('glassSavings', savePlan);

  setH('glassInvest',  Math.max(0, investPlan));   // —Ç–æ–ª—å–∫–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
  setH('glassSpec',    Math.max(0, specPlan));     // —Ç–æ–ª—å–∫–æ —Å–ø–µ–∫—É–ª—è—Ü–∏–∏ ‚úì
}

function showTutorial(){
  let i=0; const dlg=document.getElementById('tutorial');
  const title=document.getElementById('tutTitle'),
        text =document.getElementById('tutText'),
        btn  =document.getElementById('tutNext');
  const render=()=>{title.textContent=tutSlides[i][0]; text.textContent=tutSlides[i][1];
                    btn.textContent=i===2?'–ü–æ–Ω—è–ª!':'–î–∞–ª—å—à–µ';};
  render(); dlg.classList.remove('hidden');
  btn.onclick=()=>{i<2 ? (i++,render()) : (dlg.classList.add('hidden'),localStorage.saverTut=1);}
}

  /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã –∑–¥–æ—Ä–æ–≤—å—è/—Å—á–∞—Å—Ç—å—è */
  function updateBars(){
    const h=Math.max(0,Math.min(100,health));
    const p=Math.max(0,Math.min(100,happiness));

    document.getElementById('vHealthFill').style.height = h+'%';
    document.getElementById('vHappyFill' ).style.height = p+'%';
    document.getElementById('vHealthTxt').textContent   = h+'%';
    document.getElementById('vHappyTxt' ).textContent   = p+'%';
  }

  /* –ø–µ—Ä–µ—Å—á—ë—Ç –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ */
  function updateIncomeExpenses(){
    const survival =+document.getElementById('survival').value;
    const comfort  =+document.getElementById('comfort').value;
    const savePlan =+document.getElementById('save').value;
    const investPlan=+document.getElementById('invest').value;
    const specPlan = +document.getElementById('spec').value;
    const healthSp =+document.getElementById('healthSpend').value;
    const edu      =+document.getElementById('edu').value;
    const extra    = document.getElementById('extra').value;
    const businessPlan  = +document.getElementById('business').value;
    const freelancePlan = +document.getElementById('freelance').value;

    let income = BASE_INCOME + salaryBonus;           // 1000 $
    if (extra === '–¥–∞') income += 200;  // –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞

const passive = (investments * 0.05 + savings * 0.03) / 12;
income += passive;
    
    const spend = survival + comfort + savePlan + investPlan + specPlan
            + healthSp + edu + businessPlan;
    income += freelancePlan * FREEL_INCOME_K;
    
/* ----- –∞–≤—Ç–æ–¥–æ–ª–∏–≤ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞ –≤ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è ----- */
if (document.getElementById('autoAdjust').checked) {
  const rest = income - spend;
  if (rest > 0) {
    setSlider('save', savePlan + rest);      // –¥–≤–∏–≥–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–∞–π–¥–µ—Ä ¬´–°–±–µ—Ä–µ–∂–µ–Ω–∏—è¬ª
    return;                                  // –≤—ã—Ö–æ–¥–∏–º: updateIncomeExpenses –≤—ã–∑–æ–≤–µ—Ç—Å—è —Å–Ω–æ–≤–∞
  }
}

    const passiveIncome = passive;
    const activeIncome  = income - passiveIncome;
    
document.getElementById('incomeDisplay').innerText =
      `$${activeIncome.toFixed(0)}  +  $${passiveIncome.toFixed(0)}`;
    document.getElementById('expensesDisplay').innerText = `$${spend}`;
    updateGlasses(activeIncome,passiveIncome,survival,comfort,savePlan,investPlan,specPlan);
    // –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ü–µ–ª–∏ ¬´–Ω–∞ –ª–µ—Ç—É¬ª, –∫–æ–≥–¥–∞ –¥–≤–∏–≥–∞–µ–º —Å–ª–∞–π–¥–µ—Ä—ã
if (currentGoal){
  updateGoalProgress(currentGoal, {
    savings,
    investments,
    passiveIncome : passive,               // ‚Üê –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è passive –≤—ã—à–µ –≤ —Ñ—É–Ω–∫—Ü–∏–∏
    monthExpenses : survival + comfort
  });
}
    }

function rulesBroken(income){
  const pct  = v => v / income * 100;       // –ø–µ—Ä–µ–≤–æ–¥–∏–º $ –≤ %

  /* —Ç–µ–∫—É—â–∏–µ –≤–µ–ª–∏—á–∏–Ω—ã –∏–∑ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π-¬´–±–∞–Ω–æ–∫¬ª */
  const surv = +survival.value,
        comf = +comfort.value,
        sv   = +save.value,
        iv   = +invest.value,
        sp   = +spec.value;

  return activeRules.some(r => {
    /* --- –ø—Ä–∞–≤–∏–ª–æ ¬´–º–∏–Ω–∏–º—É–º –• % –≤ –±–∞–Ω–∫—É Y¬ª --- */
    if (r.type === 'min'){
      if (r.jar === 'save')   return pct(sv) < r.value;
      if (r.jar === 'invest') return pct(iv) < r.value;
      if (r.jar === 'spec')   return pct(sp) < r.value;
    }

        /* --- –ø—Ä–∞–≤–∏–ª–æ ¬´–∫–æ–º—Ñ–æ—Ä—Ç ‚â§ max %¬ª --- */
    if (r.type === 'comfortMax')
      return pct(comf) > r.max;

    /* --- –ø—Ä–∞–≤–∏–ª–æ ¬´–ø–æ–¥—É—à–∫–∞ ‚â• N –º–µ—Å—è—Ü–µ–≤¬ª --- */
    if (r.type === 'buf')
      return surv > 0 && savings / surv < r.months;
  });
}

  function updateGoalProgress(goal, ctx){
  /* ctx: {savings, investments, passiveIncome, monthExpenses} */
  let pct = 0, leftTxt = '';

  if (goal.key === 'buffer'){
    const need = ctx.monthExpenses * 3;
    pct = Math.min(100, ctx.savings / need * 100);
    leftTxt = (need - ctx.savings > 0) ? `$${(need-ctx.savings).toFixed(0)}` : '0';
  }
  else if (goal.key === 'passive'){
    pct = Math.min(100, ctx.passiveIncome / 1000 * 100);
    leftTxt = (1000 - ctx.passiveIncome > 0) ? `$${(1000-ctx.passiveIncome).toFixed(0)}` : '0';
  }
  else if (goal.key === 'tenk'){
    pct = Math.min(100, ctx.savings / 10000 * 100);
    leftTxt = (10000 - ctx.savings > 0) ? `$${(10000-ctx.savings).toFixed(0)}` : '0';
  }
else if (goal.key === 'double'){
  const startCap = startSavings + startInvestments;   // —á—Ç–æ –±—ã–ª–æ –≤ –Ω–∞—á–∞–ª–µ
  const nowCap   = ctx.savings + ctx.investments;     // —á—Ç–æ –µ—Å—Ç—å —Å–µ–π—á–∞—Å
  pct     = Math.min(100, nowCap / (startCap*2) * 100);
  leftTxt = (startCap*2 - nowCap > 0)
              ? `$${(startCap*2 - nowCap).toFixed(0)}`
              : '0';
 }
    
  /* –≤–∏–∑—É–∞–ª—å–Ω–æ */
  document.getElementById('goalBar').style.width = pct + '%';
  document.getElementById('goalPercent').textContent = Math.floor(pct);
  document.getElementById('goalLeft').textContent    = leftTxt;
    const miniPct  = document.getElementById('goalPercentMini'),
      miniLeft = document.getElementById('goalLeftMini');
if (miniPct)  miniPct.textContent  = Math.floor(pct);
if (miniLeft) miniLeft.textContent = leftTxt;
}

  /* —Ç–∞–±–ª–∏—Ü–∞-–∏—Å—Ç–æ—Ä–∏—è */
  function pushHistory(evt,free){
    const row=document.createElement('tr');
    row.innerHTML=`
      <td class="p-2">${turn}</td><td class="p-2">${evt}</td>
      <td class="p-2">$${Math.round(free)}</td>
      <td class="p-2">$${Math.round(savings)}</td>
      <td class="p-2">$${Math.round(investments)}</td>
      <td class="p-2">${health}%</td><td class="p-2">${happiness}%</td>`;
    document.getElementById('historyTable').appendChild(row);
  }

  /* –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ */
  function updateChart(score){
    scores.push(score);
    chart.data.labels.push(turn);
    chart.data.datasets[0].data.push(score);
    chart.update();
    document.getElementById('scoreBig').textContent = score;
  }

  /* ===== –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞ ===== */
function updateAchievements(ctx){
  achievements.forEach(a=>{
    if(!achState[a.id] && a.check(ctx)){
       achState[a.id] = Date.now();     // –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ—Ç–∫—Ä—ã—Ç
       saveAch(achState);               // –ø–∏—à–µ–º –≤ localStorage
       toast('üèÜ&nbsp;–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ' + a.text, true);   // <-- –≤—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç
       renderAchTable();
       updateTrophyCounter();
    }
  });
}
  /* ===== –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ===== */
function toast(html, fresh = false){
  const div = document.createElement('div');
  div.className = 'toast';
  div.innerHTML = html;
  if (fresh) div.style.background = '#fbbf24';   // —è—Ä–∫–æ-–∂—ë–ª—Ç—ã–π
  document.getElementById('toastBox').append(div);
  setTimeout(()=>div.remove(), 4000);
}
  
  /* —Å—Ç–∞—Ä—Ç */
window.startGame = n => {
  maxTurns = n;
  document.getElementById('maxTurns').innerText = n;
  /* —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É */
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('game-screen').classList.remove('hidden');
    /* ---------- –°–ë–†–û–° –î–û–°–¢–ò–ñ–ï–ù–ò–ô –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –∏–≥—Ä–æ–π ---------- */
  achState = {};                // –æ—á–∏—â–∞–µ–º –æ–±—ä–µ–∫—Ç
  saveAch(achState);            // –ø–∏—à–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –≤ localStorage
  renderAchTable();             // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –º–æ–¥–∞–ª–∫–∏
  updateTrophyCounter();        // –∏ —Å—á—ë—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–µ üèÜ
  /* ---------------- –ø—Ä–µ—Å–µ—Ç—ã ---------------- */
  const mode = document.querySelector('input[name="mode"]:checked')?.value ?? 'role';
  let   role = null;
  /* ----------- –°–ª–æ–∂–Ω–æ—Å—Ç—å ----------- */
const diffKey = document.querySelector('input[name="diff"]:checked')?.value || 'normal';
currentDiff   = difficulties[diffKey];
currentDiffKey = diffKey;   // —Å–æ—Ö—Ä–∞–Ω—è–µ–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ startGame

['survival','comfort','save','invest','healthSpend','edu','spec', 'business','freelance'].forEach(id=>{
  document.getElementById(id + 'Slider')
          .noUiSlider.updateOptions({ step: currentDiff.sliderStep });
});
  
savings       = currentDiff.startBonus$;   // –±–æ–Ω—É—Å / —à—Ç—Ä–∞—Ñ –∫ —Å—Ç–∞—Ä—Ç–æ–≤—ã–º $
  
 if (mode === 'role') {
  role = document.querySelector('input[name="role"]:checked').value;
  const cfg  = rolePresets[role];
  activeRules = cfg.rules;             // ‚Üê –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –ø—Ä–∞–≤–∏–ª–∞
  bonusFlag   = !!cfg.bonus;           // true/false
  const base  = 1000;
  Object.entries(cfg.plan).forEach(([field,pc])=>{
    setSlider(field, Math.round(base*pc/100/10)*10);
  });
  /* ======== ‚ú® –î–û–ë–ê–í–õ–Ø–ï–ú –ë–û–ù–£–° –ò–ù–í–ï–°–¢–û–†–£ ‚ú® ======== */
  if (role === 'Investor') {
    savings += 1000;                   // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–æ–Ω—É—Å
  }
   /* —à–∞–≥ —Å–ª–∞–π–¥–µ—Ä–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ */
['survival','comfort','save','invest','healthSpend','edu','spec'].forEach(id=>{
  document.getElementById(id+'Slider')
          .noUiSlider.updateOptions({ step: currentDiff.sliderStep });
});

  startSavings = +document.getElementById('save').value + savings;
  startInvestments = +document.getElementById('invest').value;
   
   const passiveIncome = (startInvestments * 0.05 + startSavings * 0.03) / 12;
   
   if(role==='Saver' && !localStorage.saverTut) setTimeout(showTutorial,300);
   // –Ω–∞–∑–Ω–∞—á–∞–µ–º —Ü–µ–ª—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ä–æ–ª–∏
currentGoal = goals[cfg.goalKey];
   
document.getElementById('goalName').textContent   = currentGoal.text;
document.getElementById('goalStatus').textContent = '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ';
updateGoalProgress(currentGoal, {
  savings        : startSavings,
  investments    : startInvestments,
  passiveIncome : passiveIncome,
  monthExpenses  : (+document.getElementById('survival').value
  + +document.getElementById('comfort').value)
});

document.getElementById('goalName').textContent = currentGoal.text;
document.getElementById('goalStatus').textContent = '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ';
} else {
  activeRules = []; bonusFlag = false;
}

  /* ---------------- —Ü–µ–ª—å ---------------- */
if (mode === 'goal') {
  const goalKey     = document.querySelector('input[name="goal"]:checked').value;
  currentGoal       = goals[goalKey];

  document.getElementById('goalName').textContent   = currentGoal.text;
  document.getElementById('goalStatus').textContent = '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ';
  updateGoalProgress(currentGoal, {
    savings: 0, investments: 0, passiveIncome: 0, monthExpenses: 1
  });
}

/* --- –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ü–µ–ª–∏ / —Ä–æ–ª–∏ --- */
if (currentGoal) {                     // —Ü–µ–ª—å (–¥–ª—è —Ä–µ–∂–∏–º–∞ goal –ò–õ–ò role) –µ—Å—Ç—å
  goalHeader.textContent = '–ü—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏ ' + currentGoal.text;
} else {                               // —Å–≤–æ–±–æ–¥–Ω—ã–π –ø–ª–∞–Ω ‚Äì —Ü–µ–ª–∏ –Ω–µ—Ç
  goalHeader.textContent = '–ü–µ—Å–æ—á–Ω–∏—Ü–∞ ‚Äî –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ü–µ–ª–∏';
}

  /* –æ–±–Ω—É–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã */
turn = 0;
savings = currentDiff.startBonus$ + (role === 'Investor' ? 1000 : 0);
investments = 0;
specBalance = 0;
startSpec   = 0;
health = 100;
happiness = 100;
businessBalance = 0;
businessTier    = 0;
/* ===== –ø—Ä–∏–º–µ–Ω—è–µ–º –±–æ–Ω—É—Å/—à—Ç—Ä–∞—Ñ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ===== */
savings = currentDiff.startBonus$;      // –º–æ–∂–µ—Ç –±—ã—Ç—å +, 0 –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º
  updateIncomeExpenses(); updateBars(); updateTrophyCounter();
  
// --- –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ü–µ–ª–∏ –ø–æ—Å–ª–µ —Ç–æ–≥–æ,
//     –∫–∞–∫ savings/investments —É–∂–µ –æ–±–Ω—É–ª–µ–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω—ë–Ω –±–æ–Ω—É—Å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ---
if (currentGoal){
  updateGoalProgress(currentGoal, {
    savings,
    investments,
    passiveIncome : (investments * 0.05 + savings * 0.03) / 12,
    monthExpenses : +document.getElementById('survival').value +
                    +document.getElementById('comfort').value
  });
}
  };

  /* –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è (–º–æ–≥—É—Ç –±—ã—Ç—å < 0) */
document.getElementById('savings').innerText =
        `$${Math.round(savings)}`;

function specReturnPct(){
  const r = Math.random();
  switch (currentDiffKey){
    case 'easy':   return (r < 0.60 ? +0.03 : -0.01);
    case 'normal': return (r < 0.55 ? +0.06 : -0.03);
    case 'hard':   return (r < 0.52 ? +0.08 : -0.08);
  }
  }

/* === –¥–æ—Ö–æ–¥/—É–±—ã—Ç–æ–∫ –æ—Ç –±–∏–∑–Ω–µ—Å–∞ ================================ */
/* –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å ‚Äì –≤–ª–∏—è–µ—Ç –∏ –Ω–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, –∏ –Ω–∞ —Ä–∏—Å–∫ */
function calcBusinessTier(){
  if (businessBalance >= 5000) return 3;   // –∫—Ä—É–ø–Ω—ã–π
  if (businessBalance >= 3000) return 2;   // —Å—Ä–µ–¥–Ω–∏–π
  if (businessBalance >= 1000) return 1;   // –º–∞–ª—ã–π
  return 0;
}

/* –°–ª—É—á–∞–π–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –ø–æ —É—Ä–æ–≤–Ω—è–º –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ */
function businessReturnPct(){
  const r = Math.random();
  switch (currentDiffKey){
    case 'easy':
      return (r < 0.70 ? +0.04 : -0.02);          // +4 % | ‚Äì2 %
    case 'normal':
      return (r < 0.60 ? +0.07 : -0.04);          // +7 % | ‚Äì4 %
    case 'hard':
      return (r < 0.50 ? +0.10 : -0.08);          // +10 % | ‚Äì8 %
  }
}


  /* –•–û–î */
  window.runTurn = ()=>{
    turn++;

    const survival  =+document.getElementById('survival').value;
    const comfort   =+document.getElementById('comfort').value;
    const savePlan  =+document.getElementById('save').value;
    const investPlan=+document.getElementById('invest').value;
    const specPlan   = +document.getElementById('spec').value;
    const healthSp  =+document.getElementById('healthSpend').value;
    const edu       =+document.getElementById('edu').value;
    const extra     = document.getElementById('extra').value;
    const businessPlan  = +document.getElementById('business').value;
    const freelancePlan = +document.getElementById('freelance').value;
    const passiveIncome = (investments * 0.05 + savings * 0.03) / 12;

    let income = BASE_INCOME + salaryBonus; if(extra==='–¥–∞') income+=200;income += passiveIncome;
    const spend=survival+comfort+savePlan+investPlan+specPlan+healthSp+edu+businessPlan;
    
/* ===== —Å–æ–±—ã—Ç–∏–µ —Å —É—á—ë—Ç–æ–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ===== */
let evt = '–Ω–∏—á–µ–≥–æ', penalty = 0, crisis = 0;
    
    /* ‚îÄ‚îÄ‚îÄ —Ñ—Ä–∏–ª–∞–Ω—Å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
if (freelancePlan > 0){
  income += freelancePlan * FREEL_INCOME_K;          // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥
const happyLoss  = Math.ceil(freelancePlan / FREEL_HAPPY_STEP);
const healthLoss = Math.ceil(freelancePlan / FREEL_HEALTH_STEP);
  const diffMul = currentDiffKey === 'easy' ? 0.8
                 : currentDiffKey === 'hard' ? 1.2 : 1;
  happiness -= Math.ceil(happyLoss  * diffMul);
  health    -= Math.ceil(healthLoss * diffMul);
evt += ` | —Ñ—Ä–∏–ª–∞–Ω—Å +$${freelancePlan.toFixed(0)} (‚Äì${happyLoss}üòÉ, ‚Äì${healthLoss}‚ù§Ô∏è)`;
}

    const raise   = edu * 0.10;               // +10 % –æ—Ç –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ
if (raise > 0){
  salaryBonus += raise;                   // –Ω–∞–¥–±–∞–≤–∫–∞ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è
  evt += ` | –ø–æ–≤—ã—à–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã +$${raise.toFixed(0)}`;
  toast(`üéì –ó–∞—Ä–ø–ª–∞—Ç–∞ –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ $${raise.toFixed(0)} –±–ª–∞–≥–æ–¥–∞—Ä—è –æ–±—É—á–µ–Ω–∏—é`, true);
}
  
if (Math.random() < currentDiff.eventProb) {
  /* ¬´–±—Ä–æ—Å–∞–µ–º –∫—É–±–∏–∫¬ª –≤—Ç–æ—Ä–æ–π —Ä–∞–∑, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è */
  const w = currentDiff.eventWeights;
  const dice = Math.random();

  if (dice < w.minorExpense) {                 // –º–µ–ª–∫–∞—è —Ç—Ä–∞—Ç–∞
    penalty = -currentDiff.minorExpense$;
    evt = `–º–µ–ª–∫–∞—è —Ç—Ä–∞—Ç–∞ ‚Äì $${currentDiff.minorExpense$}`;

  } else if (dice < w.minorExpense + w.crisis) {   // –∫—Ä–∏–∑–∏—Å
    crisis = investments * currentDiff.crisisLossPct;
    evt = `–∫—Ä–∏–∑–∏—Å ‚Äì ${Math.round(currentDiff.crisisLossPct * 100)} % –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π`;

  } else {                                     // –±–æ–ª–µ–∑–Ω—å
    health = Math.max(0, health - currentDiff.sicknessHP);
    evt = `–±–æ–ª–µ–∑–Ω—å ‚Äì ${currentDiff.sicknessHP} –∑–¥–æ—Ä–æ–≤—å—è`;
  }
  }

    toast(`üì£ <strong>${evt}</strong>`, true);
    const free = income - spend + penalty;
savings   += savePlan + free;

const growth = Math.random() <= 0.7           // 70 % ‚Äì —Ä–æ—Å—Ç, 30 % ‚Äì –ø–∞–¥–µ–Ω–∏–µ
             ? Math.random() * 0.03           // +0‚Äí3 %
             : Math.random() * -0.01;         // ‚Äì0‚Äí1 %
investments  = (investments + investPlan - crisis) * (1 + growth);
/* ‚îÄ‚îÄ‚îÄ —Å–ø–µ–∫—É–ª—è—Ü–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
if (specPlan !== 0 || specBalance !== 0) {
if (startSpec === 0 && specPlan > 0) startSpec = specPlan;
  specBalance += specPlan;                     // –Ω–æ–≤—ã–π –≤–∑–Ω–æ—Å / –≤—ã–≤–æ–¥
  const specPnl = specBalance * specReturnPct(); // –¥–æ—Ö–æ–¥-—É–±—ã—Ç–æ–∫ –∑–∞ —Ö–æ–¥
  specBalance += specPnl;                      // –∏—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å

  evt += ` | —Å–ø–µ–∫—É–ª—è—Ü–∏–∏ ${specPnl >= 0 ? '+' : '‚Äì'}$${Math.abs(specPnl).toFixed(0)}`;
}
    
/* ‚îÄ‚îÄ‚îÄ –±–∏–∑–Ω–µ—Å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
if (businessPlan !== 0 || businessBalance !== 0) {
  businessBalance += businessPlan;           // –≤–∑–Ω–æ—Å/–≤—ã–≤–æ–¥ –∏–∑ –±–µ–≥—É–Ω–∫–∞
  businessTier     = calcBusinessTier();     // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å

  if (businessTier > 0){
    const bizPct  = businessReturnPct();
    const bizProf = businessBalance * bizPct;
    businessBalance += bizProf;
    income          += bizProf;              // –∏–¥—ë—Ç –≤ –∞–∫—Ç–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
    evt += ` | –±–∏–∑–Ω–µ—Å ${bizProf >= 0 ? '+' : '‚Äì'}$${Math.abs(bizProf).toFixed(0)}`;
  }
}
    
/* –∑–¥–æ—Ä–æ–≤—å–µ / —Å—á–∞—Å—Ç—å–µ */
if (!evt.startsWith('–±–æ–ª–µ–∑–Ω—å')) {

  /* ---------- –∑–¥–æ—Ä–æ–≤—å–µ ---------- */
  if (survival < SURV_SAFE) {
    const ratio = (SURV_SAFE - survival) / SURV_SAFE;   // 0‚Ä¶1
    health    -= ratio * 80;   // ‚Äì16 HP –∑–∞ $100
    happiness -= ratio * 25;   // ‚Äì5  Happy –∑–∞ $100
} else if (survival >= SURV_BONUS) {
    health += 5;               // –±–æ–Ω—É—Å, –µ—Å–ª–∏ —Ç—Ä–∞—Ç–∏–º ‚â• $600
}
health += (healthSp / 500) * 50;                         // —Ç—Ä–∞—Ç—ã –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ

/* ---------- —Å—á–∞—Å—Ç—å–µ ------------ */
if (comfort < COMF_SAFE) {
  const ratio = (COMF_SAFE - comfort) / COMF_SAFE;       // 0 ‚Ä¶ 1
  happiness -= Math.pow(ratio, 1.2) * 15;
} else if (comfort >= COMF_BONUS) {
  happiness += 2;                                        // –±–æ–Ω—É—Å
}

/* —à—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–¥—Ä–∞–±–æ—Ç–∫—É */
const happyPenalty = currentDiffKey === 'easy' ? 2
                    : currentDiffKey === 'hard' ? 4 : 3;
if (extra === '–¥–∞') happiness -= happyPenalty;
if (extra === '–¥–∞') health -= 1;

/* ---------- —Å—á–∞—Å—Ç—å–µ –∑–∞ ¬´–ø–æ–¥—É—à–∫—É¬ª ---------- */
  const bufferTarget = survival * 3;                    // 3-–º–µ—Å—è—á–Ω–∞—è –ø–æ–¥—É—à–∫–∞
  const bufRatio     = Math.min(savings / bufferTarget, 1);
  if (bufRatio < 1)  happiness -= (1 - bufRatio) * 2;   // ‚Äì0 ‚Ä¶ ‚Äì2
  else               happiness += 1;                    // +1 –µ—Å–ª–∏ –ø–æ–¥—É—à–∫–∞ –µ—Å—Ç—å  
}

/* –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ 0‚Ä¶100 % */
health    = Math.round(Math.max(0, Math.min(100, health)));
happiness = Math.round(Math.max(0, Math.min(100, happiness)));

    /* –±–æ–Ω—É—Å –∏–ª–∏ —à—Ç—Ä–∞—Ñ –ø–æ –∏—Ç–æ–≥–∞–º –ø—Ä–∞–≤–∏–ª */
//if (bonusFlag){
//  const bad = rulesBroken(income);
//  happiness = Math.max(0, Math.min(100, happiness + (bad ? -5 : +5)));
//}
    /* –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
    document.getElementById('turn').innerText=turn;
    document.getElementById('event').innerText=evt;
    document.getElementById('free').innerText        = `$${Math.round(free)}`;
    document.getElementById('savings').innerText     = `$${Math.round(savings)}`;
    document.getElementById('investments').innerText = `$${Math.round(investments)}`;
    document.getElementById('glassSpec').style.height = (Math.min(Math.abs(specBalance), income*2)/income/2*100)+'%';
    
    updateIncomeExpenses(); updateBars(); pushHistory(evt,free);

    /* –±–∞–ª–ª—ã */
    let score=Math.floor(savings/1000)+Math.floor(investments/1000)*2;
    if(health>70)    score+=20;
    if(happiness>70) score+=20;
    if (passiveIncome >= 1000) score += 30;
    updateChart(score);

/* === —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞—á–∏–≤–∫–∏ === */
updateAchievements({
  savings, investments, health, specBalance, startSpec
});

    /* ------------ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ ------------ */
if (currentGoal){
  const monthExpenses = survival + comfort;
  const done = currentGoal.check({
    savings,  investments, passiveIncome, monthExpenses
  });
  document.getElementById('goalStatus').textContent = done ? '‚úî –≤—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ';
  updateGoalProgress(currentGoal, {
  savings,
  investments,
  passiveIncome,
  monthExpenses
});
  if (done){
    finish('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —Ü–µ–ª–∏: ' + currentGoal.text);
    return;               // —á—Ç–æ–±—ã –±–æ–ª—å—à–µ –Ω–µ –≤–µ—Å—Ç–∏ —Ä–∞—Å—á—ë—Ç—ã –ø–æ—Å–ª–µ finish()
  }
}



    /* —Ñ–∏–Ω–∏—à? */
    if(health<=0||happiness<=0||turn>=maxTurns){
      const reason=health<=0?'–¢—ã –ø–æ—Ç–µ—Ä—è–ª –∑–¥–æ—Ä–æ–≤—å–µ.' :
                   happiness<=0?'–¢—ã –ø–æ—Ç–µ—Ä—è–ª —Å—á–∞—Å—Ç—å–µ.' : '–•–æ–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.';
      finish(reason);
    }
  };

function finish(reason){
  updatePersonalBests(scores[scores.length-1] || 0, turn, currentDiffKey);
  alert(reason + '\n–ë–∞–ª–ª—ã: ' + scores[scores.length-1]);
  /* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç-—ç–∫—Ä–∞–Ω */
  gameScreen.classList.add('hidden');
  startScreen.classList.remove('hidden');
  /* —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–¥–æ—Ä–æ–≤—å–µ/—Å—á–∞—Å—Ç—å–µ –∏ –∏—Ö –±–∞—Ä—ã */
  health = 100;
  happiness = 100;
  specBalance     = 0;
  startSpec       = 0;
  businessBalance = 0;
  businessTier    = 0;
  updateBars();
  
  /* 2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –æ–±–Ω—É–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ë–∞–ª–ª–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  chart.data.labels.length = 0;                 // –æ—á–∏—â–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –æ—Å–∏ X
  chart.data.datasets[0].data.length = 0;       // –æ—á–∏—â–∞–µ–º —Å–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è
  chart.update();                               // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫
  document.getElementById('scoreBig').textContent = 0;   // –∫—Ä—É–ø–Ω–∞—è —Ü–∏—Ñ—Ä–∞ ‚Üí 0
  scores.length = 0;                            // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –æ–±–Ω—É–ª—è–µ–º –º–∞—Å—Å–∏–≤ scores

  /* (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) –æ–±–Ω—É–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ü–µ–ª–∏ */
  document.getElementById('goalStatus').textContent = '‚Äì';
  
  /* –æ–±–Ω—É–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Ü–µ–ª–∏ */
document.getElementById('goalBar').style.width   = '0%';
document.getElementById('goalPercent').textContent = 0;
document.getElementById('goalLeft').textContent    = '‚Äì';
}
  
  /* –ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è */
  updateIncomeExpenses(); updateBars();
});

/* –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ –Ω–∞ —Å—Ç–∞—Ä—Ç-—ç–∫—Ä–∞–Ω–µ */
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    goalBlock.classList.toggle('hidden', r.value !== 'goal');
  });
});

/* ---------- FAQ-–ø–∞–Ω–µ–ª—å ---------- */
const faqPanel = document.getElementById('faqPanel');
document.getElementById('openFaq').onclick =
  () => faqPanel.classList.toggle('-translate-x-full');

/* —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ */
function blink(sel){
  const el = document.querySelector(sel);
  if(!el) return;
  el.classList.add('ring-4','ring-amber-400');
  setTimeout(()=>el.classList.remove('ring-4','ring-amber-400'), 3000);
}

/* 0. ¬´–ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥?¬ª ‚Äì –∞–∫—Ç–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ */
const incomeHint      = document.querySelectorAll('#faqPanel summary')[0];
if (incomeHint) incomeHint.addEventListener('click',
  () => blink('#glassIncomeActive'));

/* 1. ¬´–ò–∑ —á–µ–≥–æ —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –¥–æ—Ö–æ–¥—ã?¬ª ‚Äì –æ–±–∞ —Å—Ç–∞–∫–∞–Ω–∞ –¥–æ—Ö–æ–¥–æ–≤ */
const incomePartsHint = document.querySelectorAll('#faqPanel summary')[2];
if (incomePartsHint) incomePartsHint.addEventListener('click', () => {
  blink('#glassIncomeActive');
  blink('#glassIncomePassive');
});

/* 2. ¬´–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä–∞—Å—Ö–æ–¥–∞–º–∏?¬ª ‚Äì —Å—Ç–∞–∫–∞–Ω —Ä–∞—Å—Ö–æ–¥–æ–≤ */
const expensesHint    = document.querySelectorAll('#faqPanel summary')[3];
if (expensesHint) expensesHint.addEventListener('click',
  () => blink('#glassExpenses'));


</script>
</body>
</html>
