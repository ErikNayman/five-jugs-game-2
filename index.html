<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ì–æ–Ω–∫–∞: Remastered</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; overflow-x: hidden; }

        /* Jar Styles */
        .jar-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .jar-container {
            position: relative; height: 280px; background-color: #E2E8F0; border-radius: 0 0 12px 12px; overflow: hidden;
            border: 1px solid #CBD5E1; border-top: none; cursor: ns-resize; touch-action: none; transition: border-color 0.2s;
        }
        .jar-container:hover { border-color: #94A3B8; }
        .jar-liquid {
            position: absolute; bottom: 0; left: 0; right: 0;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            z-index: 10; /* Liquid behind markers/handles but visible */
        }
        .jar-surface {
            position: absolute; top: 0; left: 0; right: 0; height: 0;
            border-top: 2px solid rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center;
        }
        .jar-handle {
            width: 24px; height: 24px; background-color: white; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15); transform: translateY(-50%);
            display: flex; align-items: center; justify-content: center;
            color: #64748B; font-size: 10px; transition: transform 0.1s;
        }
        .jar-container:hover .jar-handle { transform: translateY(-50%) scale(1.15); }

        /* MARKERS (New) */
        .jar-marker {
            position: absolute;
            left: 0; right: 0;
            border-top: 1px dashed;
            pointer-events: none;
            z-index: 5;
            font-size: 9px;
            font-weight: 800;
            padding-left: 6px;
            display: flex;
            align-items: flex-end; /* Text sits on line */
            line-height: 0;
            opacity: 0.7;
            transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .jar-marker span {
            background: rgba(255,255,255,0.8);
            padding: 2px 4px;
            border-radius: 4px;
            transform: translateY(-50%);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .marker-red { border-color: #F43F5E; color: #E11D48; }
        .marker-green { border-color: #10B981; color: #059669; }
        .marker-yellow { border-color: #F59E0B; color: #D97706; }
        
        /* Sidebar & Modals */
        .report-panel {
            position: fixed; z-index: 40; background: white; box-shadow: -5px 0 25px rgba(0,0,0,0.1);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @media (min-width: 768px) { .report-panel { top: 80px; right: 0; bottom: 0; width: 360px; border-left: 1px solid #E2E8F0; transform: translateX(100%); } .report-panel.open { transform: translateX(0); } }
        @media (max-width: 767px) { .report-panel { left: 0; right: 0; bottom: 0; height: auto; max-height: 85vh; border-radius: 20px 20px 0 0; transform: translateY(100%); padding-bottom: 20px; } .report-panel.open { transform: translateY(0); } }

        .jars-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        @media (min-width: 768px) { .jars-grid { grid-template-columns: repeat(5, 1fr); gap: 1rem; } }

        .game-over-overlay { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 100; }
        .btn-pulse { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(244, 63, 94, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0); } }
        
        /* Flow State Animation */
        .flow-glow {
            animation: flow-pulse 2s infinite alternate;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
            border-color: #FBBF24 !important;
        }
        @keyframes flow-pulse {
            0% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.2); }
            100% { box-shadow: 0 0 25px rgba(251, 191, 36, 0.6); }
        }
        
        .highlight-jar { animation: highlight-bounce 2s ease-in-out infinite; box-shadow: 0 0 0 4px #F43F5E !important; border-color: #F43F5E !important; z-index: 20; }
        @keyframes highlight-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .custom-tooltip {
            visibility: hidden; width: 220px; background-color: #1e293b; color: #fff; text-align: left; border-radius: 8px; padding: 10px;
            position: absolute; z-index: 50; bottom: 110%; left: 0; opacity: 0; transition: opacity 0.2s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); font-weight: normal; line-height: 1.4; border: 1px solid #475569;
        }
        .tooltip-container:hover .custom-tooltip { visibility: visible; opacity: 1; }

        .info-overlay { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(3px); z-index: 80; }

        .float-text {
            position: absolute;
            font-weight: 800;
            pointer-events: none;
            z-index: 100;
            text-shadow: 0 2px 4px rgba(255,255,255,0.8);
            animation: floatUp 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        @keyframes floatUp {
            0% { opacity: 0; transform: translateY(10px) scale(0.8); }
            15% { opacity: 1; transform: translateY(0) scale(1.2); }
            100% { opacity: 0; transform: translateY(-60px) scale(1); }
        }

        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .game-toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(40px);
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 90;
            pointer-events: none;
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .game-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        @media (min-width: 768px) { .game-toast { bottom: 30px; } }
        
        .room-icon { transition: all 0.5s ease; opacity: 0.3; filter: grayscale(100%); transform: scale(0.9); }
        .room-icon.active { opacity: 1; filter: grayscale(0%); transform: scale(1); }
        .room-icon.just-unlocked { animation: unlock-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes unlock-pop { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.2); } 100% { transform: scale(1); } }

    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 select-none pb-24 md:pb-0">

    <!-- HEADER -->
    <header class="bg-slate-900 text-white sticky top-0 z-50 shadow-xl border-b border-slate-700 transition-colors duration-500" id="mainHeader">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                
                <!-- Left: Goal -->
                <div class="flex items-center gap-4 w-full md:w-auto flex-grow md:flex-grow-0">
                    <div class="flex-grow">
                        <div class="flex justify-between items-end mb-1">
                            <div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider" id="goalTitle">–¶–µ–ª—å: –ü–æ–¥—É—à–∫–∞</div>
                            <div class="text-xs font-bold text-emerald-400 tabular-nums" id="goalValue">0 / $5,000</div>
                        </div>
                        <div class="w-40 md:w-48 bg-slate-700 rounded-full h-2 overflow-hidden shadow-inner border border-slate-600">
                            <div id="goalProgressBar" class="bg-emerald-500 h-full rounded-full transition-all duration-700 relative overflow-hidden" style="width: 0%">
                                <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <!-- Sound Button -->
                        <button id="soundBtn" class="w-6 h-6 rounded-full bg-slate-700 hover:bg-slate-600 text-slate-300 hover:text-white text-[10px] flex items-center justify-center transition-colors flex-shrink-0">
                            <i class="fa-solid fa-volume-high"></i>
                        </button>
                        <!-- Info Button -->
                        <button onclick="openInfoModal()" class="w-6 h-6 rounded-full bg-slate-700 hover:bg-slate-600 text-white text-[10px] flex items-center justify-center transition-colors flex-shrink-0 btn-pulse">
                            <i class="fa-solid fa-info"></i>
                        </button>
                    </div>
                </div>

                <!-- Center: Vitals (With Flow Glow) -->
                <div id="vitalsPanel" class="hidden md:flex gap-4 w-full md:w-auto bg-slate-800/50 px-4 py-2 rounded-xl border border-slate-700 relative overflow-hidden justify-center transition-all duration-500">
                    <!-- Flow Label -->
                    <div id="flowLabel" class="absolute inset-0 flex items-center justify-center bg-amber-500/10 opacity-0 transition-opacity pointer-events-none">
                        <span class="text-[50px] font-black text-amber-500/20 uppercase tracking-widest rotate-12">FLOW</span>
                    </div>

                    <div class="flex flex-col w-24 relative z-10">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] uppercase font-bold text-slate-400">–ó–¥–æ—Ä–æ–≤—å–µ</span>
                            <span id="hudHealthVal" class="text-[10px] font-bold text-white">100%</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden border border-slate-600">
                            <div id="hudHealthBar" class="bg-rose-500 h-full rounded-full transition-all duration-300" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="flex flex-col w-24 border-l border-slate-700 pl-4 relative z-10">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] uppercase font-bold text-slate-400">–°—á–∞—Å—Ç—å–µ</span>
                            <span id="hudHappyVal" class="text-[10px] font-bold text-white">100%</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden border border-slate-600">
                            <div id="hudHappyBar" class="bg-amber-400 h-full rounded-full transition-all duration-300" style="width: 100%"></div>
                        </div>
                    </div>
                </div>

                <!-- Right: Action -->
                <div class="flex items-center gap-4 w-full md:w-auto justify-end">
                    <div class="text-right hidden lg:block">
                        <div class="text-[9px] text-slate-400 uppercase tracking-widest">–ö–∞–ø–∏—Ç–∞–ª</div>
                        <div id="hudNetWorth" class="font-mono font-bold text-lg text-emerald-400 tabular-nums">$0</div>
                    </div>
                    <button id="nextMonthBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-emerald-900/40 transform active:scale-95 transition-all flex items-center gap-2 text-xs uppercase tracking-wide">
                        <span>–ü—Ä–æ–∂–∏—Ç—å –ú–µ—Å—è—Ü</span>
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 py-6 space-y-6 md:pr-4 lg:pr-8 transition-all duration-300" id="mainContent">

        <!-- ROOM / LEVEL OF LIFE VISUALIZATION -->
        <section class="bg-slate-800 rounded-2xl p-4 shadow-lg border border-slate-700 relative overflow-hidden">
            <div class="flex justify-between items-center mb-3 relative z-10">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                    <i class="fa-solid fa-layer-group"></i> –£—Ä–æ–≤–µ–Ω—å –∂–∏–∑–Ω–∏
                </h3>
                <div id="flowBadge" class="hidden px-2 py-0.5 bg-amber-500/20 text-amber-400 text-[9px] font-bold rounded uppercase border border-amber-500/50 animate-pulse">
                    <i class="fa-solid fa-bolt"></i> –í –ü–æ—Ç–æ–∫–µ (+10% –≠—Ñ—Ñ.)
                </div>
            </div>
            
            <div class="flex justify-between items-center gap-2 overflow-x-auto pb-2 md:pb-0">
                <!-- Level 0 -->
                <div class="flex flex-col items-center gap-2 min-w-[60px] room-icon active" id="lvl-0">
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl shadow-inner">üì¶</div>
                    <div class="text-[9px] text-slate-400 font-bold uppercase">–í—ã–∂–∏–≤–∞–Ω–∏–µ</div>
                </div>
                <div class="h-0.5 flex-grow bg-slate-700 rounded-full"></div>
                
                <!-- Level 1 -->
                <div class="flex flex-col items-center gap-2 min-w-[60px] room-icon" id="lvl-1">
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl shadow-inner">üõèÔ∏è</div>
                    <div class="text-[9px] text-slate-400 font-bold uppercase">–ö–æ–º—Ñ–æ—Ä—Ç</div>
                </div>
                <div class="h-0.5 flex-grow bg-slate-700 rounded-full"></div>

                <!-- Level 2 -->
                <div class="flex flex-col items-center gap-2 min-w-[60px] room-icon" id="lvl-2">
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl shadow-inner">üíª</div>
                    <div class="text-[9px] text-slate-400 font-bold uppercase">–°–≤–æ–±–æ–¥–∞</div>
                </div>
                <div class="h-0.5 flex-grow bg-slate-700 rounded-full"></div>

                <!-- Level 3 -->
                <div class="flex flex-col items-center gap-2 min-w-[60px] room-icon" id="lvl-3">
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl shadow-inner">üèùÔ∏è</div>
                    <div class="text-[9px] text-slate-400 font-bold uppercase">–ú–µ—á—Ç–∞</div>
                </div>
            </div>
            
            <!-- Progress Bar inside Room -->
            <div class="absolute bottom-0 left-0 h-1 bg-emerald-500 transition-all duration-1000" id="roomProgress" style="width: 0%"></div>
        </section>

        <!-- DASHBOARD -->
        <section class="grid grid-cols-1 md:grid-cols-12 gap-4">
            
            <!-- Income Panel -->
            <div class="md:col-span-4 lg:col-span-3 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-between h-auto min-h-[14rem]">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">–ó–∞—Ä–ø–ª–∞—Ç–∞</label>
                        <div id="incomePenaltyBox" class="hidden relative tooltip-container cursor-help">
                            <div class="flex items-center gap-1.5 bg-rose-50 px-2 py-0.5 rounded border border-rose-100">
                                <i class="fa-solid fa-circle-exclamation text-rose-500 text-[10px]"></i>
                                <span class="text-[9px] text-slate-500 font-medium"><span id="penaltyPercent" class="text-rose-600 font-bold tabular-nums">-0%</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="relative group mb-1">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold group-focus-within:text-emerald-500 text-sm">$</span>
                        <input type="number" id="incomeInput" value="4000" class="w-full pl-6 pr-3 py-1.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none font-bold text-slate-800 text-base transition-all tabular-nums">
                    </div>
                    <div class="flex justify-between text-xs font-bold text-slate-500 mt-1 pb-2 border-b border-slate-100">
                        <span>–ù–∞ —Ä—É–∫–∏ (–§–∞–∫—Ç):</span>
                        <span id="realIncomeVal" class="text-emerald-600 tabular-nums">$4,000</span>
                    </div>
                    
                    <div class="mt-2 text-[10px] text-slate-500 flex flex-col gap-1.5">
                        <div class="flex justify-between">
                            <span>–°–±–µ—Ä–µ–∂–µ–Ω–∏—è (4%):</span>
                            <span class="text-emerald-600 font-bold tabular-nums" id="savingsInterestText">+$0/–º–µ—Å</span>
                        </div>
                        <div class="flex justify-between">
                            <span>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ (10%):</span>
                            <span class="text-indigo-600 font-bold tabular-nums" id="investmentInterestText">+$0/–º–µ—Å</span>
                        </div>
                    </div>
                </div>
                
                <div id="debtRepayContainer" class="hidden mt-2 pt-2 border-t border-slate-100">
                    <button id="repayDebtBtn" class="w-full bg-rose-50 hover:bg-rose-100 text-rose-600 font-bold py-1.5 rounded-lg border border-rose-200 text-xs transition-colors flex items-center justify-center gap-1 btn-pulse">
                        <i class="fa-solid fa-fire"></i> –ü–æ–≥–∞—Å–∏—Ç—å: <span id="currentDebtVal" class="tabular-nums">$0</span>
                    </button>
                </div>

                <div class="mt-auto pt-3 flex items-center justify-between border-t border-slate-100">
                    <div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase">–ë–∞–ª–∞–Ω—Å</div>
                        <div id="balanceBadgeContainer">
                            <div id="balanceBadge" class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-500 inline-block mt-0.5">OK</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex items-baseline gap-0.5 justify-end">
                            <span id="totalPercent" class="text-2xl font-black text-slate-800 tabular-nums">100</span>
                            <span class="text-xs font-bold text-slate-400">%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VS Chart -->
            <div class="md:col-span-8 lg:col-span-9 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 relative flex flex-col h-auto min-h-[14rem]">
                <div class="mb-1 flex justify-between items-center">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase">–°–¢–†–£–ö–¢–£–†–ê –ö–ê–ü–ò–¢–ê–õ–ê</h3>
                    <div class="hidden sm:block text-[9px] text-slate-400 bg-slate-50 px-2 py-0.5 rounded">–î–∂–æ–Ω = 20% –≤ –±–∞–Ω–∫ (–±–µ–∑ —Ä–∏—Å–∫–∞)</div>
                </div>
                <div class="flex-grow w-full relative h-48">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Jars -->
        <section>
            <div class="flex items-center gap-2 mb-3 px-1">
                <i class="fa-solid fa-hand-pointer text-slate-400 animate-bounce text-sm"></i>
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ (–¢—è–Ω–∏—Ç–µ –∑–∞ —É—Ä–æ–≤–µ–Ω—å)</h2>
            </div>
            <div class="jars-grid" id="jarsContainer"></div>
        </section>

    </main>

    <!-- TOAST NOTIFICATION -->
    <div id="gameToast" class="game-toast">
        <div id="toastIcon" class="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-xs"><i class="fa-solid fa-check"></i></div>
        <div>
            <div class="text-[10px] uppercase text-slate-400 font-bold" id="toastTitle">–ú–µ—Å—è—Ü –ø—Ä–æ–∂–∏—Ç</div>
            <div class="text-xs font-bold" id="toastMessage">–ù–∞–∫–æ–ø–ª–µ–Ω–æ +$400</div>
        </div>
    </div>

    <!-- DILEMMA MODAL (NEW) -->
    <div id="dilemmaModal" class="fixed inset-0 z-[90] game-over-overlay hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-all">
            <div class="bg-slate-900 p-4 text-white flex items-center gap-3">
                <div id="dilemmaIcon" class="w-10 h-10 rounded-lg bg-indigo-500 flex items-center justify-center text-lg"><i class="fa-solid fa-question"></i></div>
                <div>
                    <div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">–ù–µ–ø—Ä–æ—Å—Ç–æ–π –≤—ã–±–æ—Ä</div>
                    <h2 id="dilemmaTitle" class="text-lg font-bold leading-tight">–°–æ–±—ã—Ç–∏–µ</h2>
                </div>
            </div>
            <div class="p-6">
                <p id="dilemmaDesc" class="text-sm text-slate-600 mb-6 leading-relaxed">–û–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏...</p>
                <div class="space-y-3" id="dilemmaOptions">
                    <!-- Options injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- REPORT SIDEBAR (Simplified for big events) -->
    <div id="reportPanel" class="report-panel flex flex-col">
        <div class="w-full flex justify-center pt-3 pb-1 md:hidden"><div class="w-12 h-1.5 bg-slate-300 rounded-full"></div></div>
        <div class="p-5 flex-grow overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <div><div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">–û—Ç—á–µ—Ç</div><h2 class="text-xl font-bold text-slate-800">–ú–µ—Å—è—Ü <span id="reportMonthNum">1</span></h2></div>
                <button onclick="closeReport()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div id="reportContent" class="space-y-4">
                <!-- Content injected -->
            </div>
        </div>
        <div class="p-4 border-t border-slate-100 bg-white"><button onclick="closeReport()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95">–î–∞–ª–µ–µ</button></div>
    </div>
    
    <div id="mobileOverlay" onclick="closeReport()" class="fixed inset-0 bg-black/20 z-30 hidden md:hidden transition-opacity opacity-0"></div>

    <!-- INFO / RULES MODAL -->
    <div id="infoModal" class="fixed inset-0 info-overlay hidden flex items-center justify-center p-4 transition-all duration-300 opacity-0">
        <div class="bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-all duration-300 overflow-hidden text-white">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-flag-checkered"></i> –ú–µ–Ω—é</h2>
                <button onclick="closeInfoModal()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="p-6 space-y-4 text-sm text-slate-300">
                <div id="startMenuContent">
                    <p class="mb-4"><strong>–¶–µ–ª—å:</strong> –ù–∞–∫–æ–ø–∏—Ç—å –∫–∞–ø–∏—Ç–∞–ª, –ø–æ–∫–∞ –ó–¥–æ—Ä–æ–≤—å–µ –∏ –°—á–∞—Å—Ç—å–µ –Ω–µ —É–ø–∞–ª–∏ –¥–æ 0.</p>
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 mb-4">
                        <strong class="text-white block mb-1">üî• –ù–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏:</strong>
                        <ul class="list-disc pl-4 space-y-1 text-xs">
                            <li><strong>–ú–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫—É–≤—à–∏–Ω–∞—Ö:</strong> –¢–µ–ø–µ—Ä—å –≤–∏–¥–Ω–æ, —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è –∏ —Å—á–∞—Å—Ç—å—è.</li>
                            <li><strong>–î–∏–ª–µ–º–º—ã:</strong> –í—ã —Å–∞–º–∏ —Ä–µ—à–∞–µ—Ç–µ, —á–µ–º –∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å.</li>
                            <li><strong>–ü–æ—Ç–æ–∫:</strong> –î–µ—Ä–∂–∏—Ç–µ –ó–¥–æ—Ä–æ–≤—å–µ –∏ –°—á–∞—Å—Ç—å–µ –≤—ã—à–µ 80% (3 –º–µ—Å.), —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å.</li>
                            <li><strong>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</strong> –ü–æ–ª—É—á–∞–π—Ç–µ –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –æ—Å–æ–±—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.</li>
                        </ul>
                    </div>
                    <div id="resumeBtnContainer" class="hidden mb-2">
                        <button onclick="closeInfoModal()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                            <i class="fa-solid fa-play"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É
                        </button>
                        <div class="text-center text-[10px] text-slate-500 mt-1">–ù–∞–π–¥–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</div>
                    </div>
                    <button onclick="resetGame()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold shadow-lg mt-2">
                        <i class="fa-solid fa-rotate-right"></i> –ù–æ–≤–∞—è –∏–≥—Ä–∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME OVER / WIN SCREENS (Hidden) -->
    <div id="gameOverScreen" class="fixed inset-0 z-[100] game-over-overlay hidden flex flex-col items-center justify-center text-white p-6 text-center opacity-0 transition-opacity duration-1000">
        <div class="w-20 h-20 rounded-full bg-rose-600 flex items-center justify-center text-3xl mb-4 shadow-[0_0_30px_rgba(225,29,72,0.6)] animate-pulse"><i id="deathIcon" class="fa-solid fa-skull"></i></div>
        <h1 class="text-3xl font-black mb-1">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h1>
        <p id="deathReason" class="text-lg text-rose-300 font-medium mb-6 max-w-sm text-sm">–ü—Ä–∏—á–∏–Ω–∞...</p>
        <button onclick="resetGame()" class="bg-white text-slate-900 hover:bg-slate-200 font-bold py-2.5 px-8 rounded-full text-sm uppercase transition hover:scale-105 shadow-xl">–ó–∞–Ω–æ–≤–æ</button>
    </div>

    <div id="winScreen" class="fixed inset-0 z-[100] game-over-overlay hidden flex flex-col items-center justify-center text-white p-6 text-center opacity-0 transition-opacity duration-1000 bg-slate-900/95">
        <div class="w-24 h-24 rounded-full bg-emerald-500 flex items-center justify-center text-4xl mb-6 shadow-[0_0_50px_rgba(16,185,129,0.5)] animate-bounce"><i class="fa-solid fa-trophy"></i></div>
        <h1 class="text-4xl font-black mb-2 text-emerald-400 tracking-tight">–ü–û–ë–ï–î–ê!</h1>
        <p class="text-lg text-slate-300 font-medium mb-8 max-w-md">–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–≤–æ–±–æ–¥—ã!</p>
        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 mb-8 w-full max-w-sm text-left space-y-4">
             <div class="flex justify-between border-b border-slate-700 pb-2"><span class="text-slate-400 text-xs uppercase">–í—Ä–µ–º—è</span><span class="font-bold"><span id="winMonths">0</span> –º–µ—Å.</span></div>
             <div class="flex justify-between"><span class="text-slate-400 text-xs uppercase">–ö–∞–ø–∏—Ç–∞–ª</span><span class="font-bold text-white" id="winNetWorth">$0</span></div>
        </div>
        <button onclick="resetGame()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-10 rounded-full text-sm uppercase transition hover:scale-105 shadow-xl">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>

    <script>
        const CONFIG = { phase1Goal: 5000, phase2Goal: 1000, baseIncome: 4000, rates: { savings: 0.04, investments: 0.10, debt: 0.15 } };
        
        // --- DATA ---
        const JARS = [
            { id: 'nec', name: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ–µ', def: 60, color: '#64748B', liquid: '#94A3B8', icon: 'fa-house', type: 'exp' }, 
            { id: 'fun', name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', def: 10, color: '#F59E0B', liquid: '#FBBF24', icon: 'fa-champagne-glasses', type: 'exp' }, 
            { id: 'edu', name: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', def: 10, color: '#3B82F6', liquid: '#60A5FA', icon: 'fa-book', type: 'exp' }, 
            { id: 'sav', name: '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è', def: 10, color: '#10B981', liquid: '#34D399', icon: 'fa-piggy-bank', type: 'save' }, 
            { id: 'inv', name: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', def: 10, color: '#6366F1', liquid: '#818CF8', icon: 'fa-chart-line', type: 'invest' }
        ];

        // ACHIEVEMENTS
        const ACHIEVEMENTS = [
            { id: 'scrooge', title: '–°–∫—Ä—è–≥–∞', text: '–ù–∞–∫–æ–ø–∏—Ç—å $1000 –∏ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è 3 –º–µ—Å—è—Ü–∞.', check: (s) => s.savings >= 1000 && s.lowFunStreak >= 3 },
            { id: 'wolf', title: '–í–æ–ª–∫ —Å –£–æ–ª–ª-—Å—Ç—Ä–∏—Ç', text: '–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ > $500/–º–µ—Å.', check: (s, passive) => passive >= 500 },
            { id: 'survivor', title: '–í—ã–∂–∏–≤—à–∏–π', text: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å <15% –¥–æ 100%.', check: (s) => s.wasCriticalHealth && s.health >= 100 }
        ];

        // DILEMMAS (Agency Mechanic)
        const DILEMMAS = [
            {
                id: 'tooth', title: '–ó—É–±–Ω–∞—è –±–æ–ª—å', text: '–ó—É–± –º—É–¥—Ä–æ—Å—Ç–∏ —Ä–µ—à–∏–ª, —á—Ç–æ –ø–æ—Ä–∞. –ë–æ–ª—å –∞–¥—Å–∫–∞—è.', icon: 'fa-tooth',
                options: [
                    { text: '–í –∫–ª–∏–Ω–∏–∫—É (–î–æ—Ä–æ–≥–æ)', cost: 400, health: 5, happy: 0, msg: '–î–æ—Ä–æ–≥–æ, –Ω–æ –Ω–µ –±–æ–ª—å–Ω–æ.' },
                    { text: '–¢–µ—Ä–ø–µ—Ç—å –∏ –ø–∏—Ç—å —Ç–∞–±–ª–µ—Ç–∫–∏', cost: 20, health: -15, happy: -10, msg: '–í—ã —Å—ç–∫–æ–Ω–æ–º–∏–ª–∏, –Ω–æ —Å—Ç—Ä–∞–¥–∞–µ—Ç–µ.' }
                ]
            },
            {
                id: 'burnout', title: '–í—ã–≥–æ—Ä–∞–Ω–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç–µ', text: '–í—ã –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç–µ –±—É–¥–∏–ª—å–Ω–∏–∫. –ö–æ–ª–ª–µ–≥–∏ –±–µ—Å—è—Ç.', icon: 'fa-battery-empty',
                options: [
                    { text: '–í–∑—è—Ç—å –æ—Ç–≥—É–ª—ã (–ü–æ—Ç–µ—Ä—è –¥–æ—Ö–æ–¥–∞)', cost: 300, health: 5, happy: 15, msg: '–í—ã –æ—Ç–¥–æ—Ö–Ω—É–ª–∏, –Ω–æ –ø–æ—Ç–µ—Ä—è–ª–∏ —á–∞—Å—Ç—å –ó–ü.' },
                    { text: '–°–æ–±—Ä–∞—Ç—å—Å—è! (–ü—Ä–µ–º–∏—è)', cost: -200, health: -10, happy: -15, msg: '–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ –ø—Ä–µ–º–∏—é, –Ω–æ –Ω–µ—Ä–≤—ã –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ.' }
                ]
            },
            {
                id: 'course', title: '–ö—É—Ä—Å –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º', text: '–î—Ä—É–≥ —Å–æ–≤–µ—Ç—É–µ—Ç –∫—Ä—É—Ç–æ–π –∫—É—Ä—Å. –ì–æ–≤–æ—Ä–∏—Ç, –æ–∫—É–ø–∏—Ç—Å—è.', icon: 'fa-graduation-cap',
                options: [
                    { text: '–ö—É–ø–∏—Ç—å –∫—É—Ä—Å (-$300)', cost: 300, baseIncome: 150, msg: '–í—ã –ø–æ–≤—ã—Å–∏–ª–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é. –ó–∞—Ä–ø–ª–∞—Ç–∞ –≤—ã—Ä–∞—Å—Ç–µ—Ç.' },
                    { text: '–ü–æ—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—å–∏ (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)', cost: 0, baseIncome: 10, health: -2, msg: '–ú–µ–¥–ª–µ–Ω–Ω–æ, –Ω–æ –≤–µ—Ä–Ω–æ.' }
                ]
            },
            {
                id: 'friend', title: '–°–≤–∞–¥—å–±–∞ –¥—Ä—É–≥–∞', text: '–ù—É–∂–µ–Ω –ø–æ–¥–∞—Ä–æ–∫ –∏ –∫–æ—Å—Ç—é–º. –û—Ç–∫–∞–∑ –æ–±–∏–¥–∏—Ç.', icon: 'fa-gift',
                options: [
                    { text: '–ì—É–ª—è–µ–º! (-$500)', cost: 500, happy: 20, msg: '–û—Ç–ª–∏—á–Ω–∞—è –≤–µ—á–µ—Ä–∏–Ω–∫–∞!' },
                    { text: '–°–∫–∞–∑–∞—Ç—å—Å—è –±–æ–ª—å–Ω—ã–º', cost: 0, happy: -10, health: 0, msg: '–î—Ä—É–≥ –æ–±–∏–¥–µ–ª—Å—è, –≤–∞–º —Å—Ç—ã–¥–Ω–æ.' }
                ]
            },
            {
                id: 'gym', title: '–ê–±–æ–Ω–µ–º–µ–Ω—Ç –≤ –∑–∞–ª', text: '–ê–∫—Ü–∏—è –≤ —Ñ–∏—Ç–Ω–µ—Å-–∫–ª—É–±–µ —É –¥–æ–º–∞.', icon: 'fa-dumbbell',
                options: [
                    { text: '–ö—É–ø–∏—Ç—å –≥–æ–¥–æ–≤–æ–π (-$400)', cost: 400, health: 15, happy: 5, msg: '–¢–µ–ø–µ—Ä—å –≤—ã –∫–∞—á–æ–∫ (–ø–æ—á—Ç–∏).' },
                    { text: '–ë–µ–≥–∞—Ç—å –≤ –ø–∞—Ä–∫–µ', cost: 0, health: 2, happy: -2, msg: '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ —á–∞—Å—Ç–æ –ª–µ–Ω—å.' }
                ]
            }
        ];

        const EVENTS = [
            { text: "–ö–†–ò–ó–ò–°! –û–±–≤–∞–ª —Ä—ã–Ω–∫–∞ –Ω–∞ 25%!", type: 'crash', crash: 0.25, rivalMod: -0.05, icon: 'fa-chart-line-down' },
            { text: "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è —Ä—ã–Ω–∫–∞ (-10%).", type: 'bad', crash: 0.10, rivalMod: -0.02, icon: 'fa-arrow-trend-down' }
        ];

        // --- STATE ---
        let state = { 
            month: 1, phase: 1, savings: 0, investments: 0, debt: 0, baseIncome: CONFIG.baseIncome, 
            allocations: {}, health: 100, happiness: 100, 
            history: { labels: [0], savingsData: [0], investmentsData: [0], rivalData: [0] }, 
            rivalNetWorth: 0, isDead: false, isWon: false,
            flowStreak: 0, isFlow: false, isMuted: false,
            unlockedAchievements: [], lowFunStreak: 0, wasCriticalHealth: false
        };
        
        // --- HAPTIC ---
        function triggerHaptic(pattern) {
            if (navigator.vibrate) navigator.vibrate(pattern);
        }

        JARS.forEach(j => state.allocations[j.id] = j.def);
        
        let els = {}, chartInstance = null, isDragging = false, currentDragJarId = null;
        let audioCtx = null; // AUDIO CONTEXT

        // --- SOUND SYSTEM ---
        const Sound = {
            init: function() {
                if (!window.AudioContext && !window.webkitAudioContext) return;
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playTone: function(freq, type, duration, vol=0.1) {
                if(state.isMuted || !audioCtx) return;
                if(audioCtx.state === 'suspended') audioCtx.resume();
                
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            coin: () => {
                if(state.isMuted || !audioCtx) return;
                Sound.playTone(1200, 'sine', 0.1, 0.1);
                setTimeout(() => Sound.playTone(1600, 'sine', 0.2, 0.1), 50);
            },
            click: () => Sound.playTone(800, 'triangle', 0.05, 0.05),
            bad: () => {
                if(state.isMuted || !audioCtx) return;
                Sound.playTone(150, 'sawtooth', 0.4, 0.15);
                setTimeout(() => Sound.playTone(100, 'sawtooth', 0.4, 0.15), 100);
            },
            win: () => {
                if(state.isMuted || !audioCtx) return;
                [440, 554, 659, 880].forEach((f, i) => setTimeout(() => Sound.playTone(f, 'square', 0.3, 0.1), i * 100));
            }
        };

        // --- PERSISTENCE ---
        function saveGame() {
            try { localStorage.setItem('finRaceSave', JSON.stringify(state)); } catch(e) {}
        }
        function loadGame() {
            try {
                const saved = localStorage.getItem('finRaceSave');
                if (saved) return JSON.parse(saved);
            } catch(e) {}
            return null;
        }
        function resetGame() {
            localStorage.removeItem('finRaceSave');
            
            // Soft Reset State (Keep Mute Setting)
            const currentMuted = state.isMuted;
            state = { 
                month: 1, phase: 1, savings: 0, investments: 0, debt: 0, baseIncome: CONFIG.baseIncome, 
                allocations: {}, health: 100, happiness: 100, 
                history: { labels: [0], savingsData: [0], investmentsData: [0], rivalData: [0] }, 
                rivalNetWorth: 0, isDead: false, isWon: false,
                flowStreak: 0, isFlow: false, isMuted: currentMuted,
                unlockedAchievements: [], lowFunStreak: 0, wasCriticalHealth: false
            };
            JARS.forEach(j => state.allocations[j.id] = j.def);

            // Reset UI
            els.incomeInput.value = state.baseIncome;
            els.resumeBtnContainer.classList.add('hidden');
            els.gameOverScreen.classList.add('hidden');
            els.winScreen.classList.add('hidden');
            els.gameOverScreen.classList.add('opacity-0'); // Reset opacity fade
            
            // Close modal to start playing immediately
            closeInfoModal();
            
            // Re-render
            if(chartInstance) chartInstance.destroy();
            initChart();
            renderJars();
            updateUI();
            renderRoom();
            
            showToast('–ù–æ–≤–∞—è –∏–≥—Ä–∞', '–£–¥–∞—á–∏!', 'good');
        }

        // --- INIT ---
        function init() {
            // Mapping DOM elements
            const ids = ['jarsContainer','incomeInput','realIncomeVal','incomePenaltyBox','penaltyPercent','hudHealthBar','hudHealthVal','hudHappyBar','hudHappyVal',
                         'hudNetWorth','savingsInterestText','investmentInterestText','goalTitle','goalValue','goalProgressBar',
                         'infoModal','reportPanel','mobileOverlay','reportMonthNum','reportContent','dilemmaModal',
                         'gameOverScreen','deathReason','deathIcon','winScreen','roomProgress','vitalsPanel','flowBadge','flowLabel',
                         'historyChart', 'soundBtn', 'resumeBtnContainer']; 
            ids.forEach(id => els[id] = document.getElementById(id));

            // Check save
            const savedState = loadGame();
            if (savedState) {
                // Keep default methods/structures not in JSON, but overwrite data
                // Need to merge strictly
                state = { ...state, ...savedState };
                // Fix history if empty/bugged
                if(!state.history.labels.length) state.history = { labels: [0], savingsData: [0], investmentsData: [0], rivalData: [0] };
                els.resumeBtnContainer.classList.remove('hidden');
            } else {
                // New game state
                JARS.forEach(j => state.allocations[j.id] = j.def);
            }

            renderJars(); initChart(); updateUI(); renderRoom();
            
            els.incomeInput.value = state.baseIncome;
            els.incomeInput.addEventListener('input', (e) => { state.baseIncome = Math.max(0, parseInt(e.target.value) || 0); updateUI(); });
            document.getElementById('nextMonthBtn').addEventListener('click', () => { Sound.init(); runTurnCycle(); }); 
            if(document.getElementById('repayDebtBtn')) document.getElementById('repayDebtBtn').addEventListener('click', () => { Sound.coin(); repayDebt(); });
            
            // Sound Toggle
            updateSoundBtn();
            els.soundBtn.addEventListener('click', () => {
                state.isMuted = !state.isMuted;
                updateSoundBtn();
                if(!state.isMuted && !audioCtx) Sound.init();
            });

            window.addEventListener('mouseup', endDrag); window.addEventListener('touchend', endDrag);
            window.addEventListener('mousemove', onDragMove); window.addEventListener('touchmove', onDragMove, { passive: false });
            
            setTimeout(openInfoModal, 500);
        }

        function updateSoundBtn() {
            els.soundBtn.innerHTML = state.isMuted ? '<i class="fa-solid fa-volume-xmark"></i>' : '<i class="fa-solid fa-volume-high"></i>';
            els.soundBtn.className = state.isMuted 
                ? "w-6 h-6 rounded-full bg-slate-200 text-slate-400 text-[10px] flex items-center justify-center transition-colors flex-shrink-0"
                : "w-6 h-6 rounded-full bg-slate-700 hover:bg-slate-600 text-white text-[10px] flex items-center justify-center transition-colors flex-shrink-0";
        }

        window.openInfoModal = function() { els.infoModal.classList.remove('hidden'); setTimeout(() => els.infoModal.classList.remove('opacity-0'), 10); }
        window.closeInfoModal = function() { els.infoModal.classList.add('opacity-0'); setTimeout(() => els.infoModal.classList.add('hidden'), 300); }

        function startDrag(jarId) { 
            if(state.isDead || state.isWon) return; 
            isDragging = true; currentDragJarId = jarId; 
            triggerHaptic(5); // Soft click
            if(!audioCtx) Sound.init(); 
        }
        function endDrag() { 
            if(isDragging) Sound.click(); 
            isDragging = false; currentDragJarId = null; 
        }
        function onDragMove(e) {
            if (!isDragging || !currentDragJarId) return;
            e.preventDefault();
            const container = document.getElementById(`jar-cont-${currentDragJarId}`);
            if (!container) return;
            const rect = container.getBoundingClientRect();
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let percent = ((rect.bottom - clientY) / rect.height) * 100;
            state.allocations[currentDragJarId] = Math.round(Math.max(0, Math.min(100, percent)));
            
            if (currentDragJarId !== 'sav') {
                let bufferId = 'sav';
                if (currentDragJarId === 'sav') bufferId = 'inv'; 
                let used = 0;
                for(let key in state.allocations) if(key !== bufferId) used += state.allocations[key];
                state.allocations[bufferId] = Math.max(0, 100 - used);
            }
            updateUI();
        }

        function renderJars() {
            els.jarsContainer.innerHTML = '';
            JARS.forEach(jar => {
                const card = document.createElement('div');
                card.className = 'jar-card bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-64 select-none';
                card.innerHTML = `
                    <div class="p-2 bg-white z-10 border-b border-slate-100 pointer-events-none text-center">
                        <div class="flex justify-center items-center gap-1.5 mb-1">
                            <div class="w-5 h-5 rounded bg-slate-50 flex items-center justify-center text-[10px]" style="color:${jar.color}"><i class="fa-solid ${jar.icon}"></i></div>
                            <h3 class="font-bold text-slate-700 text-[10px] uppercase truncate">${jar.name}</h3>
                        </div>
                        <div class="flex justify-center items-baseline gap-1">
                            <span id="pct-${jar.id}" class="text-[10px] font-bold text-slate-400 tabular-nums">0%</span>
                            <span id="val-${jar.id}" class="font-bold text-slate-800 text-xs tabular-nums">$0</span>
                        </div>
                    </div>
                    <div id="jar-cont-${jar.id}" class="jar-container flex-grow relative w-full group cursor-ns-resize bg-slate-50">
                        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#cbd5e1 1px, transparent 1px); background-size: 100% 20px;"></div>
                        <div id="liq-${jar.id}" class="jar-liquid w-full absolute bottom-0 transition-all duration-150 ease-out pointer-events-none" style="background-color: ${jar.liquid}; height: ${state.allocations[jar.id]}%;">
                             <div class="jar-surface absolute top-0 w-full h-0 border-t-2 border-white/50 flex justify-center"><div class="jar-handle w-5 h-5 bg-white rounded-full shadow-md flex items-center justify-center -translate-y-1/2 text-slate-400 text-[8px] group-hover:scale-110 transition-transform"><i class="fa-solid fa-grip-lines"></i></div></div>
                        </div>
                        <!-- MARKERS CONTAINER -->
                        <div id="markers-${jar.id}" class="absolute inset-0 pointer-events-none"></div>
                    </div>`;
                els.jarsContainer.appendChild(card);
                const cont = card.querySelector('.jar-container');
                cont.addEventListener('mousedown', () => startDrag(jar.id));
                cont.addEventListener('touchstart', (e) => { startDrag(jar.id); onDragMove(e); }, { passive: false });
                
                // CREATE MARKERS ONCE
                const mCont = document.getElementById(`markers-${jar.id}`);
                if (jar.id === 'nec') {
                    // Static markers for Necessities
                    createMarker(mCont, 40, 'HP Crit', 'marker-red');
                    createMarker(mCont, 55, 'HP OK', 'marker-green');
                } else if (jar.id === 'fun' || jar.id === 'edu') {
                    // Dynamic markers for Happiness
                    createMarker(mCont, 0, 'Happy OK', 'marker-yellow', `d-ok-${jar.id}`);
                    createMarker(mCont, 0, 'Happy+', 'marker-green', `d-good-${jar.id}`);
                }
            });
        }

        function createMarker(container, bottomPct, text, colorClass, id=null) {
            const m = document.createElement('div');
            m.className = `jar-marker ${colorClass}`;
            m.style.bottom = bottomPct + '%';
            if(id) m.id = id;
            m.innerHTML = `<span>${text}</span>`;
            container.appendChild(m);
        }

        // --- CALCULATIONS ---
        function calculateRealIncome() {
            let penalty = 0;
            if (state.health < 50) penalty += (50 - state.health) * 0.015; 
            if (state.happiness < 50) penalty += (50 - state.happiness) * 0.01;
            penalty = Math.min(0.9, penalty);
            let amount = Math.floor(state.baseIncome * (1 - penalty));
            if (state.isFlow) amount = Math.floor(amount * 1.1);
            return { realIncome: amount, penaltyPct: penalty };
        }
        function calculatePassiveIncome() { 
            const invRate = state.phase === 1 ? CONFIG.rates.savings : CONFIG.rates.investments;
            return { savIncome: state.savings * (CONFIG.rates.savings / 12), invIncome: state.investments * (invRate / 12), debtCost: state.debt * (CONFIG.rates.debt / 12), totalPassive: (state.savings * (CONFIG.rates.savings / 12)) + (state.investments * (invRate / 12)) }; 
        }

        // --- NEW FEATURES LOGIC ---
        function renderRoom() {
            const net = state.savings + state.investments - state.debt;
            const thresholds = [0, 5000, 20000, 100000]; 
            let currentLvl = 0;
            if (net >= thresholds[2]) currentLvl = 3;
            else if (net >= thresholds[1]) currentLvl = 2;
            else if (net >= thresholds[0] + 1000) currentLvl = 1;

            // Sound on Level Up (simple check)
            if (state.lastLvl !== undefined && currentLvl > state.lastLvl) {
                Sound.win();
                triggerHaptic([50, 50, 50]);
            }
            state.lastLvl = currentLvl;

            for(let i=0; i<=3; i++) {
                const el = document.getElementById(`lvl-${i}`);
                if(el) {
                    if (i <= currentLvl) {
                        if (!el.classList.contains('active')) {
                            el.classList.add('active', 'just-unlocked');
                            setTimeout(() => el.classList.remove('just-unlocked'), 1000);
                        }
                    } else {
                        el.classList.remove('active');
                    }
                }
            }
            let nextGoal = thresholds[1];
            if(currentLvl === 1) nextGoal = thresholds[2];
            if(currentLvl >= 2) nextGoal = thresholds[3];
            const pct = Math.min(100, Math.max(0, (net / nextGoal) * 100));
            els.roomProgress.style.width = pct + '%';
        }

        function checkFlowState() {
            if (state.health >= 80 && state.happiness >= 80) state.flowStreak++;
            else { state.flowStreak = 0; state.isFlow = false; }

            if (state.flowStreak >= 3 && !state.isFlow) {
                state.isFlow = true;
                Sound.win(); 
                triggerHaptic([50, 50, 100]);
                showToast('–í –ü–û–¢–û–ö–ï!', '–í—ã –≤–æ—à–ª–∏ –≤ —Ä–µ–∂–∏–º –≤—ã—Å–æ–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (+10% –¥–æ—Ö–æ–¥).', 'good');
            }
            updateUI();
        }

        function checkAchievements() {
            const passive = calculatePassiveIncome().totalPassive;
            
            // Track metrics
            if (state.allocations.fun === 0) state.lowFunStreak++; else state.lowFunStreak = 0;
            if (state.health < 15) state.wasCriticalHealth = true;

            ACHIEVEMENTS.forEach(ach => {
                if (!state.unlockedAchievements.includes(ach.id)) {
                    if (ach.check(state, passive)) {
                        state.unlockedAchievements.push(ach.id);
                        Sound.win();
                        triggerHaptic([100, 100, 200]);
                        showToast(`<i class="fa-solid fa-trophy text-amber-400"></i> ${ach.title}`, ach.text, 'good');
                    }
                }
            });
        }

        // --- TURN LOGIC ---
        function runTurnCycle() {
            if(state.isDead || state.isWon) return;
            if(checkDeath()) return;

            triggerHaptic(10); // Button press feedback

            const nec = state.allocations.nec; const fun = state.allocations.fun; const edu = state.allocations.edu;
            if(nec<40) state.health -= 12; else if(nec<55) state.health -= 6; else state.health += 3;
            if((fun+edu)<15) state.happiness -= 12; else if((fun+edu)<25) state.happiness -= 6; else state.happiness += 3;
            state.health = Math.max(0, Math.min(100, state.health)); 
            state.happiness = Math.max(0, Math.min(100, state.happiness));
            
            checkFlowState();
            if (checkDeath()) return;

            const roll = Math.random();
            let turnEvent = null;
            if (roll < 0.20) {
                const dilemma = DILEMMAS[Math.floor(Math.random() * DILEMMAS.length)];
                Sound.bad(); triggerHaptic(50);
                showDilemma(dilemma); 
                return; 
            } else if (roll < 0.25) {
                turnEvent = EVENTS[0];
            } else if (roll < 0.35) { // Added 10% chance for correction to make rival graph interesting
                turnEvent = EVENTS[1];
            }
            completeTurn(turnEvent);
        }

        function showDilemma(dilemma) {
            const modal = els.dilemmaModal;
            const title = document.getElementById('dilemmaTitle');
            const desc = document.getElementById('dilemmaDesc');
            const opts = document.getElementById('dilemmaOptions');
            const icon = document.getElementById('dilemmaIcon');

            title.innerText = dilemma.title;
            desc.innerText = dilemma.text;
            icon.innerHTML = `<i class="fa-solid ${dilemma.icon}"></i>`;
            opts.innerHTML = '';

            dilemma.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 rounded-lg border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all flex justify-between items-center group";
                btn.innerHTML = `<div><div class="font-bold text-slate-800 text-sm">${opt.text}</div><div class="text-[10px] text-slate-400 group-hover:text-indigo-400">–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã...</div></div><i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-indigo-500"></i>`;
                btn.onclick = () => { Sound.click(); resolveDilemma(opt); };
                opts.appendChild(btn);
            });
            modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function resolveDilemma(option) {
            if (option.cost) {
                let cost = option.cost;
                if (state.savings >= cost) state.savings -= cost;
                else { let rem = cost - state.savings; state.savings = 0; state.debt += rem; }
            }
            if (option.baseIncome) state.baseIncome += option.baseIncome;
            if (option.health) state.health = Math.max(0, Math.min(100, state.health + option.health));
            if (option.happy) state.happiness = Math.max(0, Math.min(100, state.happiness + option.happy));

            const modal = els.dilemmaModal;
            modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300);

            const resultEvent = { text: `${option.msg}`, type: option.cost > 0 ? 'bad' : 'good' };
            completeTurn(resultEvent);
        }

        function completeTurn(event) {
            // Player Crash Logic
            if(event && (event.type === 'crash' || event.crash)) { 
                if (event.crash) {
                    state.investments *= (1 - event.crash); 
                    triggerShake(); 
                    Sound.bad();
                    triggerHaptic(400); // Long vibrate on crash
                    showToast(event.text, `–ü–æ—Ç–µ—Ä—è–Ω–æ ${event.crash*100}% –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π`, 'bad');
                }
            }

            // Rival Crash Logic (Added back)
            if (event && event.rivalMod) {
                state.rivalNetWorth *= (1 + event.rivalMod);
            }

            const inc = calculateRealIncome(); const pas = calculatePassiveIncome();
            state.savings += pas.savIncome; state.investments += pas.invIncome; state.debt += pas.debtCost;

            let effInc = inc.realIncome;
            const bal = Object.values(state.allocations).reduce((a,b)=>a+b,0);
            const balancePct = 100 - bal; 
            const rem = (effInc * balancePct) / 100;
            
            let addSav = (effInc * state.allocations.sav) / 100;
            let addInv = (effInc * state.allocations.inv) / 100;
            let addDebt = 0;
            
            if(rem > 0) { 
                if (state.debt > 0) { 
                    if (state.debt >= rem) state.debt -= rem; 
                    else { const l = rem - state.debt; state.debt = 0; addSav += l; } 
                } else addSav += rem; 
            } else addDebt += Math.abs(rem);
            
            state.savings += addSav; state.investments += addInv; state.debt += addDebt;
            const rivalIncome = state.baseIncome; state.rivalNetWorth += (rivalIncome * 0.20); state.rivalNetWorth *= 1.004;

            if(state.phase === 1 && state.savings >= CONFIG.phase1Goal && state.debt <= 0) { 
                state.phase = 2; document.getElementById('mainHeader').classList.add('border-amber-500', 'border-b-4'); 
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                Sound.win();
                triggerHaptic([100, 50, 100]);
            }

            const net = state.savings + state.investments - state.debt;
            state.history.labels.push(state.month); state.history.savingsData.push(state.savings);
            state.history.investmentsData.push(state.investments); state.history.rivalData.push(state.rivalNetWorth); 
            if(chartInstance) chartInstance.update(); 

            state.month++; 
            checkAchievements(); // Check achievements
            updateUI(); renderRoom();
            saveGame(); // Autosave
            
            // Sounds for income
            if(addSav > 10 || addInv > 10) Sound.coin();

            if(addSav > 10) spawnFloatingText('sav', addSav, 'good');
            if(addInv > 10) spawnFloatingText('inv', addInv, 'invest');

            if (event && event.type !== 'crash') showToast("–†–µ–∑—É–ª—å—Ç–∞—Ç", event.text, event.type === 'good' ? 'good' : 'neutral');
            else if (!event) {
                let msg = `–ö–∞–ø–∏—Ç–∞–ª: $${Math.floor(net).toLocaleString()}`;
                if(state.isFlow) msg = `üî• –ü–û–¢–û–ö! –ö–∞–ø–∏—Ç–∞–ª: $${Math.floor(net).toLocaleString()}`;
                showToast(`–ú–µ—Å—è—Ü ${state.month-1}`, msg, 'neutral');
            }

            if(state.phase === 2 && (pas.savIncome + pas.invIncome) >= CONFIG.phase2Goal) triggerWin();
        }

        // --- UI UPDATES ---
        function updateUI() {
            const inc = calculateRealIncome(); const pas = calculatePassiveIncome();
            
            // Jars
            JARS.forEach(jar => { 
                const pct = state.allocations[jar.id], amount = (inc.realIncome * pct) / 100; 
                const valEl = document.getElementById(`val-${jar.id}`);
                const pctEl = document.getElementById(`pct-${jar.id}`);
                const liqEl = document.getElementById(`liq-${jar.id}`);
                if(valEl) valEl.innerText = '$' + Math.floor(amount).toLocaleString(); 
                if(pctEl) pctEl.innerText = pct + '%'; 
                if(liqEl) liqEl.style.height = pct + '%'; 
            });

            // UPDATE DYNAMIC MARKERS
            const funPct = state.allocations.fun;
            const eduPct = state.allocations.edu;
            
            const okFun = Math.max(0, 15 - eduPct);
            const goodFun = Math.max(0, 25 - eduPct);
            const okEdu = Math.max(0, 15 - funPct);
            const goodEdu = Math.max(0, 25 - funPct);

            const mOkFun = document.getElementById('d-ok-fun');
            const mGoodFun = document.getElementById('d-good-fun');
            const mOkEdu = document.getElementById('d-ok-edu');
            const mGoodEdu = document.getElementById('d-good-edu');

            if(mOkFun) mOkFun.style.bottom = okFun + '%';
            if(mGoodFun) mGoodFun.style.bottom = goodFun + '%';
            if(mOkEdu) mOkEdu.style.bottom = okEdu + '%';
            if(mGoodEdu) mGoodEdu.style.bottom = goodEdu + '%';

            // Vitals
            els.hudHealthBar.style.width = state.health + '%'; els.hudHealthVal.innerText = Math.round(state.health) + '%'; 
            els.hudHappyBar.style.width = state.happiness + '%'; els.hudHappyVal.innerText = Math.round(state.happiness) + '%';
            
            if (state.isFlow) { els.vitalsPanel.classList.add('flow-glow'); els.flowBadge.classList.remove('hidden'); els.flowLabel.classList.remove('opacity-0'); } 
            else { els.vitalsPanel.classList.remove('flow-glow'); els.flowBadge.classList.add('hidden'); els.flowLabel.classList.add('opacity-0'); }

            els.realIncomeVal.innerText = '$' + inc.realIncome.toLocaleString();
            if (inc.penaltyPct > 0) { els.incomePenaltyBox.classList.remove('hidden'); els.penaltyPercent.innerText = `-${Math.round(inc.penaltyPct*100)}%`; } else els.incomePenaltyBox.classList.add('hidden');

            els.savingsInterestText.innerText = `+$${Math.floor(pas.savIncome)}/–º–µ—Å`;
            els.investmentInterestText.innerText = `+$${Math.floor(pas.invIncome)}/–º–µ—Å`;
            const net = state.savings + state.investments - state.debt;
            els.hudNetWorth.innerText = '$' + Math.floor(net).toLocaleString();

            let target = state.phase === 1 ? CONFIG.phase1Goal : CONFIG.phase2Goal;
            let current = state.phase === 1 ? state.savings : (pas.savIncome + pas.invIncome);
            els.goalTitle.innerText = state.phase === 1 ? "–¶–µ–ª—å: –ü–æ–¥—É—à–∫–∞" : "–¶–µ–ª—å: –ü–∞—Å—Å–∏–≤–Ω—ã–π –î–æ—Ö–æ–¥";
            els.goalValue.innerText = `$${Math.floor(current).toLocaleString()} / $${target.toLocaleString()}`;
            els.goalProgressBar.style.width = Math.min(100, Math.max(0, (current / target) * 100)) + '%';
            
             if (state.debt > 5 && state.savings > 5) { 
                 document.getElementById('debtRepayContainer').classList.remove('hidden'); 
                 document.getElementById('currentDebtVal').innerText = '-$' + Math.floor(state.debt).toLocaleString(); 
             } else document.getElementById('debtRepayContainer').classList.add('hidden');

            const bal = Object.values(state.allocations).reduce((a,b)=>a+b,0);
            document.getElementById('totalPercent').innerText = bal; // Fix: Update text content
            const balEl = document.getElementById('balanceBadgeContainer');
            if(bal > 100) { document.getElementById('totalPercent').className = "text-2xl font-black text-rose-500"; balEl.innerHTML = `<div class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-rose-100 text-rose-700 uppercase">–î–µ—Ñ–∏—Ü–∏—Ç ${bal-100}%</div>`; } 
            else if (bal < 100) { document.getElementById('totalPercent').className = "text-2xl font-black text-emerald-500"; balEl.innerHTML = `<div class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700 uppercase">–û—Å—Ç–∞—Ç–æ–∫ ${100-bal}%</div>`; } 
            else { document.getElementById('totalPercent').className = "text-2xl font-black text-slate-800"; balEl.innerHTML = `<div class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-slate-200 text-slate-500 uppercase">–ò–¥–µ–∞–ª—å–Ω–æ</div>`; }
        }

        // --- UTILS ---
        function repayDebt() {
            if (state.debt <= 0 || state.savings <= 0) return;
            let amount = Math.min(state.debt, state.savings); state.debt -= amount; state.savings -= amount;
            updateUI(); 
        }

        function spawnFloatingText(jarId, amount, type = 'good') {
            const elementId = `jar-cont-${jarId}`;
            const el = document.getElementById(elementId);
            if (!el) return;
            const rect = el.getBoundingClientRect();
            const floater = document.createElement('div');
            const text = (amount > 0 ? '+' : '') + '$' + Math.abs(Math.floor(amount)).toLocaleString();
            floater.innerText = text;
            let colorClass = 'text-emerald-600';
            if(type === 'bad') colorClass = 'text-rose-600';
            if(type === 'invest') colorClass = 'text-indigo-600';
            floater.className = `float-text ${colorClass} text-xl font-black`;
            floater.style.left = (rect.left + rect.width / 2 - 20) + 'px'; 
            floater.style.top = (rect.top + window.scrollY + 50) + 'px';
            document.body.appendChild(floater);
            setTimeout(() => floater.remove(), 1200);
        }

        function showToast(title, message, type = 'neutral') {
            const toast = document.getElementById('gameToast');
            document.getElementById('toastTitle').innerHTML = title;
            document.getElementById('toastMessage').innerText = message;
            const tIcon = document.getElementById('toastIcon');
            if(type === 'good') { tIcon.className = "w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-xs"; tIcon.innerHTML = '<i class="fa-solid fa-check"></i>'; }
            else if(type === 'bad') { tIcon.className = "w-6 h-6 rounded-full bg-rose-500 flex items-center justify-center text-xs"; tIcon.innerHTML = '<i class="fa-solid fa-exclamation"></i>'; }
            else { tIcon.className = "w-6 h-6 rounded-full bg-slate-500 flex items-center justify-center text-xs"; tIcon.innerHTML = '<i class="fa-solid fa-info"></i>'; }
            toast.classList.add('show');
            if(window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 2500);
        }

        function triggerShake() { document.body.classList.add('shake-screen'); setTimeout(() => document.body.classList.remove('shake-screen'), 500); }
        function checkDeath() { if (state.health <= 0) { triggerDeath("–ò—Å—Ç–æ—â–µ–Ω–∏–µ.", "fa-heart-crack"); return true; } if (state.happiness <= 0) { triggerDeath("–í—ã–≥–æ—Ä–∞–Ω–∏–µ.", "fa-face-dizzy"); return true; } return false; }
        function triggerDeath(reason, icon) { state.isDead = true; document.getElementById('deathReason').innerText = reason; document.getElementById('deathIcon').className = `fa-solid ${icon}`; els.gameOverScreen.classList.remove('hidden'); setTimeout(() => els.gameOverScreen.classList.remove('opacity-0'), 50); Sound.bad(); triggerHaptic(300); localStorage.removeItem('finRaceSave'); }
        
        function triggerWin() {
            state.isWon = true;
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            document.getElementById('winMonths').innerText = state.month;
            document.getElementById('winPassive').innerText = '$' + Math.floor((state.savings * 0.04/12) + (state.investments * 0.1/12)).toLocaleString() + '/–º–µ—Å';
            document.getElementById('winNetWorth').innerText = '$' + Math.floor(state.savings + state.investments).toLocaleString();
            els.winScreen.classList.remove('hidden');
            setTimeout(() => els.winScreen.classList.remove('opacity-0'), 50);
            Sound.win();
            triggerHaptic([100, 100, 100, 100, 500]);
            localStorage.removeItem('finRaceSave');
        }

        function initChart() {
            if(!els.historyChart) return;
            const ctx = els.historyChart.getContext('2d');
            chartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: state.history.labels, 
                    datasets: [
                        { 
                            label: '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è', 
                            data: state.history.savingsData, 
                            borderColor: '#10B981', 
                            backgroundColor: 'rgba(16, 185, 129, 0.4)', 
                            fill: 'origin', 
                            pointRadius: 0, 
                            borderWidth: 1, 
                            stack: 'player' 
                        },
                        { 
                            label: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', 
                            data: state.history.investmentsData, 
                            borderColor: '#6366F1', 
                            backgroundColor: 'rgba(99, 102, 241, 0.4)', 
                            fill: '-1', 
                            pointRadius: 0, 
                            borderWidth: 1, 
                            stack: 'player' 
                        },
                        { 
                            label: '–î–∂–æ–Ω', 
                            data: state.history.rivalData, 
                            borderColor: '#94A3B8', 
                            borderDash: [5, 5], 
                            fill: false, 
                            tension: 0.4, 
                            pointRadius: 0, 
                            borderWidth: 2, 
                            stack: 'rival' 
                        }
                    ] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { display: true, position: 'top', align: 'end', labels: { boxWidth: 8, font: { size: 10 }, usePointStyle: true } },
                        tooltip: { mode: 'index', intersect: false }
                    }, 
                    scales: { 
                        x: { display: false }, 
                        y: { stacked: true, grid: { borderDash: [4, 4], color: '#f1f5f9' } } 
                    } 
                } 
            });
        }

        window.closeReport = function() { els.reportPanel.classList.remove('open'); els.mobileOverlay.classList.add('opacity-0'); setTimeout(() => els.mobileOverlay.classList.add('hidden'), 300); }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
