<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>5 –ö—É–≤—à–∏–Ω–æ–≤</title>

<!-- Tailwind + Chart.js + noUiSlider -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link  href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.js"></script>

<style>
/* –∫—É–≤—à–∏–Ω—ã-–ø–æ–ª–∑—É–Ω–∫–∏ */
.jar-wrap{width:120px;display:flex;flex-direction:column;align-items:center}
.jar{width:80px;height:160px;border:4px solid #555;border-radius:8px 8px 32px 32px;
     background:#fff;overflow:hidden;position:relative}
.liquid{position:absolute;bottom:0;left:0;width:100%;height:0;
        background:linear-gradient(#4ade80,#16a34a);transition:.25s}
.slider-v{height:160px;margin-top:12px}
.jar-caption{height:60px;font:600 15px/1.1 sans-serif;text-align:center}

/* –≤–µ—Ä—Ö–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω—ã */
.glass-wrap{width:100px;display:flex;flex-direction:column;align-items:center}
.glass{width:70px;height:140px;border:4px solid #555;border-radius:8px 8px 28px 28px;
       background:#fff;overflow:hidden;position:relative}
.liquid-glass{position:absolute;bottom:0;left:0;width:100%;height:0;transition:.25s}
.neg-liquid{background:#e11d48!important}.neg-text{color:#e11d48!important}

/* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã */
.vbar{width:26px;height:140px;border-radius:13px;background:#d1d5db;overflow:hidden;position:relative}
.vbar-fill{position:absolute;bottom:0;width:100%;height:0;transition:.25s}
.vbar-text{position:absolute;top:4px;width:100%;font:700 14px/1 sans-serif;text-align:center}

/* –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ */
.mini-chart-box{width:100px;height:140px;display:flex;align-items:center;justify-content:center;position:relative}
#scoreChart{width:100px!important;height:100px!important}
#scoreBig{position:absolute;top:0;width:100%;font:700 18px/1 sans-serif;text-align:center}

/* –∑–∞—Ç–µ–º–Ω—è—é—â–∏–π —Ñ–æ–Ω —Ç—É—Ç–æ—Ä–∏–∞–ª–∞ */
</style>
</head>
<body class="bg-gray-100">

<!-- üõà –º–∏–Ω–∏-—Ç—É—Ç–æ—Ä–∏–∞–ª -->
<div id="tutorial" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden">
  <div class="bg-white rounded shadow max-w-md w-11/12 p-6 text-center space-y-4">
    <h3 id="tutTitle" class="text-xl font-bold"></h3>
    <p id="tutText"></p>
    <button id="tutNext" class="bg-blue-600 text-white px-4 py-2 rounded">–î–∞–ª—å—à–µ</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–¢–ê–†–¢ ‚îÄ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="start-screen" class="min-h-screen flex flex-col items-center justify-center p-6">
  <h1 class="text-5xl font-bold mb-6"><span class="mr-2">üí∞</span>5 –ö—É–≤—à–∏–Ω–æ–≤</h1>

  <div class="bg-white p-6 rounded shadow w-full max-w-sm space-y-4 text-left">

    <!-- –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
    <p class="font-semibold">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–≥—Ä—ã:</p>
    <div class="flex gap-4">
      <button onclick="startGame(24)" class="flex-1 bg-green-600 text-white py-2 rounded">24 –º–µ—Å</button>
      <button onclick="startGame(36)" class="flex-1 bg-blue-600  text-white py-2 rounded">36 –º–µ—Å</button>
    </div>

    <!-- —Ä–µ–∂–∏–º -->
    <p class="font-semibold mt-4 mb-1">–ö–∞–∫ –Ω–∞—á–∞—Ç—å?</p>
    <label class="block"><input type="radio" name="mode" value="role" checked> <span class="ml-1">–í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å</span></label>
    <label class="block"><input type="radio" name="mode" value="goal"> <span class="ml-1">–í—ã–±—Ä–∞—Ç—å —Ü–µ–ª—å</span></label>
    <label class="block"><input type="radio" name="mode" value="free"> <span class="ml-1">–°–≤–æ–±–æ–¥–Ω—ã–π –ø–ª–∞–Ω</span></label>

    <!-- —Ä–æ–ª–∏ -->
    <div id="roleBlock" class="mt-4">
      <p class="font-semibold mb-1">–†–æ–ª—å:</p>
      <label class="mr-4"><input type="radio" name="role" value="Saver" checked> Saver</label>
      <label class="mr-4"><input type="radio" name="role" value="Investor"> Investor</label>
      <label class="mr-4"><input type="radio" name="role" value="Spec"> Speculator</label>
    </div>

    <!-- —Ü–µ–ª–∏ -->
    <div id="goalBlock" class="mt-4 hidden">
      <label class="font-semibold mb-1">–¶–µ–ª—å:</label>
      <select id="goalSelect" class="w-full border p-2 rounded">
        <option value="buffer">–ü–æ–¥—É—à–∫–∞ 12 –º–µ—Å</option>
        <option value="passive">–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ $1000/–º–µ—Å</option>
        <option value="tenk">–ù–∞–∫–æ–ø–∏—Ç—å $10000</option>
      </select>
    </div>

    <!-- –∞–≤—Ç–æ–¥–æ–ª–∏–≤ -->
    <label class="flex items-center space-x-2 mt-4">
      <input id="autoAdjust" type="checkbox" class="h-4 w-4 text-blue-600 rounded">
      <span class="text-sm">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –≤ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è</span>
    </label>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ò–ì–†–ê ‚îÄ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game-screen" class="hidden p-6 space-y-6 max-w-7xl mx-auto">

  <!-- –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div class="flex flex-wrap gap-6 mb-8 justify-center">
    <!-- —Å—Ç–∞–∫–∞–Ω—ã -->
    <template id="glassTpl">
      <div class="glass-wrap">
        <div class="glass"><div class="liquid-glass"></div></div>
        <p class="mt-1 font-semibold text-center text-sm"></p>
      </div>
    </template>
  </div>

  <!-- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ -->
  <div class="grid grid-cols-2 gap-6">
    <div><label class="font-semibold">–î–æ—Ö–æ–¥—ã ($)</label><p id="incomeDisplay" class="border p-2 rounded bg-gray-50">$0</p></div>
    <div><label class="font-semibold">–†–∞—Å—Ö–æ–¥—ã ($)</label><p id="expensesDisplay" class="border p-2 rounded bg-gray-50">$0</p></div>
  </div>

  <!-- 6 –∫—É–≤—à–∏–Ω–æ–≤ -->
  <div class="flex flex-wrap gap-6 mb-8" id="jarsRow"></div>

  <!-- –¥–æ–ø. —Ä–∞–±–æ—Ç–∞ -->
  <label class="font-semibold" for="extra">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞</label>
  <select id="extra" class="border p-2 rounded max-w-xs mb-4"><option>–Ω–µ—Ç</option><option>–¥–∞</option></select>

  <!-- —Ö–æ–¥ -->
  <button onclick="runTurn()" class="w-full py-2 bg-blue-600 text-white font-bold rounded">–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ö–æ–¥</button>

  <!-- –∫—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="text-center space-y-2">
    <p>–•–æ–¥: <span id="turn">0</span> / <span id="maxTurns">0</span></p>
    <p>–°–æ–±—ã—Ç–∏–µ: <span id="event">-</span></p>
    <p>–°–≤–æ–±–æ–¥–Ω—ã–µ $: <span id="free">$0</span></p>
    <p>–°–±–µ—Ä–µ–∂–µ–Ω–∏—è: <span id="savings">$0</span></p>
    <p>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: <span id="investments">$0</span></p>
  </div>

  <!-- –∏—Å—Ç–æ—Ä–∏—è -->
  <div class="mt-8">
    <h2 class="text-xl font-bold text-center mb-2">üìò –ò—Å—Ç–æ—Ä–∏—è —Ö–æ–¥–æ–≤</h2>
    <table class="w-full text-sm bg-white rounded shadow overflow-hidden">
      <thead class="bg-gray-200 font-bold"><tr>
        <th class="p-2">–•–æ–¥</th><th class="p-2">–°–æ–±—ã—Ç–∏–µ</th><th class="p-2">–°–≤–æ–±–æ–¥–Ω—ã–µ $</th>
        <th class="p-2">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è</th><th class="p-2">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</th>
        <th class="p-2">–ó–¥–æ—Ä–æ–≤—å–µ</th><th class="p-2">–°—á–∞—Å—Ç—å–µ</th></tr></thead>
      <tbody id="historyTable" class="text-center"></tbody>
    </table>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ role presets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const rolePresets={
  Saver:{p:{survival:40,comfort:20,save:20,invest:10,health:5,edu:5},
         rules:[{t:'min',jar:'save',v:10},{t:'buf',m:12},{t:'ratio',max:50}],
         bonus:'happy'},
  Investor:{p:{survival:40,comfort:20,save:10,invest:20,health:5,edu:5},
            rules:[{t:'min',jar:'invest',v:15},{t:'buf',m:6},{t:'ratio',max:50}],
            bonus:'happy'},
  Spec:{p:{survival:40,comfort:20,save:5,invest:15,health:3,edu:2},
        rules:[{t:'min',jar:'save',v:5},{t:'ratio',max:50}],
        bonus:'spec'}
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tutorial slides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const tut=[['–®–∞–≥ 1/3','–û—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ ‚â• 10 % –¥–æ—Ö–æ–¥–∞: —Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ ¬´–ø–æ–¥—É—à–∫—É¬ª.'],
           ['–®–∞–≥ 2/3','–ü–æ–¥—É—à–∫–∞ 12 –º–µ—Å ‚Üí –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ ‚â• 15 %.'],
           ['–®–∞–≥ 3/3','–ë–∞–∑–æ–≤—ã–µ —Ç—Ä–∞—Ç—ã ‚â§ 50 % –¥–æ—Ö–æ–¥–∞.']];

function showTut(){
  let i=0;
  const box=document.getElementById('tutorial'),
        ttl=document.getElementById('tutTitle'),
        txt=document.getElementById('tutText'),
        btn=document.getElementById('tutNext');
  const render=()=>{ttl.textContent=tut[i][0];txt.textContent=tut[i][1];
                    btn.textContent=i===tut.length-1?'–ü–æ–Ω—è–ª!':'–î–∞–ª—å—à–µ';};
  render();box.classList.remove('hidden');
  btn.onclick=()=>{i<tut.length-1? (i++,render()) :(box.classList.add('hidden'),localStorage.tut=1)};
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const $=id=>document.getElementById(id);

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ runtime vars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let turn=0,maxTurns=0,health=100,happy=90,savings=0,invest=0,activeRules=[],bonusType='';

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ build static DOM (glasses & jars) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
(function makeDOM(){
  /* –≤–µ—Ä—Ö–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω—ã */
  const top=[
    ['glassIncome','#82A8AB','–î–æ—Ö–æ–¥—ã'],
    ['glassExpenses','#A77F4B','–†–∞—Å—Ö–æ–¥—ã'],
    ['glassSavings','#728565','–°–±–µ—Ä–µ–∂–µ–Ω–∏—è'],
    ['glassInvest','#3B4550','–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏'],
    ['glassSpec','#BF8200','–°–ø–µ–∫—É–ª—è—Ü–∏–∏'],
    ['vHealth','#22c55e','–ó–¥–æ—Ä–æ–≤—å–µ','vbar'],
    ['vHappy' ,'#facc15','–°—á–∞—Å—Ç—å–µ' ,'vbar'],
    ['mini'   ,'','–ë–∞–ª–ª—ã','mini']
  ];
  const wrap=document.querySelector('#game-screen .flex.flex-wrap');
  top.forEach(([id,color,label,type])=>{
    if(type==='vbar'){
      wrap.insertAdjacentHTML('beforeend',`
      <div class="glass-wrap">
        <div class="vbar"><div id="${id}Fill" class="vbar-fill" style="background:${color}"></div>
        <span id="${id}Txt" class="vbar-text">${id==='vHealth'?100:90}%</span></div>
        <p class="mt-1 font-semibold text-center text-sm">${label}</p>
      </div>`);
    }else if(type==='mini'){
      wrap.insertAdjacentHTML('beforeend',`
      <div class="glass-wrap"><div class="mini-chart-box">
        <canvas id="scoreChart"></canvas><span id="scoreBig">0</span></div>
        <p class="mt-1 font-semibold text-center text-sm">–ë–∞–ª–ª—ã</p></div>`);
    }else{
      wrap.insertAdjacentHTML('beforeend',`
      <div class="glass-wrap">
        <div class="glass"><div id="${id}" class="liquid-glass" style="background:${color}"></div></div>
        <p class="mt-1 font-semibold text-center text-sm">${label}</p>
      </div>`);
    }
  });

  /* 6 –∫—É–≤—à–∏–Ω–æ–≤ –∏ —Å–∫—Ä—ã—Ç—ã–µ inputs */
  const jars=[
    ['survival','–í—ã–∂–∏–≤–∞–Ω–∏–µ',500],['comfort','–ö–æ–º—Ñ–æ—Ä—Ç',500],
    ['save','–°–±–µ—Ä–µ–∂–µ–Ω–∏—è',0],['invest','–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',0],
    ['healthSpend','–ó–¥–æ—Ä–æ–≤—å–µ',0],['edu','–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',0]
  ];
  const row=$('#jarsRow');
  jars.forEach(([id,label,val])=>{
    row.insertAdjacentHTML('beforeend',`
     <div class="jar-wrap">
       <div class="jar"><div id="${id}Fill" class="liquid"></div></div>
       <div id="${id}Slider" class="slider-v"></div>
       <div class="jar-caption mt-1">${label}<br><span id="${id==='save'?'saveLabel':id+'Val'}">${val}</span> $</div>
       <input id="${id}" type="hidden" value="${val}">
     </div>`);
  });
})();

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Chart.js mini chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const chart=new Chart($('#scoreChart').getContext('2d'),{
  type:'line',
  data:{labels:[],datasets:[{data:[],borderColor:'#3b82f6',borderWidth:1,
                             tension:.3,fill:false,pointRadius:0}]},
  options:{responsive:false,animation:false,scales:{x:{display:false},y:{display:false}},
           plugins:{legend:{display:false},tooltip:{enabled:false}}}
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ noUiSlider build ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function buildJar(sliderId,fillId,valId,hiddenId,max){
  const s=$(sliderId),fill=$(fillId),val=$(valId),hid=$(hiddenId);
  noUiSlider.create(s,{start:+hid.value,orientation:'vertical',direction:'rtl',
                       step:10,connect:[true,false],range:{min:0,max}});
  s.noUiSlider.on('update',v=>{
    const num=Math.round(v[0]);fill.style.height=(num/max*100)+'%';
    val.textContent=num;hid.value=num;updateIncomeExpenses();
  });
}
['survival','comfort','save','invest','healthSpend','edu'].forEach(id=>{
  buildJar(id+'Slider',id+'Fill',id==='save'?'saveLabel':id+'Val',id,2000);
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –≤–µ—Ä—Ö–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω—ã & –ø–æ–ª–æ—Å—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function updateGlasses(inc,surv,comf,saveP,invP){
  const full=inc*2||1,setH=(el,v)=>el.style.height=(Math.min(Math.abs(v),full)/full*100)+'%';
  setH($('#glassIncome'),inc); setH($('#glassExpenses'),surv+comf);
  const gs=$('#glassSavings'),lab=$('#saveLabel');
  saveP>=0?(gs.classList.remove('neg-liquid'),lab.classList.remove('neg-text')):
           (gs.classList.add('neg-liquid')   ,lab.classList.add('neg-text'));
  setH(gs,saveP); setH($('#glassInvest'),Math.max(0,invP));
}
function updateBars(){ $('#vHealthFill').style.height=health+'%';
  $('#vHappyFill').style.height=happy+'%';
  $('#vHealthTxt').textContent=health+'%';$('#vHappyTxt').textContent=happy+'%'; }

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –¥–æ—Ö–æ–¥ / —Ä–∞—Å—Ö–æ–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function updateIncomeExpenses(){
  const surv=+$('#survival').value,comf=+$('#comfort').value,
        saveP=+$('#save').value,invP=+$('#invest').value,
        hSp=+$('#healthSpend').value,edu=+$('#edu').value,
        extra=$('#extra').value;
  let inc=1000;if(extra==='–¥–∞')inc+=200;
  const spend=surv+comf+saveP+invP+hSp+edu;
  $('#incomeDisplay').textContent='$'+inc;$('#expensesDisplay').textContent='$'+spend;

  /* –∞–≤—Ç–æ–¥–æ–ª–∏–≤ */
  if($('#autoAdjust').checked){
    const rest=inc-spend;if(rest>0){document.getElementById('saveSlider').noUiSlider.set(saveP+rest);return;}
  }
  updateGlasses(inc,surv,comf,saveP,invP);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function badRules(inc){
  const pct=x=>x/inc*100, surv=+$('#survival').value,comf=+$('#comfort').value,
        sv=+$('#save').value,iv=+$('#invest').value,viol=[];
  activeRules.forEach(r=>{
    if(r.t==='min' && pct(r.jar==='save'?sv:iv)<r.v)viol.push(1);
    if(r.t==='buf' && (surv+comf)>0 && savings/(surv+comf)<r.m)viol.push(1);
    if(r.t==='ratio' && pct(surv+comf)>r.max)viol.push(1);
  });
  return viol.length;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –∏—Å—Ç–æ—Ä–∏—è —Ç–∞–±–ª–∏—Ü—ã & –≥—Ä–∞—Ñ–∏–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function pushHistory(evt,free){
  $('#historyTable').insertAdjacentHTML('beforeend',`<tr>
  <td class=p-2>${turn}</td><td class=p-2>${evt}</td>
  <td class=p-2>$${Math.round(free)}</td><td class=p-2>$${Math.round(savings)}</td>
  <td class=p-2>$${Math.round(invest)}</td><td class=p-2>${health}%</td><td class=p-2>${happy}%</td></tr>`);
}
function updChart(sc){chart.data.labels.push(turn);chart.data.datasets[0].data.push(sc);
  chart.update();$('#scoreBig').textContent=sc;}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ —Å—Ç–∞—Ä—Ç –∏–≥—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function startGame(months){
  maxTurns=months;turn=0;savings=0;invest=0;health=100;happy=90;
  $('#maxTurns').textContent=months;

  const mode=document.querySelector('input[name="mode"]:checked').value;
  if(mode==='role'){
    const role=document.querySelector('input[name="role"]:checked').value,
          p=rolePresets[role];
    activeRules=p.rules;bonusType=p.bonus;
    const inc=1000;
    Object.entries(p.p).forEach(([k,pc])=>{
      document.getElementById(k+(k==='survival'||k==='comfort'?'':'Slider'))
              .noUiSlider.set(Math.round(inc*pc/10)/10);
    });
    if(role==='Saver'&&!localStorage.tut)setTimeout(showTut,250);
  }else{activeRules=[];bonusType='';}

  $('#start-screen').classList.add('hidden');
  $('#game-screen').classList.remove('hidden');
  updateIncomeExpenses();updateBars();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ —Ö–æ–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function runTurn(){
  turn++;
  const surv=+$('#survival').value,comf=+$('#comfort').value,
        saveP=+$('#save').value,invP=+$('#invest').value,
        hSp=+$('#healthSpend').value,edu=+$('#edu').value,extra=$('#extra').value;
  let inc=1000;if(extra==='–¥–∞')inc+=200;
  const spend=surv+comf+saveP+invP+hSp+edu;

  /* —Å–æ–±—ã—Ç–∏–µ */
  let evt='–Ω–∏—á–µ–≥–æ',pen=0,cr=0,r=Math.random();
  if(r<.15){evt='–º–µ–ª–∫–∞—è —Ç—Ä–∞—Ç–∞ ‚Äì$50';pen=-50;}
  else if(r<.25){evt='–∫—Ä–∏–∑–∏—Å -6 % –∏–Ω–≤–µ—Å—Ç';cr=invest*0.06;}
  else if(r<.4){evt='–±–æ–ª–µ–∑–Ω—å -5 –∑–¥–æ—Ä–æ–≤—å—è';health=Math.max(0,health-5);}

  const free=inc-spend+pen;savings+=saveP+free;
  invest=(invest+invP-cr)*(1+(Math.random()<=.7?Math.random()*0.03:Math.random()*-0.01));

  /* –∑–¥–æ—Ä–æ–≤—å–µ-—Å—á–∞—Å—Ç—å–µ */
  if(evt!=='–±–æ–ª–µ–∑–Ω—å -5 –∑–¥–æ—Ä–æ–≤—å—è'&&surv<500)health-=((500-surv)/500)*100;
  health=Math.max(0,Math.min(100,Math.round(health)));
  if(comf<500)happy-=((500-comf)/500)*10;happy=Math.max(0,Math.round(happy));

  /* –ø—Ä–∞–≤–∏–ª–∞ */
  const bad=badRules(inc);
  if(bonusType==='happy'){happy+=bad? -5:+5;happy=Math.max(0,Math.min(100,happy));}

  /* UI */
  $('#turn').textContent=turn;$('#event').textContent=evt;
  $('#free').textContent='$'+Math.round(free);
  $('#savings').textContent='$'+Math.round(savings);
  $('#investments').textContent='$'+Math.round(invest);

  updateIncomeExpenses();updateBars();pushHistory(evt,free);

  /* –±–∞–ª–ª—ã */
  let score=Math.floor(savings/1e3)+Math.floor(invest/1e3)*2;
  if(health>70)score+=20;if(happy>70)score+=20;
  if((invest*0.05+savings*0.03)/12>1000)score+=30;
  updChart(score);

  if(health<=0||happy<=0||turn>=maxTurns){
    alert((health<=0?'–ó–¥–æ—Ä–æ–≤—å–µ 0':'–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞')+'\n–ë–∞–ª–ª—ã: '+score);
    location.reload();
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –±–ª–æ–∫–æ–≤ —Ä–µ–∂–∏–º–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.querySelectorAll('input[name="mode"]').forEach(el=>el.onchange=()=>{
  const m=el.value;$('#roleBlock').classList.toggle('hidden',m!=='role');
  $('#goalBlock').classList.toggle('hidden',m!=='goal');
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ø–µ—Ä–≤—ã–π —Ä–∞—Å—á—ë—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
updateIncomeExpenses();updateBars();
</script>
</body>
</html>
