<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>5 –ö—É–≤—à–∏–Ω–æ–≤</title>

<!-- Tailwind –∏ Chart.js -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- noUiSlider -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.js"></script>

<style>
/* –∫—É–≤—à–∏–Ω—ã-–ø–æ–ª–∑—É–Ω–∫–∏ */
.jar-wrap{width:120px;display:flex;flex-direction:column;align-items:center}
.jar{width:80px;height:160px;border:4px solid #555;border-radius:8px 8px 32px 32px;
     position:relative;background:#fff;overflow:hidden}
.liquid{position:absolute;bottom:0;left:0;width:100%;height:0;
        background:linear-gradient(#4ade80,#16a34a);transition:.25s}
.slider-v{height:160px;margin-top:12px}
input.hidden-field{display:none}
.jar-caption{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
             height:60px;font:600 15px/1.1 sans-serif;text-align:center}

/* –≤–µ—Ä—Ö–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω—ã */
.glass-wrap{width:100px;display:flex;flex-direction:column;align-items:center}
.glass{width:70px;height:140px;border:4px solid #555;border-radius:8px 8px 28px 28px;
       position:relative;background:#fff;overflow:hidden}
.liquid-glass{position:absolute;bottom:0;left:0;width:100%;height:0;transition:.25s}
.neg-liquid{background:#e11d48!important}.neg-text{color:#e11d48!important}

/* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã */
.vbar{width:26px;height:140px;background:#d1d5db;border-radius:13px;position:relative;overflow:hidden}
.vbar-fill{position:absolute;bottom:0;left:0;width:100%;height:0;transition:.25s}
.vbar-text{position:absolute;top:4px;left:0;width:100%;font:700 14px/1 sans-serif;text-align:center;
           pointer-events:none}

/* –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ */
.mini-chart-box{width:100px;height:140px;position:relative;display:flex;
                align-items:center;justify-content:center}
#scoreChart{width:100px!important;height:100px!important}
#scoreBig{position:absolute;top:0;left:0;width:100%;font:700 18px/1 sans-serif;text-align:center;
          pointer-events:none}
</style>
</head>
<body class="bg-gray-100">

<!-- üõà –º–∏–Ω–∏-—Ç—É—Ç–æ—Ä–∏–∞–ª -->
<div id="tutorial" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center">
  <div class="bg-white rounded shadow max-w-md w-11/12 p-6 text-center space-y-4">
    <h3 id="tutTitle" class="text-xl font-bold">–®–∞–≥ 1/3</h3>
    <p id="tutText">‚Ä¶</p>
    <button id="tutNext" class="bg-blue-600 text-white px-4 py-2 rounded">–î–∞–ª—å—à–µ</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ô–ö–ò ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="start-screen" class="min-h-screen flex flex-col items-center justify-center p-6">
  <h1 class="text-4xl font-bold mb-6 text-center">üè∫ 5 –ö—É–≤—à–∏–Ω–æ–≤</h1>
  <div class="bg-white p-6 rounded shadow w-full max-w-sm space-y-4">

    <!-- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
    <p class="font-semibold">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–≥—Ä—ã:</p>
    <div class="flex gap-4">
      <button onclick="startGame(24)" class="flex-1 bg-green-600 text-white py-2 rounded">24 –º–µ—Å</button>
      <button onclick="startGame(36)" class="flex-1 bg-blue-600 text-white py-2 rounded">36 –º–µ—Å</button>
    </div>

    <!-- –†–µ–∂–∏–º -->
    <p class="font-semibold mt-4 mb-1">–ö–∞–∫ –Ω–∞—á–∞—Ç—å?</p>
    <label class="block"><input type="radio" name="mode" value="role" checked> <span class="ml-1">–í—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å</span></label>
    <label class="block"><input type="radio" name="mode" value="goal"> <span class="ml-1">–í—ã–±—Ä–∞—Ç—å —Ü–µ–ª—å</span></label>
    <label class="block"><input type="radio" name="mode" value="free"> <span class="ml-1">–°–≤–æ–±–æ–¥–Ω—ã–π –ø–ª–∞–Ω</span></label>

    <!-- –ë–ª–æ–∫ –†–æ–ª—å -->
    <div id="roleBlock" class="mt-4">
      <p class="font-semibold mb-1">–†–æ–ª—å:</p>
      <label class="mr-4"><input type="radio" name="role" value="Saver" checked> Saver</label>
      <label class="mr-4"><input type="radio" name="role" value="Investor"> Investor</label>
      <label class="mr-4"><input type="radio" name="role" value="Spec"> Speculator</label>
    </div>

    <!-- –ë–ª–æ–∫ –¶–µ–ª—å -->
    <div id="goalBlock" class="mt-4 hidden">
      <label class="font-semibold mb-1">–¶–µ–ª—å:</label>
      <select id="goalSelect" class="w-full border p-2 rounded">
        <option value="buffer">–ü–æ–¥—É—à–∫–∞ 6 –º–µ—Å</option>
        <option value="passive1k">–ü–∞—Å—Å–∏–≤ $1000/–º–µ—Å</option>
        <option value="double">–£–¥–≤–æ–∏—Ç—å –∫–∞–ø–∏—Ç–∞–ª</option>
      </select>
    </div>

    <!-- –ê–≤—Ç–æ–¥–æ–ª–∏–≤ -->
    <label class="flex items-center space-x-2 mt-4">
      <input id="autoAdjust" type="checkbox" class="h-4 w-4 text-blue-600 rounded">
      <span class="text-sm">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –≤ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è</span>
    </label>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="game-screen" class="hidden p-6 space-y-6 max-w-7xl mx-auto">

  <!-- –í–µ—Ä—Ö–Ω–∏–π dashboard -->
  <div class="flex flex-wrap gap-6 mb-8 justify-center">
    <div class="glass-wrap"><div class="glass"><div id="glassIncome"  class="liquid-glass" style="background:#82A8AB"></div></div><p class="mt-1 text-sm font-semibold text-center">–î–æ—Ö–æ–¥—ã</p></div>
    <div class="glass-wrap"><div class="glass"><div id="glassExpenses" class="liquid-glass" style="background:#A77F4B"></div></div><p class="mt-1 text-sm font-semibold text-center">–†–∞—Å—Ö–æ–¥—ã</p></div>
    <div class="glass-wrap"><div class="glass"><div id="glassSavings" class="liquid-glass" style="background:#728565"></div></div><p class="mt-1 text-sm font-semibold text-center">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è</p></div>
    <div class="glass-wrap"><div class="glass"><div id="glassInvest"  class="liquid-glass" style="background:#3B4550"></div></div><p class="mt-1 text-sm font-semibold text-center">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</p></div>
    <div class="glass-wrap"><div class="glass"><div id="glassSpec"   class="liquid-glass" style="background:#BF8200"></div></div><p class="mt-1 text-sm font-semibold text-center">–°–ø–µ–∫—É–ª—è—Ü–∏–∏</p></div>
    <div class="glass-wrap"><div class="vbar"><div id="vHealthFill" class="vbar-fill" style="background:#22c55e"></div><span id="vHealthTxt" class="vbar-text">100%</span></div><p class="mt-1 text-sm font-semibold text-center">–ó–¥–æ—Ä–æ–≤—å–µ</p></div>
    <div class="glass-wrap"><div class="vbar"><div id="vHappyFill"  class="vbar-fill" style="background:#facc15"></div><span id="vHappyTxt" class="vbar-text">90%</span></div><p class="mt-1 text-sm font-semibold text-center">–°—á–∞—Å—Ç—å–µ</p></div>
    <div class="glass-wrap"><div class="mini-chart-box"><canvas id="scoreChart"></canvas><span id="scoreBig">0</span></div><p class="mt-1 text-sm font-semibold text-center">–ë–∞–ª–ª—ã</p></div>
  </div>

  <!-- –î–æ—Ö–æ–¥ / –†–∞—Å—Ö–æ–¥ -->
  <div class="grid grid-cols-2 gap-6">
    <div><label class="block font-semibold mb-1">–î–æ—Ö–æ–¥—ã ($)</label><p id="incomeDisplay" class="border p-2 rounded bg-gray-50">$0</p></div>
    <div><label class="block font-semibold mb-1">–†–∞—Å—Ö–æ–¥—ã ($)</label><p id="expensesDisplay" class="border p-2 rounded bg-gray-50">$0</p></div>
  </div>

  <!-- —à–µ—Å—Ç—å –∫—É–≤—à–∏–Ω–æ–≤-–ø–æ–ª–∑—É–Ω–∫–æ–≤ -->
  <div class="flex flex-wrap gap-6 mb-8">
    <div class="jar-wrap"><div class="jar"><div id="survivalFill" class="liquid"></div></div><div id="survivalSlider" class="slider-v"></div><div class="jar-caption mt-1">–í—ã–∂–∏–≤–∞–Ω–∏–µ<br><span id="survivalVal">500</span> $</div><input id="survival" type="hidden" class="hidden-field" value="500"></div>
    <div class="jar-wrap"><div class="jar"><div id="comfortFill"  class="liquid"></div></div><div id="comfortSlider"  class="slider-v"></div><div class="jar-caption mt-1">–ö–æ–º—Ñ–æ—Ä—Ç<br><span id="comfortVal">500</span> $</div><input id="comfort"  type="hidden" class="hidden-field" value="500"></div>
    <div class="jar-wrap"><div class="jar"><div id="saveFill"     class="liquid"></div></div><div id="saveSlider"     class="slider-v"></div><div class="jar-caption mt-1">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è<br><span id="saveLabel">0</span> $</div><input id="save"     type="hidden" class="hidden-field" value="0"></div>
    <div class="jar-wrap"><div class="jar"><div id="investFill"   class="liquid"></div></div><div id="investSlider"   class="slider-v"></div><div class="jar-caption mt-1">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏<br><span id="investVal">0</span> $</div><input id="invest"   type="hidden" class="hidden-field" value="0"></div>
    <div class="jar-wrap"><div class="jar"><div id="healthFill"   class="liquid"></div></div><div id="healthSlider"   class="slider-v"></div><div class="jar-caption mt-1">–ó–¥–æ—Ä–æ–≤—å–µ<br><span id="healthVal">0</span> $</div><input id="healthSpend" type="hidden" class="hidden-field" value="0"></div>
    <div class="jar-wrap"><div class="jar"><div id="eduFill"      class="liquid"></div></div><div id="eduSlider"      class="slider-v"></div><div class="jar-caption mt-1">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ<br><span id="eduVal">0</span> $</div><input id="edu"       type="hidden" class="hidden-field" value="0"></div>
  </div>

  <!-- –¥–æ–ø —Ä–∞–±–æ—Ç–∞ -->
  <label class="block font-semibold mb-1">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
    <select id="extra" class="w-full border p-2 rounded max-w-xs mt-1">
      <option value="–Ω–µ—Ç">–ù–µ—Ç</option><option value="–¥–∞">–î–∞</option>
    </select>
  </label>

  <!-- —Ö–æ–¥ -->
  <button onclick="runTurn()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ö–æ–¥</button>

  <!-- –º–∏–Ω–∏-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="text-center space-y-2">
    <p>–•–æ–¥: <span id="turn">0</span>/<span id="maxTurns">0</span></p>
    <p>–°–æ–±—ã—Ç–∏–µ: <span id="event">‚Äì</span></p>
    <p>–°–≤–æ–±–æ–¥–Ω—ã–µ –¥–µ–Ω—å–≥–∏: <span id="free">$0</span></p>
    <p>–°–±–µ—Ä–µ–∂–µ–Ω–∏—è: <span id="savings">$0</span></p>
    <p>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: <span id="investments">$0</span></p>
  </div>

  <!-- –∏—Å—Ç–æ—Ä–∏—è -->
  <div class="mt-8">
    <h2 class="text-xl font-bold text-center mb-2">üìò –ò—Å—Ç–æ—Ä–∏—è —Ö–æ–¥–æ–≤</h2>
    <table class="w-full text-sm bg-white rounded shadow overflow-hidden"><thead class="bg-gray-200 font-bold"><tr>
      <th class="p-2">–•–æ–¥</th><th class="p-2">–°–æ–±—ã—Ç–∏–µ</th><th class="p-2">–°–≤–æ–±–æ–¥–Ω—ã–µ $</th>
      <th class="p-2">–°–±–µ—Ä–µ–∂–µ–Ω–∏—è</th><th class="p-2">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</th>
      <th class="p-2">–ó–¥–æ—Ä–æ–≤—å–µ</th><th class="p-2">–°—á–∞—Å—Ç—å–µ</th></tr></thead>
      <tbody id="historyTable" class="text-center"></tbody></table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
/* ----- –ø—Ä–µ—Å–µ—Ç—ã —Ä–æ–ª–µ–π ----- */
const rolePresets={
  Saver:{preset:{survival:40,comfort:20,save:20,invest:10,health:5,edu:5,spec:0},
    rules:[{type:'min',jar:'save',val:10},{type:'max',jar:'spec',val:5},
           {type:'buffer',m:3},{type:'ratio',max:50}],
    bonus:{ok:'happy',fail:'happy-'}},
  Investor:{preset:{survival:40,comfort:20,save:10,invest:20,health:5,edu:5,spec:0},
    rules:[{type:'min',jar:'invest',val:15},{type:'max',jar:'spec',val:10},
           {type:'buffer',m:2},{type:'ratio',max:50}],
    bonus:{ok:'happy',fail:'happy-'}},
  Spec:{preset:{survival:40,comfort:20,save:5,invest:15,health:3,edu:2,spec:15},
    rules:[{type:'min',jar:'save',val:5},{type:'max',jar:'spec',val:30},{type:'ratio',max:50}],
    bonus:{ok:'spec+',fail:'spec-'}}
};

/* ----- —Å–ª–∞–π–¥—ã –º–∏–Ω–∏-—Ç—É—Ç–æ—Ä–∏–∞–ª–∞ ----- */
const tutSlides=[
  {t:'–®–∞–≥ 1/3',p:'–û—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ ‚â• 10 % –¥–æ—Ö–æ–¥–∞ ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è ¬´–ø–æ–¥—É—à–∫–∞¬ª.'},
  {t:'–®–∞–≥ 2/3',p:'–¶–µ–ª—å ‚Äì –ø–æ–¥—É—à–∫–∞ 3‚Äì6 –º–µ—Å—è—á–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤, –∑–∞—Ç–µ–º –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚â• 15 %.'},
  {t:'–®–∞–≥ 3/3',p:'–ë–∞–∑–æ–≤—ã–µ –Ω—É–∂–¥—ã ‚â§ 50 % –¥–æ—Ö–æ–¥–∞ ‚Äî –∏–Ω–∞—á–µ –∂–∏–≤—ë—Ç–µ ¬´–≤ –º–∏–Ω—É—Å¬ª.'}
];

/* ===== –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===== */
let turn=0,maxTurns=0,savings=0,investments=0,health=100,happiness=90;
let activeRules=[],bonusPlan=null,scores=[];
const rnd=()=>Math.random();

/* ===== –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫ ===== */
const chart=new Chart(document.getElementById('scoreChart').getContext('2d'),
 {type:'line',data:{labels:[],datasets:[{data:[],borderColor:'#3b82f6',borderWidth:1,tension:.3,fill:false,pointRadius:0}]},
  options:{responsive:false,animation:false,scales:{x:{display:false},y:{display:false}},
  plugins:{legend:{display:false},tooltip:{enabled:false}}}});

/* ===== noUiSlider –∫—É–≤—à–∏–Ω—ã ===== */
function buildJar(idFill,idSlider,idVal,idInput,max){
  const slider=document.getElementById(idSlider),fill=document.getElementById(idFill),
        val=document.getElementById(idVal),inp=document.getElementById(idInput);
  noUiSlider.create(slider,{start:+inp.value,orientation:'vertical',direction:'rtl',
    step:10,connect:[true,false],range:{min:0,max}});
  slider.noUiSlider.on('update',v=>{
    const n=Math.round(v[0]);fill.style.height=n/max*100+'%';val.textContent=n;inp.value=n;updateIncome();
  });
}
document.addEventListener('DOMContentLoaded',()=>{
  buildJar('survivalFill','survivalSlider','survivalVal','survival',2000);
  buildJar('comfortFill' ,'comfortSlider' ,'comfortVal' ,'comfort' ,2000);
  buildJar('saveFill'    ,'saveSlider'    ,'saveLabel'  ,'save'    ,2000);
  buildJar('investFill'  ,'investSlider'  ,'investVal'  ,'invest'  ,2000);
  buildJar('healthFill'  ,'healthSlider'  ,'healthVal'  ,'healthSpend',2000);
  buildJar('eduFill'     ,'eduSlider'     ,'eduVal'     ,'edu',2000);
  updateIncome();updateBars();
});

/* ===== –≤–µ—Ä—Ö–Ω–∏–µ —Å—Ç–∞–∫–∞–Ω—ã ===== */
function glasses(income,sv,cf,svPlan,invPlan){
  const full=Math.max(1,income*2),
        h=id=>v=>document.getElementById(id).style.height=Math.min(Math.abs(v),full)/full*100+'%';
  h('glassIncome')(income);h('glassExpenses')(sv+cf);
  const gS=document.getElementById('glassSavings'),lbl=document.getElementById('saveLabel');
  gS.classList.toggle('neg-liquid',svPlan<0);lbl.classList.toggle('neg-text',svPlan<0);h('glassSavings')(svPlan);
  h('glassInvest')(Math.max(0,invPlan));
}

/* ===== –ø–æ–ª–æ—Å—ã –∑–¥–æ—Ä–æ–≤—å—è/—Å—á–∞—Å—Ç—å—è ===== */
function updateBars(){
  document.getElementById('vHealthFill').style.height=health+'%';
  document.getElementById('vHappyFill' ).style.height=happiness+'%';
  document.getElementById('vHealthTxt').textContent=health+'%';
  document.getElementById('vHappyTxt' ).textContent=happiness+'%';
}

/* ===== –ø–µ—Ä–µ—Å—á—ë—Ç –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ ===== */
function updateIncome(){
  const s=+survival.value,c=+comfort.value,svP=+save.value,invP=+invest.value,
        hSp=+healthSpend.value,ed=+edu.value,extra=extra.value;
  let income=1000; if(extra==='–¥–∞') income+=200;
  const spend=s+c+svP+invP+hSp+ed;
  /* –∞–≤—Ç–æ–¥–æ–ª–∏–≤ */
  if(autoAdjust.checked&&income-spend>0){
    saveSlider.noUiSlider.set(svP+income-spend);return;
  }
  incomeDisplay.textContent='$'+income;expensesDisplay.textContent='$'+spend;
  glasses(income,s,c,svP,invP);
}

/* ===== –ø—Ä–∞–≤–∏–ª–∞ ===== */
function violations(income){
  const pct=x=>100*x/income,
        v={survival:+survival.value,comfort:+comfort.value,save:+save.value,invest:+invest.value,spec:0};
  return activeRules.filter(r=>{
    if(r.type==='min')return pct(v[r.jar])<r.val;
    if(r.type==='max')return pct(v[r.jar])>r.val;
    if(r.type==='ratio')return pct(v.survival+v.comfort)>r.max;
    if(r.type==='buffer')return (v.survival+v.comfort)>0&&savings/(v.survival+v.comfort)<r.m;
  });
}

/* ===== –±–æ–Ω—É—Å—ã/—à—Ç—Ä–∞—Ñ—ã ===== */
function applyBon(vio){
  if(!bonusPlan)return;
  if(vio.length===0&&bonusPlan.ok==='happy')happiness=Math.min(100,happiness+5);
  if(vio.length>0&&bonusPlan.fail==='happy-')happiness=Math.max(0,happiness-5);
}

/* ===== —Ç—É—Ç–æ—Ä–∏–∞–ª ===== */
function showTutorial(){const dlg=tutorial;let i=0;
  const set=()=>{tutTitle.textContent=tutSlides[i].t;tutText.textContent=tutSlides[i].p;
                 tutNext.textContent=i===2?'–ü–æ–Ω—è–ª!':'–î–∞–ª—å—à–µ'};
  dlg.classList.remove('hidden');set();
  tutNext.onclick=()=>{i<2?(i++,set()):(dlg.classList.add('hidden'),localStorage.setItem('tutSavSeen','1'))};
}

/* ===== START GAME ===== */
function startGame(months){
  maxTurns=months;turn=0;savings=0;investments=0;health=100;happiness=90;scores=[];
  const mode=document.querySelector('input[name="mode"]:checked').value;
  if(mode==='role'){
    const role=document.querySelector('input[name="role"]:checked').value,data=rolePresets[role];
    activeRules=data.rules;bonusPlan=data.bonus;
    const conv=p=>Math.round(1000*p/10)/10;
    saveSlider.noUiSlider.set(conv(data.preset.save));
    investSlider.noUiSlider.set(conv(data.preset.invest));
    survivalSlider.noUiSlider.set(conv(data.preset.survival));
    comfortSlider.noUiSlider.set(conv(data.preset.comfort));
    healthSlider.noUiSlider.set(conv(data.preset.health));
    eduSlider.noUiSlider.set(conv(data.preset.edu));
    if(role==='Saver'&&!localStorage.getItem('tutSavSeen'))setTimeout(showTutorial,300);
  }else{activeRules=[];bonusPlan=null}
  start-screen.classList.add('hidden');game-screen.classList.remove('hidden');
  maxTurns.textContent=months;updateIncome();updateBars();
}

/* ===== RUN TURN ===== */
function runTurn(){
  turn++;
  const s=+survival.value,c=+comfort.value,svP=+save.value,invP=+invest.value,
        hSp=+healthSpend.value,ed=+edu.value;
  let income=1000;if(extra.value==='–¥–∞')income+=200;
  const spend=s+c+svP+invP+hSp+ed;

  /* —Å–æ–±—ã—Ç–∏–µ */
  let evt='–Ω–∏—á–µ–≥–æ',pen=-0,cr=0;
  const r=rnd();
  if(r<.15){evt='–º–µ–ª–∫–∞—è —Ç—Ä–∞—Ç–∞ ‚Äì $50';pen=-50;}
  else if(r<.25){evt='–∫—Ä–∏–∑–∏—Å ‚Äì 6 % –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π';cr=investments*.06;}
  else if(r<.40){evt='–±–æ–ª–µ–∑–Ω—å ‚Äì 5 –∑–¥–æ—Ä–æ–≤—å—è';health=Math.max(0,health-5);}

  const free=income-spend+pen;
  savings+=svP+free;
  investments=(investments+invP-cr)*(1+(rnd()<=.7?rnd()*.03:rnd()*-.01));

  /* –∑–¥–æ—Ä–æ–≤—å–µ/—Å—á–∞—Å—Ç—å–µ */
  if(evt!=='–±–æ–ª–µ–∑–Ω—å ‚Äì 5 –∑–¥–æ—Ä–æ–≤—å—è'){
    if(s<500)health-=100*(500-s)/500;else health+=5;
    if(happiness>=90)health+=5;
    health+=(hSp/500)*50;
  }
  health=Math.round(Math.max(0,Math.min(100,health)));
  if(extra.value==='–¥–∞')health=Math.max(0,health-5);
  if(c<500)happiness-=10*(500-c)/500;
  if(extra.value==='–¥–∞')happiness-=5;
  happiness=Math.round(Math.max(0,happiness));

  /* UI */
  turn.textContent=turn;event.textContent=evt;
  free.textContent='$'+Math.round(free);
  savings.textContent='$'+Math.round(savings);
  investments.textContent='$'+Math.round(investments);

  updateIncome();updateBars();
  historyTable.insertAdjacentHTML('beforeend',`<tr>
   <td class="p-2">${turn}</td><td class="p-2">${evt}</td>
   <td class="p-2">$${Math.round(free)}</td><td class="p-2">$${Math.round(savings)}</td>
   <td class="p-2">$${Math.round(investments)}</td><td class="p-2">${health}%</td><td class="p-2">${happiness}%</td></tr>`);

  /* –±–∞–ª–ª—ã */
  let score=Math.floor(savings/1000)+Math.floor(investments/1000)*2;
  if(health>70)score+=20;if(happiness>70)score+=20;
  if((investments*.05+savings*.03)/12>1000)score+=30;
  chart.data.labels.push(turn);chart.data.datasets[0].data.push(score);chart.update();
  scoreBig.textContent=score;scores.push(score);

  /* –ø—Ä–∞–≤–∏–ª–∞ */
  applyBon(violations(income));

  if(health<=0||happiness<=0||turn>=maxTurns){
    alert((health<=0?'–ó–¥–æ—Ä–æ–≤—å–µ 0':'–°—á–∞—Å—Ç—å–µ 0')+'\n–ë–∞–ª–ª—ã: '+score);location.reload();
  }
}

/* ===== –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ ===== */
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.onchange=()=>{roleBlock.classList.toggle('hidden',r.value!=='role');
                  goalBlock.classList.toggle('hidden',r.value!=='goal');};
});
</script>
</body>
</html>

